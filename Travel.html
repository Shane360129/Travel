<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬æ—…éŠåŠ©æ‰‹</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Noto Sans TC & Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F9F7F2;
            color: #333333;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            position: relative;
            user-select: none; /* é˜²æ­¢æ‹–æ›³æ™‚é¸å–æ–‡å­— */
        }
        
        /* é’æµ·æ³¢ (Seigaiha) å‚³çµ±ç´‹æ¨£èƒŒæ™¯ */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #F9F7F2;
            background-image: 
                radial-gradient(circle at 100% 150%, #F9F7F2 24%, #E5E0D8 25%, #E5E0D8 28%, #F9F7F2 29%, #F9F7F2 36%, #E5E0D8 37%, #E5E0D8 40%, transparent 40%, transparent),
                radial-gradient(circle at 0    150%, #F9F7F2 24%, #E5E0D8 25%, #E5E0D8 28%, #F9F7F2 29%, #F9F7F2 36%, #E5E0D8 37%, #E5E0D8 40%, transparent 40%, transparent),
                radial-gradient(circle at 50%  100%, #E5E0D8 10%, #F9F7F2 11%, #F9F7F2 23%, #E5E0D8 24%, #E5E0D8 30%, #F9F7F2 31%, #F9F7F2 43%, #E5E0D8 44%, #E5E0D8 50%, #F9F7F2 51%, #F9F7F2 63%, #E5E0D8 64%, #E5E0D8 71%, transparent 71%, transparent),
                radial-gradient(circle at 100% 50%, #E5E0D8 5%, #F9F7F2 6%, #F9F7F2 15%, #E5E0D8 16%, #E5E0D8 20%, #F9F7F2 21%, #F9F7F2 30%, #E5E0D8 31%, #E5E0D8 35%, #F9F7F2 36%, #F9F7F2 45%, #E5E0D8 46%, #E5E0D8 49%, transparent 50%, transparent),
                radial-gradient(circle at 0    50%, #E5E0D8 5%, #F9F7F2 6%, #F9F7F2 15%, #E5E0D8 16%, #E5E0D8 20%, #F9F7F2 21%, #F9F7F2 30%, #E5E0D8 31%, #E5E0D8 35%, #F9F7F2 36%, #F9F7F2 45%, #E5E0D8 46%, #E5E0D8 49%, transparent 50%, transparent);
            background-size: 64px 32px;
            opacity: 0.15;
            z-index: -2;
            pointer-events: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #root {
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .input-minimal {
            background: transparent;
            border-bottom: 1px solid #D1D1D1;
            padding: 8px 0;
            outline: none;
            transition: border-color 0.3s;
            width: 100%;
            color: #333333;
        }
        .input-minimal:focus { border-color: #3B7058; }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* é é¢åˆ‡æ›å‹•ç•« */
        @keyframes page-enter {
            from { opacity: 0; transform: scale(0.98) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-page-enter {
            animation: page-enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* åˆ—è¡¨é …ç›®ä¾åºé€²å ´ */
        @keyframes list-enter {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-list-item {
            animation: list-enter 0.3s ease-out forwards;
            opacity: 0; /* é è¨­éš±è— */
        }

        .text-gradient-gold {
            background: linear-gradient(135deg, #D4A045, #B08233);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* è²¼åœ–é¢¨æ ¼ CSS */
        .sticker {
            filter: drop-shadow(2px 3px 0px rgba(0,0,0,0.05));
            transition: transform 0.3s ease;
            position: absolute;
            pointer-events: none;
            z-index: 0;
        }
        
        .font-cute { font-family: 'Zen Maru Gothic', sans-serif; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(0deg); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        /* æ‹–æ›³æ™‚çš„æ¸¸æ¨™ */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-bg': '#F9F7F2',
                        'jp-ink': '#333333',
                        'jp-green': '#3B7058',
                        'jp-green-light': '#E8F0EB',
                        'jp-red': '#B54949',
                        'jp-yellow': '#D4A045',
                        'jp-yellow-light': '#FDF6E9',
                        'jp-blue': '#4F7285',
                        'jp-blue-light': '#EFF5F7',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(59, 112, 88, 0.08)',
                        'floating': '0 10px 30px -5px rgba(59, 112, 88, 0.25)',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Custom Hook: LocalStorage ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Custom Hook: Drag to Scroll (è§£æ±ºæ»‘é¼ ç„¡æ³•æ‹–æ›³å•é¡Œ) ---
        const useDraggableScroll = () => {
            const ref = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const [startX, setStartX] = useState(0);
            const [scrollLeft, setScrollLeft] = useState(0);

            const onMouseDown = (e) => {
                if (!ref.current) return;
                setIsDragging(true);
                setStartX(e.pageX - ref.current.offsetLeft);
                setScrollLeft(ref.current.scrollLeft);
            };

            const onMouseLeave = () => setIsDragging(false);
            const onMouseUp = () => setIsDragging(false);

            const onMouseMove = (e) => {
                if (!isDragging || !ref.current) return;
                e.preventDefault();
                const x = e.pageX - ref.current.offsetLeft;
                const walk = (x - startX) * 1.5; // Scroll speed multiplier
                ref.current.scrollLeft = scrollLeft - walk;
            };

            return { ref, isDragging, events: { onMouseDown, onMouseLeave, onMouseUp, onMouseMove } };
        };

        // --- Lucide Icon Helper ---
        const LucideIcon = ({ name, size = 24, color = "currentColor", className }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" 
                    fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                    className={className}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // Icons
        const Calendar = (props) => <LucideIcon name="Calendar" {...props} />;
        const Wallet = (props) => <LucideIcon name="Wallet" {...props} />;
        const Plus = (props) => <LucideIcon name="Plus" {...props} />;
        const Trash2 = (props) => <LucideIcon name="Trash2" {...props} />;
        const Navigation = (props) => <LucideIcon name="Navigation" {...props} />;
        const Edit2 = (props) => <LucideIcon name="Edit2" {...props} />;
        const X = (props) => <LucideIcon name="X" {...props} />;
        const Check = (props) => <LucideIcon name="Check" {...props} />;
        const Calculator = (props) => <LucideIcon name="Calculator" {...props} />;
        const MapPin = (props) => <LucideIcon name="MapPin" {...props} />;
        const User = (props) => <LucideIcon name="User" {...props} />;
        const ChevronRight = (props) => <LucideIcon name="ChevronRight" {...props} />;
        const RefreshCw = (props) => <LucideIcon name="RefreshCw" {...props} />;
        const TrendingUp = (props) => <LucideIcon name="TrendingUp" {...props} />;
        const ArrowRightLeft = (props) => <LucideIcon name="ArrowRightLeft" {...props} />;

        // --- è²¼åœ–å…ƒä»¶ ---
        const Sticker = ({ emoji, size = "text-6xl", className = "", rotate = 0 }) => (
            <div 
                className={`sticker ${size} ${className} opacity-25`} 
                style={{ transform: `rotate(${rotate}deg)` }}
                aria-hidden="true"
            >
                {emoji}
            </div>
        );

        // --- æ—¥æœ¬é¢¨æ™¯åº•åœ–å…ƒä»¶ (SVG) ---
        const JapaneseScenery = () => (
            <div className="fixed bottom-0 left-0 w-full h-48 pointer-events-none z-[-1] opacity-30 select-none overflow-hidden">
                <svg viewBox="0 0 1440 320" className="w-full h-full object-cover">
                    {/* ç´…æ—¥ */}
                    <circle cx="200" cy="100" r="40" fill="#B54949" opacity="0.6" />
                    {/* å¯Œå£«å±± */}
                    <path fill="#4F7285" fillOpacity="0.8" d="M720 160L960 320H480L720 160Z" />
                    <path fill="#FFFFFF" d="M720 160L800 213L760 220L720 200L680 220L640 213L720 160Z" />
                    {/* é å±± */}
                    <path fill="#3B7058" fillOpacity="0.6" d="M0 256L200 160L400 320H0V256Z" />
                    <path fill="#3B7058" fillOpacity="0.6" d="M1440 224L1100 320H1440V224Z" />
                    {/* é³¥å±… */}
                    <path fill="#B54949" d="M1100 280 H1200 V320 H1180 V290 H1120 V320 H1100 V280 Z" />
                    <path fill="#B54949" d="M1090 270 H1210 V280 H1090 Z" />
                    <path fill="#B54949" d="M1080 250 H1220 V260 H1080 Z" />
                </svg>
            </div>
        );

        // --- é è¨­è³‡æ–™ ---
        const defaultItinerary = [
            // D1 1/18 CI0126 13:05 -> 17:30
            { id: 101, day: 1, time: '13:05', title: 'é£›å¾€æˆç”° (CI0126)', location: 'é«˜é›„åœ‹éš›æ©Ÿå ´', note: 'âœˆï¸ é è¨ˆ 17:30 æŠµé”' },
            { id: 102, day: 1, time: '18:30', title: 'å…¥å¢ƒæ‰‹çºŒå®Œæˆ', location: 'æˆç”°æ©Ÿå ´', note: 'ğŸ›‚ æº–å‚™æ­ä¹˜ Skyliner' },
            { id: 103, day: 1, time: '18:40', title: 'Skyliner (é è¨ˆ)', location: 'æˆç”°æ©Ÿå ´ç«™', note: 'ğŸš† å¾€äº¬æˆä¸Šé‡ (ç´„45åˆ†)' },
            { id: 104, day: 1, time: '20:00', title: 'é£¯åº— Check-in', location: 'ä¸Šé‡è‰¾ç¾ç‰¹é£¯åº—', note: 'ğŸ¨ æ”¾ç½®è¡Œæ' },
            { id: 105, day: 1, time: '20:30', title: 'æ™šé¤/å±…é…’å±‹', location: 'ä¸Šé‡å‘¨é‚Š', note: 'ğŸœ æ¨è–¦ï¼šé³¥è²´æ—æˆ–ä¸€è˜­æ‹‰éºµ' },
            
            // D2 1/19
            { id: 201, day: 2, time: '09:00', title: 'æ·ºè‰å¯ºåƒæ‹œ', location: 'æ·ºè‰å¯º', note: 'ğŸš‡ ä¸Šé‡â†’æ·ºè‰ (æ±‚å¾¡æœ±å°/æŠ½ç±¤)' },
            { id: 202, day: 2, time: '13:00', title: 'å¾¡èŒ¶æ°´é›ªå…·è¡—', location: 'å¾¡èŒ¶æ°´', note: 'ğŸšƒ æ¡è³¼æ»‘é›ªè£å‚™' },
            { id: 203, day: 2, time: '16:00', title: 'é€› FREAKâ€™S STORE', location: 'ä¸Šé‡', note: 'ğŸš‡ å›ä¸Šé‡é€›è¡—' },
            
            // D3 1/20
            { id: 301, day: 3, time: '07:18', title: 'å±±å½¢æ–°å¹¹ç·šç™¼è»Š', location: 'ä¸Šé‡ç«™', note: 'ğŸš„ è¨˜å¾—è²·æ—©é¤ä¸Šè»Šåƒï¼ (ç´„09:50åˆ°å±±å½¢)' },
            { id: 302, day: 3, time: '10:20', title: 'å‰å¾€è—ç‹æº«æ³‰', location: 'å±±å½¢ç«™å‰å·´å£«', note: 'ğŸšŒ å·´å£«ç´„40åˆ†é˜' },
            { id: 303, day: 3, time: '12:30', title: 'ä¸‹åˆæ»‘é›ªï¼‹æº«æ³‰', location: 'è—ç‹æ»‘é›ªå ´', note: 'ğŸ¿ ç¬¬ä¸€æ»‘ï¼æ™‚é–“è¶…å……è£•' },
            { id: 304, day: 3, time: '17:00', title: 'æ°‘å®¿ Check-in', location: 'Dosanko Zao no ie', note: 'ğŸ” è”µç‹ã®ã„ãˆ' },

            // D4 1/21
            { id: 401, day: 4, time: '09:00', title: 'å…¨æ—¥æ»‘é›ª', location: 'è—ç‹æ»‘é›ªå ´', note: 'ğŸ¿ Day 4 æ»‘é›ª' },
            { id: 402, day: 4, time: '18:00', title: 'æº«æ³‰è¡—æ•£æ­¥', location: 'è—ç‹æº«æ³‰è¡—', note: 'â™¨ï¸ æ³¡æº«æ³‰ã€åƒæˆå‰æ€æ±—çƒ¤è‚‰' },

            // D5 1/22
            { id: 501, day: 5, time: '09:00', title: 'å…¨æ—¥æ»‘é›ª', location: 'è—ç‹æ»‘é›ªå ´', note: 'ğŸ¿ Day 5 æ»‘é›ª (çœ‹æ¨¹å†°é»ç‡ˆ?)' },
            { id: 502, day: 5, time: '18:00', title: 'æº«æ³‰è¡—æ•£æ­¥', location: 'è—ç‹æº«æ³‰è¡—', note: 'â™¨ï¸ æœ€å¾Œä¸€æ™šäº«å—æº«æ³‰' },

            // D6 1/23
            { id: 601, day: 6, time: '09:00', title: 'æ—©ä¸Šæ»‘é›ª (çŸ­)', location: 'è—ç‹æ»‘é›ªå ´', note: 'ğŸ¿ æ»‘åˆ°ä¸­åˆé€€æˆ¿' },
            { id: 602, day: 6, time: '13:00', title: 'å‡ºç™¼å»ç‹ç‹¸æ‘', location: 'å®®åŸè—ç‹ç‹ç‹¸æ‘', note: 'ğŸš— ç¸½ç›£é–‹è»Š (æ³¨æ„é›ªåœ°é§•é§›)' },
            { id: 603, day: 6, time: '17:00', title: 'è¿”å›å±±å½¢é‚„è»Š', location: 'å±±å½¢ç«™', note: 'ğŸš— é‚„è»Šå¾Œè²·ã€Œç±³æ¾¤ç‰›ä¾¿ç•¶ã€' },
            { id: 604, day: 6, time: '18:05', title: 'æ–°å¹¹ç·šå›æ±äº¬', location: 'å±±å½¢ç«™', note: 'ğŸš„ èˆ’æœç¡å›ä¸Šé‡ (ç´„20:45åˆ°)' },
            { id: 605, day: 6, time: '21:15', title: 'é£¯åº— Check-in', location: 'ä¸Šé‡è‰¾ç¾ç‰¹é£¯åº—', note: 'ğŸ¨ ä¼‘æ¯' },

            // D7 1/24
            { id: 701, day: 7, time: '09:30', title: 'é€€æˆ¿/å‰å¾€è»Šç«™', location: 'ä¸Šé‡è‰¾ç¾ç‰¹é£¯åº—', note: 'ğŸ§³ æº–å‚™å›ç¨‹' },
            { id: 702, day: 7, time: '10:00', title: 'æ­ä¹˜ Skyliner', location: 'äº¬æˆä¸Šé‡ç«™', note: 'ğŸš† å¾€æˆç”° (10:20å‰ä¸€å®šè¦æ­ä¸Š)' },
            { id: 703, day: 7, time: '11:20', title: 'æŠµé”æ©Ÿå ´å ±åˆ°', location: 'æˆç”°æ©Ÿå ´', note: 'âœˆï¸ CI0103 (13:20èµ·é£›)' }
        ];

        const defaultExpenses = [
            { id: 1, title: 'Skyliner ä¾†å›', amount: 5000, payer: 'æˆ‘' },
            { id: 2, title: 'ç¬¬ä¸€å¤©æ™šé¤', amount: 12500, payer: 'ç¸½ç›£' },
            { id: 3, title: 'é›ªå…·ç§Ÿå€Ÿ', amount: 15000, payer: 'æˆ‘' }
        ];
        
        const defaultUsers = ['æˆ‘', 'ç¸½ç›£', 'æ—…ä¼´A'];

        // --- åŒ¯ç‡å¡ç‰‡ ---
        const ExchangeRateCard = () => {
            const [rate, setRate] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [jpyVal, setJpyVal] = useState('');
            const [twdVal, setTwdVal] = useState('');

            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                    .then(res => res.json())
                    .then(data => {
                        const r = data.rates.TWD;
                        setRate(r);
                        setLoading(false);
                        if (jpyVal === '' && twdVal === '') {
                             setJpyVal('1000');
                             setTwdVal((1000 * r).toFixed(0));
                        }
                    })
                    .catch(() => setLoading(false));
            }, []);

            const handleJpyChange = (e) => {
                const val = e.target.value;
                setJpyVal(val);
                if (rate && !isNaN(val)) setTwdVal(val ? (parseFloat(val) * rate).toFixed(0) : '');
            };

            const handleTwdChange = (e) => {
                const val = e.target.value;
                setTwdVal(val);
                if (rate && !isNaN(val)) setJpyVal(val ? (parseFloat(val) / rate).toFixed(0) : '');
            };

            return (
                <div className="bg-gradient-to-br from-jp-yellow to-[#B08233] text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden transition-transform duration-300 hover:scale-[1.01]">
                    <Sticker emoji="ğŸ’´" size="text-8xl" className="opacity-20 -right-4 -bottom-6 rotate-12" />
                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-sm font-bold opacity-90 flex items-center gap-1">åŒ¯ç‡æ›ç®—å™¨</h2>
                                <div className="text-[10px] mt-0.5 opacity-80 font-mono">{loading ? 'æ›´æ–°ä¸­...' : `1 TWD â‰ˆ ${(1/(rate||1)).toFixed(2)} JPY`}</div>
                            </div>
                            <button className={`p-2 bg-white/20 rounded-full ${loading ? 'animate-spin' : ''}`}><RefreshCw size={16} /></button>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">JPY</label>
                                <input type="number" value={jpyVal} onChange={handleJpyChange} className="w-full bg-black/10 border border-white/20 rounded-lg px-3 py-2 text-white outline-none font-mono text-lg font-bold" placeholder="0" />
                            </div>
                            <div className="pt-6"><ArrowRightLeft size={20} className="opacity-80" /></div>
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">TWD</label>
                                <input type="number" value={twdVal} onChange={handleTwdChange} className="w-full bg-black/10 border border-white/20 rounded-lg px-3 py-2 text-white outline-none font-mono text-lg font-bold" placeholder="0" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- åº•éƒ¨å°èˆª ---
        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: <Calendar size={22} />, color: 'text-jp-green', bg: 'bg-jp-green/10' },
                { id: 'map', label: 'åœ°åœ–', icon: <MapPin size={22} />, color: 'text-jp-blue', bg: 'bg-jp-blue/10' },
                { id: 'expenses', label: 'åˆ†å¸³', icon: <Wallet size={22} />, color: 'text-jp-yellow', bg: 'bg-jp-yellow/10' },
            ];

            return (
                <div className="glass fixed bottom-0 left-0 right-0 pb-safe pt-2 px-6 h-[80px] flex justify-between items-start z-50">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex flex-col items-center justify-center w-16 transition-all duration-300 ${activeTab === tab.id ? `${tab.color} -translate-y-2` : 'text-gray-400'}`}
                        >
                            <div className={`p-2 rounded-2xl transition-all ${activeTab === tab.id ? tab.bg : ''}`}>{tab.icon}</div>
                            <span className="text-[10px] mt-1 font-medium">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        // --- è¡Œç¨‹è¡¨ (åŠ å…¥è±å¯Œè²¼åœ–èƒŒæ™¯ + æ‹–æ›³æ²å‹•) ---
        const ItineraryView = ({ items, setItems }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            const [editingItem, setEditingItem] = useState(null);
            const [deleteTargetId, setDeleteTargetId] = useState(null);

            const { ref: dayScrollRef, isDragging: isDayDragging, events: dayScrollEvents } = useDraggableScroll();

            const days = items.length > 0 ? [...new Set(items.map(i => i.day))].sort((a,b)=>a-b) : [1];
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));

            const confirmDelete = (id) => setDeleteTargetId(id);
            const executeDelete = () => { if (deleteTargetId) { setItems(items.filter(i => i.id !== deleteTargetId)); setDeleteTargetId(null); } };
            const handleAdd = () => { if (!newItem.title || !newItem.time) return; setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]); setIsAdding(false); setNewItem({ time: '', title: '', location: '', note: '' }); };
            const startEdit = (item) => setEditingItem({ ...item });
            const saveEdit = () => { if (!editingItem.title || !editingItem.time) return; setItems(items.map(i => i.id === editingItem.id ? editingItem : i)); setEditingItem(null); };
            const openMap = (loc) => { if(!loc) return; window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank'); };

            // --- å‹•æ…‹èƒŒæ™¯ç”Ÿæˆå™¨ ---
            const getBackgroundDecorations = (day) => {
                switch(day) {
                    case 1: // å°ç£ -> æ±äº¬
                        return (
                            <>
                                <div className="absolute top-20 left-0 w-full h-40 opacity-20 pointer-events-none">
                                    <svg width="100%" height="100%">
                                        <path d="M-10,80 Q150,20 380,50" stroke="#3B7058" strokeWidth="2" strokeDasharray="8,8" fill="none"/>
                                    </svg>
                                </div>
                                <Sticker emoji="ğŸ›«" size="text-7xl" className="top-16 left-5 animate-float" rotate={-10} />
                                <Sticker emoji="ğŸ§³" size="text-6xl" className="bottom-40 right-5" rotate={10} />
                                <Sticker emoji="ğŸ—¼" size="text-8xl" className="top-40 right-[-20px] opacity-15" />
                            </>
                        );
                    case 2: // å¸‚å€ (æ·ºè‰ -> å¾¡èŒ¶æ°´)
                        return (
                            <>
                                <div className="absolute top-32 right-10 w-20 h-40 opacity-20 pointer-events-none">
                                    <svg width="100%" height="100%">
                                        <path d="M50,0 Q10,50 50,100" stroke="#B54949" strokeWidth="3" strokeDasharray="5,5" fill="none"/>
                                    </svg>
                                </div>
                                <Sticker emoji="ğŸ®" size="text-7xl" className="top-16 left-10" rotate={5} />
                                <Sticker emoji="ğŸ›ï¸" size="text-6xl" className="bottom-32 right-10" rotate={-10} />
                                <Sticker emoji="ğŸ¿" size="text-5xl" className="top-60 right-5 opacity-30" rotate={15} />
                            </>
                        );
                    case 3: // ä¸Šé‡ -> å±±å½¢ (ç§»å‹•æ—¥)
                        return (
                            <>
                                <Sticker emoji="ğŸš…" size="text-8xl" className="top-20 right-[-10px] animate-pulse" rotate={0} />
                                <Sticker emoji="ğŸ”ï¸" size="text-9xl" className="bottom-40 left-[-20px] opacity-20" />
                                <Sticker emoji="â™¨ï¸" size="text-6xl" className="bottom-28 right-10" rotate={10} />
                            </>
                        );
                    case 4: // æ»‘é›ª Day
                    case 5: // æ»‘é›ª Day
                        return (
                            <>
                                <Sticker emoji="â„ï¸" size="text-5xl" className="top-10 left-10 opacity-30" />
                                <Sticker emoji="â„ï¸" size="text-4xl" className="top-32 right-20 opacity-20" />
                                <Sticker emoji="ğŸ‚" size="text-7xl" className="top-24 right-5 animate-float" rotate={-15} />
                                <Sticker emoji="â›„" size="text-6xl" className="bottom-32 left-5" rotate={5} />
                            </>
                        );
                    case 6: // ç‹ç‹¸æ‘ + å›ç¨‹
                        return (
                            <>
                                <Sticker emoji="ğŸ¦Š" size="text-7xl" className="top-16 left-5 animate-float" rotate={-5} />
                                <Sticker emoji="ğŸ¾" size="text-3xl" className="top-32 left-20 opacity-30" rotate={10} />
                                <Sticker emoji="ğŸ¾" size="text-3xl" className="top-36 left-28 opacity-30" rotate={20} />
                                <Sticker emoji="ğŸš—" size="text-6xl" className="top-52 right-5" rotate={10} />
                                <Sticker emoji="ğŸ±" size="text-5xl" className="bottom-36 left-10" rotate={-10} />
                            </>
                        );
                    case 7: // å›ç¨‹
                        return (
                            <>
                                <Sticker emoji="ğŸ " size="text-7xl" className="bottom-32 left-5" rotate={-5} />
                                <Sticker emoji="ğŸ›«" size="text-6xl" className="top-20 right-10" rotate={-20} />
                                <div className="absolute bottom-40 left-20 w-40 h-20 opacity-20 pointer-events-none">
                                    <svg width="100%" height="100%">
                                        <path d="M0,50 Q50,0 100,20" stroke="#3B7058" strokeWidth="2" strokeDasharray="8,8" fill="none"/>
                                    </svg>
                                </div>
                            </>
                        );
                    default: return null;
                }
            };

            return (
                <div className="p-5 pb-24 h-full overflow-y-auto no-scrollbar relative">
                    {/* èƒŒæ™¯è£é£¾å±¤ */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
                        {getBackgroundDecorations(selectedDay)}
                    </div>

                    <div className="relative z-10">
                        <header className="flex justify-between items-end mb-6">
                            <div>
                                <h1 className="text-2xl font-bold text-jp-ink tracking-wide font-cute">æ¯æ—¥è¡Œç¨‹</h1>
                                <p className="text-xs text-gray-500 mt-1">Day {selectedDay} çš„å†’éšª</p>
                            </div>
                            <button onClick={() => setIsAdding(true)} className="bg-jp-green text-white p-3 rounded-full shadow-floating active:scale-90 transition-transform hover:bg-opacity-90">
                                <Plus size={20} />
                            </button>
                        </header>

                        {/* Day Selector with Drag Support */}
                        <div 
                            ref={dayScrollRef}
                            {...dayScrollEvents}
                            className={`flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2 select-none ${isDayDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                        >
                            {days.map(d => (
                                <button
                                    key={d}
                                    onClick={() => { if(!isDayDragging) setSelectedDay(d) }} // é˜²æ­¢æ‹–æ›³æ™‚è§¸ç™¼é»æ“Š
                                    className={`px-5 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all duration-300 font-cute transform ${
                                        selectedDay === d 
                                        ? 'bg-jp-green text-white shadow-md scale-105' 
                                        : 'bg-white/80 text-gray-400 border border-gray-200 hover:bg-white'
                                    }`}
                                >
                                    Day {d}
                                </button>
                            ))}
                        </div>

                        <div className="space-y-4">
                            {filteredItems.map((item, idx) => (
                                <div 
                                    key={item.id} 
                                    className="relative pl-6 border-l-2 border-gray-200 last:border-0 animate-list-item"
                                    style={{ animationDelay: `${idx * 0.1}s` }} // Stagger animation
                                >
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-jp-bg border-4 border-jp-green"></div>
                                    <div className="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-soft mb-4 active:scale-[0.98] transition-all duration-200 relative group border border-transparent hover:border-jp-green/20 hover:shadow-md">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="text-jp-green font-bold font-mono text-lg">{item.time}</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => startEdit(item)} className="text-gray-300 hover:text-jp-green transition-colors"><Edit2 size={16} /></button>
                                                <button onClick={() => openMap(item.location)} className="text-gray-300 hover:text-jp-blue transition-colors"><Navigation size={16} /></button>
                                                <button onClick={() => confirmDelete(item.id)} className="text-gray-300 hover:text-jp-red transition-colors"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-jp-ink text-lg font-cute">{item.title}</h3>
                                        {item.location && <div className="flex items-center text-gray-500 text-sm mt-1"><MapPin size={12} className="mr-1 text-jp-blue" />{item.location}</div>}
                                        {item.note && <div className="mt-2 text-xs text-gray-500 bg-jp-bg p-2 rounded-lg border border-gray-100">{item.note}</div>}
                                        
                                        {/* éš¨æ©Ÿå°è²¼åœ–è£é£¾ */}
                                        {item.title.includes('æ»‘é›ª') && <Sticker emoji="ğŸ‚" size="text-xl" className="bottom-2 right-2 opacity-50" />}
                                        {item.title.includes('æº«æ³‰') && <Sticker emoji="â™¨ï¸" size="text-xl" className="bottom-2 right-2 opacity-50" />}
                                        {item.title.includes('é£›') && <Sticker emoji="âœˆï¸" size="text-xl" className="bottom-2 right-2 opacity-50" />}
                                        {item.title.includes('æ–°å¹¹ç·š') && <Sticker emoji="ğŸš„" size="text-xl" className="bottom-2 right-2 opacity-50" />}
                                    </div>
                                </div>
                            ))}
                            {filteredItems.length === 0 && <div className="text-center text-gray-400 py-10 opacity-60 animate-list-item"><div className="mb-2 text-4xl">ğŸµ</div>é€™ä¸€å¤©é‚„æ²’æœ‰è¡Œç¨‹</div>}
                        </div>
                    </div>

                    {/* Modals ... (Simplified for brevity) */}
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center animate-fade-in">
                            <div className="bg-white w-full sm:w-80 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">æ–°å¢è¡Œç¨‹</h3>
                                <div className="space-y-4">
                                    <input type="time" step="600" value={newItem.time} onChange={e => setNewItem({...newItem, time: e.target.value})} className="input-minimal" required />
                                    <input type="text" placeholder="æ¨™é¡Œ" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})} className="input-minimal" />
                                    <input type="text" placeholder="åœ°é»" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} className="input-minimal" />
                                    <input type="text" placeholder="å‚™è¨»" value={newItem.note} onChange={e => setNewItem({...newItem, note: e.target.value})} className="input-minimal" />
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-gray-400 font-medium hover:bg-gray-50 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={handleAdd} className="flex-1 py-3 bg-jp-green text-white rounded-xl shadow-lg font-medium hover:bg-opacity-90 active:scale-95 transition-transform">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {deleteTargetId && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center">
                                <div className="w-12 h-12 bg-jp-red/10 text-jp-red rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 size={24} /></div>
                                <h3 className="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteTargetId(null)} className="flex-1 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium">ä¿ç•™</button>
                                    <button onClick={executeDelete} className="flex-1 py-2.5 bg-jp-red text-white rounded-xl shadow-lg font-medium active:scale-95 transition-transform">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}
                     {editingItem && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center animate-fade-in">
                            <div className="bg-white w-full sm:w-80 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">ç·¨è¼¯è¡Œç¨‹</h3>
                                <div className="space-y-4">
                                    <input type="time" step="600" value={editingItem.time} onChange={e => setEditingItem({...editingItem, time: e.target.value})} className="input-minimal" required />
                                    <input type="text" placeholder="æ¨™é¡Œ" value={editingItem.title} onChange={e => setEditingItem({...editingItem, title: e.target.value})} className="input-minimal" />
                                    <input type="text" placeholder="åœ°é»" value={editingItem.location} onChange={e => setEditingItem({...editingItem, location: e.target.value})} className="input-minimal" />
                                    <input type="text" placeholder="å‚™è¨»" value={editingItem.note} onChange={e => setEditingItem({...editingItem, note: e.target.value})} className="input-minimal" />
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => setEditingItem(null)} className="flex-1 py-3 text-gray-400 font-medium hover:bg-gray-50 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={saveEdit} className="flex-1 py-3 bg-jp-green text-white rounded-xl shadow-lg font-medium hover:bg-opacity-90 active:scale-95 transition-transform">æ›´æ–°</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- å…ƒä»¶ï¼šåˆ†å¸³ & åœ°åœ– (ç¶­æŒåŸæ¨£ï¼Œä½†åŠ å…¥ Drag Scroll) ---
        const ExpenseView = ({ expenses, setExpenses, users, setUsers }) => {
             const [isAdding, setIsAdding] = useState(false);
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [deleteTargetId, setDeleteTargetId] = useState(null);
            const [deleteUserTarget, setDeleteUserTarget] = useState(null);
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            
            const { ref: userScrollRef, isDragging: isUserDragging, events: userScrollEvents } = useDraggableScroll();

            useEffect(() => { if (users.length > 0 && !newExp.payer) { setNewExp(prev => ({ ...prev, payer: users[0] })); } }, [users]);
            const handleAddUser = () => { const name = newUserName.trim(); if (name && !users.includes(name)) { setUsers([...users, name]); setNewUserName(''); setIsAddingUser(false); } };
            const handleDeleteUser = (u) => { if (users.length <= 1) { alert("è‡³å°‘ä¿ç•™ä¸€ä½"); return; } setDeleteUserTarget(u); };
            const executeDeleteUser = () => { if (deleteUserTarget) { setUsers(users.filter(u => u !== deleteUserTarget)); setDeleteUserTarget(null); } };
            
            const debtSummary = useMemo(() => {
                let balances = {}; users.forEach(u => balances[u] = 0); let totalSpent = 0;
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0]; if (!payer) return;
                    const cost = parseFloat(e.amount); totalSpent += cost; balances[payer] += cost;
                    const splitAmount = cost / users.length; users.forEach(u => balances[u] -= splitAmount);
                });
                const debts = [];
                const debtors = users.filter(u => balances[u] < -0.1).sort((a,b)=>balances[a]-balances[b]);
                const creditors = users.filter(u => balances[u] > 0.1).sort((a,b)=>balances[b]-balances[a]);
                let i=0, j=0;
                while(i<debtors.length && j<creditors.length){
                    let debtor=debtors[i], creditor=creditors[j];
                    let amount=Math.min(Math.abs(balances[debtor]), balances[creditor]);
                    if(amount>0) debts.push({from:debtor, to:creditor, amount:Math.round(amount)});
                    balances[debtor]+=amount; balances[creditor]-=amount;
                    if(Math.abs(balances[debtor])<0.1) i++; if(balances[creditor]<0.1) j++;
                }
                return {debts, totalSpent};
            }, [expenses, users]);

            const handleAdd = () => { if(!newExp.title||!newExp.amount)return; setExpenses([...expenses, {...newExp, id:Date.now(), amount:parseFloat(newExp.amount)}]); setIsAdding(false); setNewExp({title:'', amount:'', payer:users[0]||''}); };
            const confirmDelete = (id) => setDeleteTargetId(id);
            const executeDelete = () => { if(deleteTargetId){ setExpenses(expenses.filter(i=>i.id!==deleteTargetId)); setDeleteTargetId(null); } };

            return (
                <div className="p-5 pb-24 h-full overflow-y-auto no-scrollbar relative">
                    <Sticker emoji="ğŸ’¸" className="top-5 right-5 text-6xl opacity-10 rotate-12" />
                    <Sticker emoji="ğŸ’" className="bottom-40 left-5 text-4xl opacity-10 -rotate-12" />
                    
                    <header className="flex justify-between items-center mb-4 relative z-10">
                        <h1 className="text-2xl font-bold text-jp-ink tracking-wide font-cute">æ—…è²»åˆ†å¸³</h1>
                        <button onClick={() => setIsAdding(true)} className="bg-jp-yellow text-white p-3 rounded-full shadow-floating hover:bg-[#B08233] transition-colors active:scale-95"><Plus size={20} /></button>
                    </header>
                    <div className="relative z-10">
                        <ExchangeRateCard />
                        
                        {/* Users with Drag Scroll */}
                        <div className="mb-6">
                            <div className="flex justify-between items-center mb-2"><span className="text-xs text-gray-400 font-bold uppercase tracking-wider">æˆå“¡åå–®</span></div>
                            <div 
                                ref={userScrollRef}
                                {...userScrollEvents}
                                className={`flex flex-wrap gap-2 items-center ${isUserDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
                            >
                                {users.map(u => (
                                    <div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm text-gray-600 border border-gray-200 shadow-sm flex items-center group animate-list-item">
                                        <User size={12} className="mr-1.5 opacity-50"/>{u}
                                        <button onClick={() => !isUserDragging && handleDeleteUser(u)} className="ml-1 text-gray-300 hover:text-jp-red p-0.5 rounded-full hover:bg-red-50 transition-colors"><X size={12} /></button>
                                    </div>
                                ))}
                                {isAddingUser ? (
                                    <div className="flex items-center bg-white px-2 py-1 rounded-full border border-jp-yellow shadow-sm animate-fade-in">
                                        <input type="text" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="bg-transparent outline-none text-sm w-20 text-gray-700" placeholder="åå­—" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddUser()} />
                                        <button onClick={handleAddUser} className="text-jp-yellow ml-1"><Check size={14}/></button>
                                        <button onClick={() => setIsAddingUser(false)} className="text-gray-400 ml-1"><X size={14}/></button>
                                    </div>
                                ) : (
                                    <button onClick={() => !isUserDragging && setIsAddingUser(true)} className="px-3 py-1.5 rounded-full text-sm bg-white border border-dashed border-gray-300 text-gray-500 hover:border-jp-yellow hover:text-jp-yellow transition-all flex items-center"><Plus size={14} className="mr-1"/></button>
                                )}
                            </div>
                        </div>

                        {/* Summary Card */}
                        <div className="bg-jp-ink text-white p-5 rounded-2xl shadow-lg mb-8 relative overflow-hidden transition-transform duration-300 hover:scale-[1.01]">
                            <div className="absolute top-0 right-0 p-4 opacity-5"><Calculator size={100} /></div>
                            <div className="flex justify-between items-end mb-4 relative z-10">
                                <h2 className="text-sm text-gray-400 uppercase tracking-wider">ç¸½æ”¯å‡º</h2>
                                <span className="text-2xl font-bold font-mono text-gradient-gold">Â¥{debtSummary.totalSpent.toLocaleString()}</span>
                            </div>
                            <div className="h-px bg-gray-700 w-full mb-4"></div>
                            <h2 className="text-xs text-jp-yellow mb-3 uppercase tracking-wider font-bold">å»ºè­°é‚„æ¬¾</h2>
                            {debtSummary.debts.length === 0 ? <div className="text-center py-2 text-gray-500 text-sm">ç›®å‰å¸³ç›®å¹³è¡¡ âœ¨</div> : (
                                <div className="space-y-3 relative z-10">
                                    {debtSummary.debts.map((d, idx) => (
                                        <div key={idx} className="flex justify-between items-center border-b border-gray-700/50 pb-2 last:border-0 animate-list-item" style={{ animationDelay: `${idx * 0.1}s` }}>
                                            <div className="flex items-center gap-2">
                                                <span className="bg-gray-700 px-2 py-1 rounded text-xs text-gray-200">{d.from}</span>
                                                <span className="text-[10px] text-gray-500">âœ</span>
                                                <span className="bg-jp-yellow text-jp-ink px-2 py-1 rounded text-xs font-bold">{d.to}</span>
                                            </div>
                                            <span className="font-mono text-lg font-bold">Â¥{d.amount.toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* List */}
                        <h3 className="font-bold text-gray-700 mb-3 flex justify-between items-center">æ”¯å‡ºæ˜ç´°<span className="text-xs font-normal text-gray-400">{expenses.length} ç­†</span></h3>
                        <div className="space-y-3">
                            {expenses.length === 0 ? <div className="text-center text-gray-300 py-6 text-sm">é‚„æ²’æœ‰æ”¯å‡ºç´€éŒ„</div> : 
                                expenses.slice().reverse().map((item, idx) => (
                                    <div key={item.id} className="bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-soft flex justify-between items-center border-l-4 border-jp-yellow animate-list-item" style={{ animationDelay: `${idx * 0.05}s` }}>
                                        <div><div className="font-bold text-gray-800">{item.title}</div><div className="text-xs text-gray-500 mt-1 flex items-center"><User size={10} className="mr-1"/> {item.payer} å…ˆä»˜</div></div>
                                        <div className="flex items-center gap-3"><span className="font-mono font-bold text-lg text-jp-yellow">Â¥{item.amount.toLocaleString()}</span><button onClick={() => confirmDelete(item.id)} className="text-gray-300 hover:text-jp-red transition-colors"><X size={14}/></button></div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                    {/* Expense Modals omitted for brevity */}
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center animate-fade-in">
                            <div className="bg-white w-full sm:w-80 rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-lg font-bold mb-4 text-jp-yellow">æ–°å¢æ”¯å‡º</h3>
                                <div className="space-y-4">
                                    <input type="text" placeholder="é …ç›®" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-minimal focus:border-jp-yellow" />
                                    <input type="number" placeholder="é‡‘é¡" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-minimal focus:border-jp-yellow" />
                                    <div className="text-sm text-gray-500 mb-1">èª°å…ˆä»˜éŒ¢ï¼Ÿ</div>
                                    
                                    {/* ä»˜æ¬¾äººåˆ—è¡¨åŠ å…¥ Drag Scroll */}
                                    <div 
                                        className="flex gap-2 overflow-x-auto no-scrollbar pb-2 cursor-grab active:cursor-grabbing"
                                    >
                                        {users.map(u => (<button key={u} onClick={() => setNewExp({...newExp, payer: u})} className={`flex-none px-4 py-2 rounded-lg text-sm transition-colors whitespace-nowrap ${newExp.payer === u ? 'bg-jp-yellow text-white shadow-md' : 'bg-jp-yellow-light text-gray-600'}`}>{u}</button>))}
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8"><button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-gray-400 font-medium hover:bg-gray-50 rounded-xl">å–æ¶ˆ</button><button onClick={handleAdd} className="flex-1 py-3 bg-jp-yellow text-white rounded-xl shadow-lg font-medium hover:bg-[#B08233]">ç´€éŒ„</button></div>
                            </div>
                        </div>
                    )}
                    {deleteTargetId && <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center"><div className="w-12 h-12 bg-jp-red/10 text-jp-red rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 size={24} /></div><h3 className="text-lg font-bold text-gray-800 mb-2">åˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ</h3><div className="flex gap-3 mt-6"><button onClick={() => setDeleteTargetId(null)} className="flex-1 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium">ä¿ç•™</button><button onClick={executeDelete} className="flex-1 py-2.5 bg-jp-red text-white rounded-xl shadow-lg font-medium">åˆªé™¤</button></div></div></div>}
                    {deleteUserTarget && <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in"><div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl text-center"><div className="w-12 h-12 bg-jp-red/10 text-jp-red rounded-full flex items-center justify-center mx-auto mb-4"><User size={24} /></div><h3 className="text-lg font-bold text-gray-800 mb-2">ç§»é™¤æˆå“¡ã€Œ{deleteUserTarget}ã€ï¼Ÿ</h3><div className="flex gap-3"><button onClick={() => setDeleteUserTarget(null)} className="flex-1 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium">å–æ¶ˆ</button><button onClick={executeDeleteUser} className="flex-1 py-2.5 bg-jp-red text-white rounded-xl shadow-lg font-medium">ç§»é™¤</button></div></div></div>}
                </div>
            );
        };

        // --- å…ƒä»¶ï¼šåœ°åœ–æ•´åˆ ---
        const MapView = ({ items }) => {
            const locations = items.filter(i => i.location && i.location !== '');
            const openNav = (loc) => { window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(loc)}&travelmode=transit`, '_blank'); };

            return (
                 <div className="p-5 pb-24 h-full overflow-y-auto no-scrollbar bg-jp-blue-light/30 relative">
                    <Sticker emoji="ğŸ—ºï¸" className="top-5 right-5 text-6xl opacity-10 rotate-12" />
                    <Sticker emoji="ğŸ“" className="bottom-40 left-5 text-4xl opacity-10 -rotate-12" />
                    
                    <header className="mb-6 relative z-10">
                         <h1 className="text-2xl font-bold text-jp-ink tracking-wide font-cute">æ™¯é»å°èˆª</h1>
                         <p className="text-xs text-gray-500 mt-1">é»æ“Šå¡ç‰‡ç›´æ¥é–‹å•Ÿ Google Maps</p>
                    </header>

                    <div className="grid grid-cols-1 gap-4 relative z-10">
                        {locations.map((item, idx) => (
                            <div 
                                key={item.id} 
                                onClick={() => openNav(item.location)} 
                                className="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-soft flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer border border-transparent hover:border-jp-blue/30 group animate-list-item"
                                style={{ animationDelay: `${idx * 0.05}s` }}
                            >
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-jp-blue/10 flex items-center justify-center text-jp-blue group-hover:bg-jp-blue group-hover:text-white transition-colors">
                                        <MapPin size={24} />
                                    </div>
                                    <div>
                                        <div className="text-xs text-jp-blue font-bold mb-1">Day {item.day} Â· {item.time}</div>
                                        <h3 className="font-bold text-gray-800">{item.location}</h3>
                                        <p className="text-xs text-gray-400 mt-0.5">{item.title}</p>
                                    </div>
                                </div>
                                <div className="text-gray-300">
                                    <ChevronRight size={20} />
                                </div>
                            </div>
                        ))}
                    </div>
                     {locations.length === 0 && <div className="text-center text-gray-400 mt-20 opacity-60"><div className="mb-2 text-4xl">ğŸ—¾</div>åœ°åœ–ä¸Šé‚„ç©ºç©ºå¦‚ä¹Ÿ</div>}
                 </div>
            );
        };

        // --- ä¸»ç¨‹å¼ App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            
            const [itineraryItems, setItineraryItems] = useStickyState(defaultItinerary, 'jp_trip_itinerary');
            const [expenses, setExpenses] = useStickyState(defaultExpenses, 'jp_trip_expenses');
            const [users, setUsers] = useStickyState(defaultUsers, 'jp_trip_users');

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                    case 'expenses': return <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} />;
                    case 'map': return <MapView items={itineraryItems} />;
                    default: return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                }
            };

            return (
                <div className="h-full w-full max-w-md mx-auto bg-jp-bg shadow-2xl relative overflow-hidden sm:border-x sm:border-gray-200">
                    <JapaneseScenery /> {/* å…¨å±€èƒŒæ™¯ */}
                    <div className="h-full pt-safe">
                        {/* é é¢åˆ‡æ›å®¹å™¨ (åŠ å…¥å‹•ç•«) */}
                        <div key={activeTab} className="h-full animate-page-enter">
                            {renderContent()}
                        </div>
                    </div>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>