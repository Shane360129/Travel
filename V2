<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 Êù±‰∫¨Êù±Âåó„ÉªÈõ™Ë¶ãÊâãÂ∏ñ (Pro UX Ver.)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* üé® 2026 ÂèØÊÑõÊñáÈùíÈÖçËâ≤Áõ§ */
            --bg-color: #FFFCF5;        
            --text-main: #594A42;       
            --text-sub: #8C7B75;        
            
            --accent-pink: #FFB7B2;     
            --accent-green: #AACD6E;    
            --accent-yellow: #FFD966;   
            --accent-blue: #89CFF0;     
            --accent-orange: #FFDAC1;   
            
            --card-bg: rgba(255, 255, 255, 0.85);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            background-image: 
                linear-gradient(var(--bg-color) 95%, transparent 95%),
                linear-gradient(90deg, var(--bg-color) 95%, transparent 95%),
                linear-gradient(#E8E0D5 1px, transparent 1px),
                linear-gradient(90deg, #E8E0D5 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 20px 20px, 20px 20px;
            background-position: 0 0, 0 0, -1px -1px, -1px -1px;
        }

        #root {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(100px + var(--safe-bottom));
            position: relative;
            z-index: 10;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 2px solid #F0E6DD;
            box-shadow: 0 -8px 20px rgba(89, 74, 66, 0.05);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            border-radius: 24px 24px 0 0;
        }

        .sticky-note {
            background-color: #FFFAEE;
            border: 2px dashed var(--accent-yellow);
            padding: 12px 14px;
            margin-top: 10px;
            border-radius: 12px;
            box-shadow: 2px 2px 0px rgba(255, 217, 102, 0.4);
            font-size: 0.9rem;
            color: var(--text-main);
            line-height: 1.6;
            position: relative;
        }
        .sticky-note::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 12px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid #E0E0E0;
            transform: rotate(-2deg);
        }
        
        .sticker {
            position: absolute;
            pointer-events: none;
            z-index: 0;
            opacity: 0.2; 
            filter: saturate(1.2);
            transition: transform 0.3s ease;
        }
        
        .bg-sticker-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .page-enter { animation: pageSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes pageSlideUp { 
            0% { opacity: 0; transform: translateY(30px) scale(0.95); } 
            100% { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .stagger-item { opacity: 0; animation: itemPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes itemPop { 
            from { opacity: 0; transform: scale(0.9) translateY(10px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal { animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .input-cute {
            background: #FFF;
            border: 2px solid #F0E6DD;
            border-radius: 16px;
            padding: 14px 16px;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: var(--text-main);
            font-weight: 700;
            transition: all 0.3s;
            margin-bottom: 12px;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.02);
        }
        .input-cute:focus { 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 0 4px rgba(137, 207, 240, 0.2);
        }

        .card-cute {
            background: var(--card-bg);
            border-radius: 24px;
            border: 2px solid #FFF;
            box-shadow: 4px 4px 10px rgba(89, 74, 66, 0.05), -4px -4px 10px rgba(255,255,255,0.8);
            backdrop-filter: blur(8px);
        }

        .btn-pill {
            border-radius: 99px;
            font-weight: 900;
            letter-spacing: 0.5px;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-pill:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        .btn-pill:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: grayscale(0.5);
        }

        .btn-primary { background: var(--accent-pink); color: white; }
        .btn-secondary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-yellow); color: #7A6000; }
        .btn-danger { background: #FF8A80; color: white; }

        .date-active {
            background-color: var(--accent-green);
            color: white;
            transform: translateY(-4px) rotate(-2deg);
            box-shadow: 3px 3px 0 #88A858;
        }
        .date-active-snow {
            background-color: var(--accent-blue);
            color: white;
            transform: translateY(-4px) rotate(2deg);
            box-shadow: 3px 3px 0 #6BAED6;
        }
        .date-inactive {
            background-color: white;
            color: #C0B0A8;
            border: 2px solid #F0E6DD;
        }

        .pb-safe { padding-bottom: calc(24px + env(safe-area-inset-bottom)); }

        .toast-enter { animation: toastSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes toastSlideUp { from { transform: translate(-50%, 120%); } to { transform: translate(-50%, 0); } }

        /* Loading Spinner */
        .spinner {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDbYkxvrEFMfltDnn_8fxLpPLDLZU3HscQ",
            authDomain: "travel-a01b4.firebaseapp.com",
            projectId: "travel-a01b4",
            storageBucket: "travel-a01b4.firebasestorage.app",
            messagingSenderId: "879602910910",
            appId: "1:879602910910:web:5036f88cc2581c4761c0ef"
        };

        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const TRIP_DOC_ID = "tokyo_trip_2026_shared"; 

        // --- Icons ---
        const Icon = ({ name, size = 20, className, color = "currentColor", strokeWidth = 3 }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- Default Data ---
        const defaultItinerary = [
            { id: 101, day: 1, time: '13:05', title: 'È´òÈõÑËµ∑È£õ ‚úàÔ∏è', location: 'È´òÈõÑÂúãÈöõÊ©üÂ†¥', note: 'CI0126\nÈ†êË®à 17:30 ÊäµÈÅîÊàêÁî∞\nÂá∫ÈóúÂæåË°ù SkylinerÔºÅ' },
            { id: 102, day: 1, time: '19:30', title: 'Check-in üè®', location: 'Êù±‰∫¨ÁßãÂè∂ÂéüÂòâÈôΩ„Éì„É´', note: 'ÊîæË°åÊùéÔºåÈÄôÂπæÂ§©ÁöÑÂÆ∂ÔºÅ' },
            { id: 103, day: 1, time: '20:00', title: 'ÁßãËëâÂéüÊé¢Èö™ üéÆ', location: 'ÁßãËëâÂéü', note: 'Yodobashi È†ÇÊ®ìÈ§êÂª≥ÈñãÂæàÊôö\nRadio Kaikan Â¶ÇÊûúÈÇÑÈñãËëóÂ∞±ÂéªÈÄõ' },
            { id: 104, day: 1, time: '21:00', title: 'È≥•Ë≤¥ÊóèÊôöÈ§ê üç¢', location: 'È≥•Ë≤¥Êóè (ÁßãËëâÂéüÂ∫ó)', note: 'Á¨¨‰∏ÄÈ§êÂ∞±ÊòØË¶ÅÂêÉ‰∏≤ÁáíÔºÅ\nÂùá‰∏ÄÂÉπ‰∏çÁî®ÁÆóÈå¢ÁÆóÂ§™Á¥Ø XD' },
            { id: 201, day: 2, time: '08:00', title: 'Âá∫ÁôºÂ∑ùË∂ä üöÜ', location: 'Ê±†Ë¢ãÁ´ô', note: 'ËΩâ‰πòÊù±Ê≠¶Êù±‰∏äÁ∑ö (Á¥Ñ30ÂàÜ)' },
            { id: 202, day: 2, time: '10:00', title: 'Â∞èÊ±üÊà∂Êï£Á≠ñ üëò', location: 'Â∑ùË∂ä‰∏ÄÁï™Ë°ó', note: 'ÂøÖÂéªÔºöÂÜ∞Â∑ùÁ•ûÁ§æÈá£ÈØõÈ≠öÁ±§\nÂêÉÔºöÁ¥´Èõ∑ËñØÁâá„ÄÅÈ∞ªÈ≠öÈ£Ø' },
            { id: 203, day: 2, time: '17:30', title: 'Êñ∞ÂÆøÂ§úÊôØ üåÉ', location: 'Êñ∞ÂÆø', note: 'ÁúãÂì•ÂêâÊãâ„ÄÅ3D Ë≤ìÂí™' },
            { id: 301, day: 3, time: '09:00', title: 'ÁØâÂú∞Êó©È§ê üç£', location: 'ÁØâÂú∞Â†¥Â§ñÂ∏ÇÂ†¥', note: 'ÁãêÁã∏Â±ãÁâõ‰∏º (Â©ÜÂ©ÜÂæàÂÖáË¶ÅÊ≥®ÊÑè)\nÁéâÂ≠êÁáí‰∏≤' },
            { id: 302, day: 3, time: '11:30', title: 'ÁßãËëâÂéüÂ∞ãÂØ∂ üíé', location: 'Mandarake Complex', note: 'Â∞àÊîª‰∫åÊâãÊ®°Âûã„ÄÅËÄÅÈÅäÊà≤' },
            { id: 303, day: 3, time: '14:30', title: 'Ê∑∫ËçâÈõ∑ÈñÄ üèÆ', location: 'Ê∑∫ËçâÂØ∫', note: 'ÊäΩÂÄãÁ±§ (ËÅΩË™™ÂæàÈùà)\nÂêÉÊ∑∫ËçâÁÇ∏ËÇâÈ§Ö' },
            { id: 401, day: 4, time: '09:30', title: 'ÊòéÊ≤ªÁ•ûÂÆÆ ‚õ©Ô∏è', location: 'ÂéüÂÆøÁ´ô', note: 'Êó©Êô®Ëä¨Â§öÁ≤æÔºåÈÖíÊ°∂ÁâÜÂøÖÊãç' },
            { id: 402, day: 4, time: '11:30', title: 'Ë°®ÂèÉÈÅìÊôÇÂ∞ö ‚òï', location: 'Ë°®ÂèÉÈÅì Hills', note: 'ËóçÁì∂ÂíñÂï°„ÄÅRalph Lauren ÂíñÂï°' },
            { id: 403, day: 4, time: '14:00', title: 'ÊæÄË∞∑ÈÄõË°ó üõçÔ∏è', location: 'SHIBUYA SKY', note: 'Âø†Áä¨ÂÖ´ÂÖ¨„ÄÅParco ‰ªªÂ§©Â†ÇÂïÜÂ∫ó\nÈ†êÁ¥Ñ‰∫Ü 16:00 ÁöÑÂ±ïÊúõÂè∞' },
            { id: 501, day: 5, time: '06:50', title: 'KLOOK ÈõÜÂêà üöå', location: 'Êù±‰∫¨Â∑®Ëõã‰∏∏‰πãÂÖß', note: 'ÂúòÈ´îË°åÁ®ã‰∏çËÉΩÈÅ≤Âà∞ÔºÅ\nËªäÁ®ãÂæàÈï∑ÔºåË®òÂæóË≤∑Èõ∂È£ü‰∏äËªä' },
            { id: 502, day: 5, time: '14:00', title: 'ÈäÄÂ±±Ê∫´Ê≥â ‚ô®Ô∏è', location: 'ÈäÄÂ±±Ê∫´Ê≥â', note: 'Á•ûÈö±Â∞ëÂ•≥Â†¥ÊôØÔºÅ\nËá™Áî±Ê¥ªÂãï 90 ÂàÜÈêòÔºåÊãçÁÖßË¶ÅÂø´' },
            { id: 503, day: 5, time: '18:00', title: 'Ê∫´Ê≥âÈ£ØÂ∫ó üç±', location: 'Â±±ÂΩ¢Á∏£', note: 'ÊúÉÂ∏≠ÊñôÁêÜ + Ê≥°ÊπØ' },
            { id: 602, day: 6, time: '10:00', title: 'ËóèÁéãÊ®πÂÜ∞ ‚ùÑÔ∏è', location: 'ËóèÁéãÁ∫úËªä', note: 'Ë∂ÖÁ¥öÂÜ∑ (-10Â∫¶)ÔºÅÊöñÊöñÂåÖË≤ºÊªø\nÁúãÈõ™ÊÄ™ (Snow Monsters)' },
            { id: 603, day: 6, time: '12:00', title: 'Êä±Êä±ÁãêÁã∏ ü¶ä', location: 'ÂÆÆÂüéËóèÁéãÁãêÁã∏Êùë', note: 'Ê≥®ÊÑèÔºöÊù±Ë•ø‰∏çË¶ÅÊúâÂûÇÂ¢úÁâ©ÔºåÁãêÁã∏ÊúÉÂí¨\nÈñÄÁ•® ¬•1500' },
            { id: 604, day: 6, time: '21:00', title: 'ÂõûÂà∞Êù±‰∫¨ üóº', location: 'Êñ∞ÂÆøÁ´ô', note: 'Á¥ØÁàÜÁöÑ‰∏ÄÂ§©ÔºåÂõûÈ£ØÂ∫óÊ¥óÊ¥óÁù°' },
            { id: 701, day: 7, time: '09:00', title: 'Check-out üß≥', location: 'Êù±‰∫¨ÁßãÂè∂ÂéüÂòâÈôΩ„Éì„É´', note: 'Ë°åÊùéÂØÑÊîæÊ´ÉÂè∞Êàñ‰∏äÈáéÁΩÆÁâ©Ê´É' },
            { id: 702, day: 7, time: '10:00', title: 'ÊúÄÂæåË£úË≤® üç¨', location: 'ÈòøÁæéÊ©´Áî∫', note: '‰∫åÊú®ÁöÑËèìÂ≠êË≤∑‰º¥ÊâãÁ¶Æ\nËó•Â¶ùÂ∫óË£úË≤®' },
            { id: 703, day: 7, time: '13:20', title: 'È£õÊ©üËµ∑È£õ ‚úàÔ∏è', location: 'ÊàêÁî∞Ê©üÂ†¥ T2', note: 'CI0103\nÊèêÊó© 2.5 Â∞èÊôÇÂà∞Ê©üÂ†¥ÔºÅ' }
        ];
        
        const defaultGuides = [
            { id: 1, title: 'Skyliner (ÊàêÁî∞‚ûúÂ∏ÇÂçÄ)', type: 'transport', content: 'üöÑ ËªäÁ®ãÔºöÁ¥Ñ 41 ÂàÜÈêòÁõ¥ÈÅî‰∏äÈáé\nüé´ Á•®ÂÉπÔºö‰æÜÂõûÁ¥Ñ ¬•4,480 (Klook Ë≤∑ËºÉ‰æøÂÆú)\nüí° ÂäÉ‰ΩçÔºöÊÜë QR Code Âà∞ÂîÆÁ•®Ê©üÂäÉ‰ΩçÔºåË®òÂæóÈÅ∏„ÄåÈù†Á™ó„ÄçÁúãÈ¢®ÊôØ„ÄÇ' },
            { id: 2, title: 'ËóèÁéãÊ®πÂÜ∞ÂÖ®ÊîªÁï•', type: 'spot', content: 'üöå ‰∫§ÈÄöÔºöË∑üÂúòÊúÄÊñπ‰æøÔºåËá™Ë°åÂâçÂæÄÈúÄÂæûÂ±±ÂΩ¢Á´ôÊê≠Â∑¥Â£´ (40ÂàÜ)„ÄÇ\nüö† Á∫úËªäÔºöÂ±±È∫ìÁ∑ö + Â±±È†ÇÁ∑ö (‰æÜÂõû ¬•3,500)\n‚ùÑÔ∏è Ë£ùÂÇôÔºöÊ•µÂÜ∑ÔºÅÁôºÁÜ±Ë°£x2„ÄÅÊØõÂ∏Ω(ÈÅÆËÄ≥)„ÄÅÈò≤È¢®ÊâãÂ•ó„ÄÅÈò≤ÊªëÈûã„ÄÇ\nüì∏ ÊãçÊîùÔºöÊúÄ‰Ω≥ÈªûÂú®Â±±È†ÇÁ´ôÂ§ñÁöÑ„ÄåÂú∞ËóèÂ∞ä„Äç„ÄÇ' },
            { id: 3, title: 'ÈäÄÂ±±Ê∫´Ê≥âÊï£Á≠ñ', type: 'spot', content: 'üì∏ ÊãçÁÖßÔºöÂ§©ÈªëÂâç 30 ÂàÜÈêòÊúÄÁæé (ËóçË™øÊôÇÂàª)„ÄÇ\nüë£ Ë∂≥ÊπØÔºöÂÖ•Âè£ËôïÊúâÂÖçË≤ªË∂≥ÊπØÔºåÂèØÂ∏∂Â∞èÊØõÂ∑æ„ÄÇ\n‚ö†Ô∏è Á¶ÆÂÑÄÔºö‰∏çË¶ÅÂ∞çËëóÊóÖÈ§®ÊàøÈñìÂÖßÊãçÁÖß„ÄÇ' },
            { id: 4, title: 'ÁãêÁã∏ÊùëÊ≥®ÊÑè‰∫ãÈ†Ö', type: 'spot', content: 'üöï ‰∫§ÈÄöÔºöÂæû„ÄåÁôΩÁü≥ËóèÁéãÁ´ô„ÄçÊê≠Ë®àÁ®ãËªäÁ¥Ñ ¬•4000 (ÂñÆÁ®ã)ÔºåÂõûÁ®ãÂèØË´ãÊ´ÉÊ™ØÂπ´ÂøôÂè´Ëªä„ÄÇ\nü¶ä ‰∫íÂãïÔºö‰∏çË¶ÅÊë∏ÔºÅÈô§ÈùûÊòØ‰ªòË≤ªÊä±Êä±È´îÈ©ó„ÄÇ\n‚ö†Ô∏è Á©øËëóÔºöÈÅøÂÖçÊúâÈ£ÑÂ∏∂ÁöÑË£ôÂ≠êÊàñÊéõÈ£æÔºåÁãêÁã∏ÊúÉ‰ª•ÁÇ∫ÊòØÁé©ÂÖ∑„ÄÇ' },
            { id: 5, title: 'Suica Ë•øÁìúÂç°', type: 'ticket', content: 'üì± iPhoneÔºöÈå¢ÂåÖ App Áõ¥Êé•Êåâ + Êñ∞Â¢û SuicaÔºåÁî® Apple Pay ÂÑ≤ÂÄº„ÄÇ\nüõí ‰ΩøÁî®ÔºöË∂ÖÂïÜ„ÄÅË≤©Ë≥£Ê©ü„ÄÅÂú∞ÈêµÈÄöÁî®„ÄÇ\n‚ö†Ô∏è È§òÈ°çÔºöÈõ¢ÈñãÊó•Êú¨ÂâçÂèØÂéªË∂ÖÂïÜÊääÈ§òÈ°çËä±ÂÆå„ÄÇ' }
        ];
        
        const defaultExpenses = [];
        const defaultUsers = ['Êàë', 'ÊóÖ‰º¥A', 'ÊóÖ‰º¥B'];

        // --- Firebase Hook ---
        const useFirebaseSync = (collectionName, fieldName, defaultValue) => {
            const [data, setData] = useState(() => {
                try {
                    const local = window.localStorage.getItem(`jp_trip_2026_${fieldName}`);
                    return local ? JSON.parse(local) : defaultValue;
                } catch { return defaultValue; }
            });
            const [isSyncing, setIsSyncing] = useState(false);

            useEffect(() => {
                if (!db) return;
                const unsubscribe = db.collection(collectionName).doc(TRIP_DOC_ID)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const remoteData = doc.data()[fieldName];
                            if (remoteData) {
                                setData(remoteData);
                                window.localStorage.setItem(`jp_trip_2026_${fieldName}`, JSON.stringify(remoteData));
                            }
                        } else {
                            db.collection(collectionName).doc(TRIP_DOC_ID).set({ [fieldName]: defaultValue }, { merge: true });
                        }
                    });
                return () => unsubscribe();
            }, [collectionName, fieldName]);

            const updateData = async (newData) => {
                // Optimistic Update
                setData(newData);
                window.localStorage.setItem(`jp_trip_2026_${fieldName}`, JSON.stringify(newData));
                
                if (db) {
                    setIsSyncing(true);
                    try {
                        await db.collection(collectionName).doc(TRIP_DOC_ID).update({ [fieldName]: newData });
                    } catch (e) {
                        console.error("Write Error:", e);
                        // Optional: Revert data on error if needed
                    } finally {
                        setIsSyncing(false);
                    }
                }
            };
            return [data, updateData, isSyncing];
        };

        // --- Shared Components ---
        const Toast = ({ message, visible }) => {
            if (!visible) return null;
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-[var(--text-main)] text-white px-5 py-3 rounded-full shadow-xl z-[150] flex items-center gap-3 text-sm font-bold toast-enter border-2 border-white">
                    <div className="bg-[var(--accent-green)] rounded-full p-1"><Icon name="Check" size={14} className="text-white" /></div>
                    {message}
                </div>
            );
        };

        const BackgroundStickers = () => (
            <div className="bg-sticker-layer">
                <div className="sticker text-6xl" style={{top: '5%', left: '5%', transform: 'rotate(-10deg)'}}>üå∏</div>
                <div className="sticker text-6xl" style={{top: '15%', right: '10%', transform: 'rotate(15deg)'}}>üçò</div>
                <div className="sticker text-8xl" style={{bottom: '25%', right: '-5%', transform: 'rotate(10deg)'}}>üèØ</div>
                <div className="sticker text-6xl" style={{top: '70%', right: '60%', transform: 'rotate(5deg)'}}>‚ùÑÔ∏è</div>
                <div className="sticker text-4xl" style={{top: '2%', right: '40%', opacity: 0.1}}>‚úàÔ∏è</div>
                <div className="sticker text-9xl" style={{top: '40%', left: '30%', opacity: 0.05, filter: 'grayscale(100%)'}}>üóº</div>
            </div>
        );

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Á¢∫ÂÆöÂà™Èô§", confirmColor = "btn-danger", isLoading = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] flex items-center justify-center p-4 animate-modal" onClick={!isLoading ? onCancel : undefined}>
                    <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-black mb-2 text-[var(--text-main)]">{title}</h3>
                        {message && <p className="text-sm text-gray-500 mb-6 leading-relaxed">{message}</p>}
                        <div className="flex gap-3">
                            <button onClick={onCancel} disabled={isLoading} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">ÂèñÊ∂à</button>
                            <button onClick={onConfirm} disabled={isLoading} className={`flex-1 py-3 ${confirmColor} btn-pill font-bold shadow-lg`}>
                                {isLoading ? <div className="spinner"></div> : confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Views ---

        const ItineraryView = ({ items, setItems, showToast, isSyncing }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            
            const daysData = [
                { day: 1, date: '1/18', week: 'ÈÄ±Êó•' }, { day: 2, date: '1/19', week: 'ÈÄ±‰∏Ä' }, { day: 3, date: '1/20', week: 'ÈÄ±‰∫å' },
                { day: 4, date: '1/21', week: 'ÈÄ±‰∏â' }, { day: 5, date: '1/22', week: 'ÈÄ±Âõõ' }, { day: 6, date: '1/23', week: 'ÈÄ±‰∫î' }, { day: 7, date: '1/24', week: 'ÈÄ±ÂÖ≠' },
            ];
            
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSnowDay = selectedDay >= 5 && selectedDay <= 6;

            const confirmDelete = async () => {
                if (deleteTarget) {
                    setIsSaving(true);
                    await setItems(items.filter(i => i.id !== deleteTarget));
                    setIsSaving(false);
                    showToast("Â∑≤Âà™Èô§");
                    setDeleteTarget(null);
                }
            };

            const handleAdd = async () => {
                if (!newItem.title) return;
                setIsSaving(true);
                await setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]);
                setIsSaving(false);
                setIsAdding(false); 
                setNewItem({ time: '', title: '', location: '', note: '' }); 
                showToast("Â∑≤Êñ∞Â¢ûË°åÁ®ã");
            };

            const handleUpdate = async () => {
                if (!editingItem.title) return;
                setIsSaving(true);
                await setItems(items.map(i => i.id === editingItem.id ? editingItem : i));
                setIsSaving(false);
                setEditingItem(null); 
                showToast("Ë°åÁ®ãÂ∑≤Êõ¥Êñ∞");
            };

            return (
                <div className="flex flex-col h-full w-full page-enter">
                    <BackgroundStickers />
                    <div className="scroll-container p-5">
                        <header className="mb-6 mt-2 flex justify-between items-center relative z-20">
                            <div>
                                <div className="text-xs font-bold text-[var(--accent-blue)] uppercase tracking-widest mb-1">Tokyo & Tohoku Trip</div>
                                <h1 className="text-3xl font-black text-[var(--text-main)] tracking-tight flex items-center gap-2">
                                    {isSnowDay ? 'Èõ™Ë¶ãÊâãÂ∏ñ' : 'Êù±‰∫¨Êï£Á≠ñ'}
                                    <span className="text-2xl animate-bounce">{isSnowDay ? '‚ùÑÔ∏è' : 'üóº'}</span>
                                </h1>
                            </div>
                            <button onClick={() => setIsAdding(true)} className="btn-pill btn-primary px-5 py-2.5 flex items-center gap-2 shadow-lg active:scale-95">
                                <Icon name="Plus" size={20} strokeWidth={3} />
                                <span>Êñ∞Â¢û</span>
                            </button>
                        </header>

                        <div className="flex gap-3 mb-8 overflow-x-auto no-scrollbar pb-6 pt-2 snap-x snap-mandatory relative z-20 px-1">
                            {daysData.map(d => (
                                <button key={d.day} onClick={() => setSelectedDay(d.day)} className={`snap-center flex flex-col items-center justify-center min-w-[4.5rem] h-20 rounded-2xl transition-all duration-300 transform border-2 ${selectedDay === d.day ? (d.day >= 5 && d.day <= 6 ? 'date-active-snow border-transparent' : 'date-active border-transparent') : 'date-inactive'}`}>
                                    <span className={`text-[10px] font-bold mb-1 ${selectedDay === d.day ? 'opacity-90' : 'opacity-50'}`}>{d.week}</span>
                                    <span className="text-xl font-black tracking-tight">{d.date}</span>
                                </button>
                            ))}
                        </div>

                        <div className="relative z-10 pb-20 space-y-5">
                            {filteredItems.map((item, idx) => (
                                <div key={item.id} className="card-cute p-5 stagger-item cursor-pointer relative group overflow-hidden" style={{ animationDelay: `${idx * 0.08}s` }} onClick={() => setEditingItem(item)}>
                                    <div className="absolute top-0 left-0 w-2 h-full bg-[var(--accent-green)]"></div>
                                    <div className="flex justify-between items-start mb-2 pl-2">
                                        <span className="font-black font-mono text-xl text-[var(--accent-green)] bg-[#F0F7E6] px-2 py-0.5 rounded-md">{item.time}</span>
                                        <button onClick={(e) => { e.stopPropagation(); setDeleteTarget(item.id); }} className="text-gray-300 hover:text-[var(--accent-pink)] p-1"><Icon name="Trash2" size={18} /></button>
                                    </div>
                                    <h3 className="font-bold text-lg mb-2 pl-2 text-[var(--text-main)]">{item.title}</h3>
                                    <div className="pl-2 space-y-2">
                                        {item.location && (
                                            <div className="flex justify-between items-center bg-[#F7FAFC] p-2 rounded-xl border border-gray-100">
                                                <div className="text-sm font-bold text-gray-500 flex items-center gap-1.5 truncate"><Icon name="MapPin" size={14} className="text-[var(--accent-pink)]" />{item.location}</div>
                                                <button className="btn-pill btn-secondary text-[10px] px-3 py-1 flex items-center gap-1" onClick={(e) => { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}}><Icon name="Navigation2" size={10} />MAP</button>
                                            </div>
                                        )}
                                        {item.note && <div className="sticky-note">{item.note.split('\n').map((line, i) => <div key={i}>{line}</div>)}</div>}
                                    </div>
                                </div>
                            ))}
                            {filteredItems.length === 0 && <div className="text-center py-20 opacity-40"><div className="text-5xl mb-3 grayscale">üí§</div><div className="font-bold text-sm">ÈÄôÂ§©ÈÇÑÊ≤íÊúâË°åÁ®ãÂñî</div></div>}
                        </div>
                    </div>

                    {(isAdding || editingItem) && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-modal" onClick={() => { if(!isSaving) { setIsAdding(false); setEditingItem(null); }}}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[80vh] relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-6 text-[var(--text-main)] flex items-center gap-2">
                                    <span className="bg-[var(--accent-yellow)] w-8 h-8 rounded-full flex items-center justify-center text-white"><Icon name="PenLine" size={18}/></span>
                                    {isAdding ? 'Êñ∞Â¢ûË°åÁ®ã' : 'Á∑®ËºØË°åÁ®ã'}
                                </h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">ÊôÇÈñì</label><input type="time" value={isAdding ? newItem.time : editingItem.time} onChange={e => isAdding ? setNewItem({...newItem, time: e.target.value}) : setEditingItem({...editingItem, time: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">Ê®ôÈ°å</label><input type="text" placeholder="‰æãÔºöÂêÉÊãâÈ∫µ" value={isAdding ? newItem.title : editingItem.title} onChange={e => isAdding ? setNewItem({...newItem, title: e.target.value}) : setEditingItem({...editingItem, title: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">Âú∞Èªû</label><input type="text" placeholder="Google Maps Âú∞Èªû" value={isAdding ? newItem.location : editingItem.location} onChange={e => isAdding ? setNewItem({...newItem, location: e.target.value}) : setEditingItem({...editingItem, location: e.target.value})} className="input-cute" /></div>
                                    <div><label className="text-xs font-bold text-gray-400 ml-1">Á≠ÜË®ò</label><textarea placeholder="ÂÇôË®ª‰∫ãÈ†Ö..." value={isAdding ? newItem.note : editingItem.note} onChange={e => isAdding ? setNewItem({...newItem, note: e.target.value}) : setEditingItem({...editingItem, note: e.target.value})} className="input-cute h-24 resize-none"></textarea></div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={() => { setIsAdding(false); setEditingItem(null); }} disabled={isSaving} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">ÂèñÊ∂à</button>
                                    <button onClick={isAdding ? handleAdd : handleUpdate} disabled={isSaving} className="flex-1 py-3 btn-success btn-pill font-bold shadow-lg">
                                        {isSaving ? <div className="spinner"></div> : (isAdding ? 'Âä†ÂÖ•' : 'Êõ¥Êñ∞')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <ConfirmModal 
                        isOpen={!!deleteTarget} 
                        title="Âà™Èô§Ë°åÁ®ãÔºü" 
                        onConfirm={confirmDelete} 
                        onCancel={() => setDeleteTarget(null)} 
                        isLoading={isSaving}
                    />
                </div>
            );
        };

        const ExpenseView = ({ expenses, setExpenses, users, setUsers, showToast }) => {
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [involvedUsers, setInvolvedUsers] = useState([]); // Êñ∞Â¢ûÔºöÂàÜÂ∏≥ÂèÉËàáËÄÖ
            
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            const [deleteTarget, setDeleteTarget] = useState(null); 
            const [userToDelete, setUserToDelete] = useState(null); 
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => { 
                if (users.length > 0) {
                    if (!newExp.payer) setNewExp(prev => ({ ...prev, payer: users[0] }));
                    // È†êË®≠ÂÖ®ÈÅ∏
                    if (involvedUsers.length === 0) setInvolvedUsers(users);
                } 
            }, [users]);

            const debtSummary = useMemo(() => {
                let balances = {}; users.forEach(u => balances[u] = 0);
                let totalSpent = 0;
                
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0];
                    if (!payer) return;
                    
                    const cost = parseFloat(e.amount); 
                    totalSpent += cost; 
                    balances[payer] += cost; // ‰ªòÊ¨æ‰∫∫ÂÖà +Èå¢
                    
                    // Ê†∏ÂøÉÈÇèËºØ‰øÆÊîπÔºöÂè™Èô§‰ª•ÂèÉËàáËÄÖ
                    const splitTargets = e.involved && e.involved.length > 0 ? e.involved : users; // Âêë‰∏ãÁõ∏ÂÆπ
                    const splitAmount = cost / splitTargets.length;
                    
                    splitTargets.forEach(u => {
                        if (balances[u] !== undefined) balances[u] -= splitAmount; // ÂèÉËàáËÄÖÊâ£Èå¢
                    });
                });
                
                const debts = [];
                const debtors = users.filter(u => balances[u] < -1).sort((a, b) => balances[a] - balances[b]);
                const creditors = users.filter(u => balances[u] > 1).sort((a, b) => balances[b] - balances[a]);
                
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i], creditor = creditors[j];
                    let amount = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                    if (amount > 0) debts.push({ from: debtor, to: creditor, amount: Math.round(amount) });
                    balances[debtor] += amount; balances[creditor] -= amount;
                    if (Math.abs(balances[debtor]) < 1) i++; if (balances[creditor] < 1) j++;
                }
                return { debts, totalSpent };
            }, [expenses, users]);

            const handleAddUser = async () => { 
                if (newUserName.trim() && !users.includes(newUserName.trim())) { 
                    setIsSaving(true);
                    await setUsers([...users, newUserName.trim()]); 
                    setNewUserName(''); 
                    setIsAddingUser(false); 
                    setIsSaving(false);
                    showToast("ÊàêÂì°Â∑≤Êñ∞Â¢û"); 
                } 
            };
            
            const confirmDeleteUser = async () => {
                if (userToDelete) {
                    setIsSaving(true);
                    await setUsers(users.filter(user => user !== userToDelete));
                    setIsSaving(false);
                    showToast("ÊàêÂì°Â∑≤ÁßªÈô§");
                    setUserToDelete(null);
                }
            };

            const toggleInvolved = (user) => {
                if (involvedUsers.includes(user)) {
                    // Èò≤Ê≠¢ÂÖ®ÈÉ®ÂèñÊ∂à
                    if (involvedUsers.length > 1) {
                        setInvolvedUsers(involvedUsers.filter(u => u !== user));
                    }
                } else {
                    setInvolvedUsers([...involvedUsers, user]);
                }
            };

            const handleAddExpense = async () => { 
                if (!newExp.title || !newExp.amount) return; 
                setIsSaving(true);
                await setExpenses([...expenses, { 
                    ...newExp, 
                    id: Date.now(), 
                    amount: parseFloat(newExp.amount),
                    involved: involvedUsers // ÂØ´ÂÖ•ÂèÉËàáËÄÖ
                }]); 
                setNewExp({ title: '', amount: '', payer: users[0] || '' }); 
                // ÈáçÁΩÆÂèÉËàáËÄÖÁÇ∫ÂÖ®Âì°
                setInvolvedUsers(users);
                setIsSaving(false);
                showToast("Ë®òÂ∏≥ÊàêÂäü"); 
            };
            
            const confirmDeleteExpense = async () => {
                if (deleteTarget) {
                    setIsSaving(true);
                    await setExpenses(expenses.filter(e => e.id !== deleteTarget));
                    setIsSaving(false);
                    showToast("Â∑≤Âà™Èô§");
                    setDeleteTarget(null);
                }
            };

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container page-enter">
                    <BackgroundStickers />
                    <h1 className="text-3xl font-black text-[var(--text-main)] mb-6 flex items-center gap-2">ÂàÜÂ∏≥Â∞èÂπ´Êâã <span className="text-2xl">üí∞</span></h1>
                    
                    {/* Users List */}
                    <div className="mb-6 flex flex-wrap gap-2 items-center relative z-20">
                        {users.map(u => (
                            <div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm font-bold text-gray-600 border border-gray-200 shadow-sm flex items-center gap-1">
                                <div className="w-5 h-5 rounded-full bg-[var(--accent-blue)] text-white flex items-center justify-center text-[10px]">{u[0]}</div>
                                {u}
                                <button onClick={() => { 
                                    if(users.length <= 1) return alert("Ëá≥Â∞ë‰øùÁïô‰∏Ä‰ΩçÊàêÂì°");
                                    setUserToDelete(u); 
                                }} className="ml-1 text-gray-300 hover:text-red-400"><Icon name="X" size={12}/></button>
                            </div>
                        ))}
                        {isAddingUser ? (
                            <div className="flex items-center gap-2 animate-fade-in">
                                <input type="text" value={newUserName} onChange={e => setNewUserName(e.target.value)} className="input-cute py-1 px-3 mb-0 w-24 text-sm" placeholder="ÂêçÂ≠ó" autoFocus onKeyDown={e => e.key === 'Enter' && handleAddUser()}/>
                                <button onClick={handleAddUser} disabled={isSaving} className="btn-pill btn-warning px-3 py-1 text-xs shadow-md">{isSaving ? '...' : 'Âä†ÂÖ•'}</button>
                                <button onClick={() => setIsAddingUser(false)} className="bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center"><Icon name="X" size={12}/></button>
                            </div>
                        ) : (
                            <button onClick={() => setIsAddingUser(true)} className="w-8 h-8 rounded-full bg-white border-2 border-dashed border-gray-300 text-gray-400 flex items-center justify-center hover:border-[var(--accent-yellow)] hover:text-[var(--accent-yellow)]"><Icon name="Plus" size={16}/></button>
                        )}
                    </div>

                    {/* Summary */}
                    <div className="card-cute p-6 mb-6 bg-gradient-to-br from-white to-[#FFFCF5]">
                        <div className="flex justify-between items-end mb-4">
                            <h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest">Total Spent</h2>
                            <span className="text-3xl font-black font-mono text-[var(--accent-yellow)]">¬•{debtSummary.totalSpent.toLocaleString()}</span>
                        </div>
                        <div className="border-t-2 border-dashed border-gray-100 my-4"></div>
                        <div className="space-y-3">
                            {debtSummary.debts.length === 0 ? <div className="text-center text-gray-400 text-sm font-bold">ÁõÆÂâçÊ≤íÊúâÊ¨†Ê¨æ ‚ú®</div> : debtSummary.debts.map((d, idx) => (
                                <div key={idx} className="flex justify-between items-center bg-[#F7FAFC] p-3 rounded-xl">
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-gray-600">{d.from}</span>
                                        <Icon name="ArrowRight" size={14} className="text-gray-300"/>
                                        <span className="font-bold text-gray-600">{d.to}</span>
                                    </div>
                                    <span className="font-mono font-bold text-[var(--text-main)]">¬•{d.amount.toLocaleString()}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Add Expense Form (Improved) */}
                    <div className="card-cute p-5 mb-6 relative z-10 border-l-4 border-l-[var(--accent-pink)]">
                        <h3 className="text-sm font-black text-gray-400 mb-3 uppercase tracking-wider">New Expense</h3>
                        <div className="space-y-3">
                            <input type="text" placeholder="È†ÖÁõÆ (‰æã: Â±ÖÈÖíÂ±ã)" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-cute" />
                            <div className="flex gap-2">
                                <input type="number" placeholder="¬• ÈáëÈ°ç" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-cute flex-1" />
                                <div className="relative w-1/3">
                                    <select value={newExp.payer} onChange={e => setNewExp({...newExp, payer: e.target.value})} className="input-cute h-full appearance-none pr-8">
                                        {users.map(u => <option key={u} value={u}>{u} ÂÖà‰ªò</option>)}
                                    </select>
                                    <Icon name="ChevronDown" size={16} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"/>
                                </div>
                            </div>
                            
                            {/* Split Selector */}
                            <div className="bg-[#F7FAFC] p-3 rounded-xl">
                                <div className="text-xs font-bold text-gray-400 mb-2">Ë™∞Ë¶ÅÂàÜÊî§Ôºü(ÈªûÊìäÂàáÊèõ)</div>
                                <div className="flex flex-wrap gap-2">
                                    {users.map(u => {
                                        const isSelected = involvedUsers.includes(u);
                                        return (
                                            <button 
                                                key={u} 
                                                onClick={() => toggleInvolved(u)}
                                                className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border-2 ${isSelected ? 'bg-[var(--accent-blue)] text-white border-[var(--accent-blue)]' : 'bg-white text-gray-400 border-gray-200'}`}
                                            >
                                                {u}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <button onClick={handleAddExpense} disabled={isSaving || !newExp.title || !newExp.amount} className="w-full btn-pill btn-primary py-3 shadow-lg flex justify-center items-center gap-2 mt-2">
                                {isSaving ? <div className="spinner"></div> : <><Icon name="PlusCircle" size={18}/> Ë®ò‰∏ä‰∏ÄÁ≠Ü</>}
                            </button>
                        </div>
                    </div>

                    {/* Expense List */}
                    <div className="space-y-3 pb-24 relative z-10">
                        {expenses.slice().reverse().map((exp, idx) => (
                            <div key={exp.id} className="bg-white/90 p-4 rounded-2xl shadow-sm flex justify-between items-center stagger-item border border-gray-50">
                                <div>
                                    <div className="font-bold text-[var(--text-main)]">{exp.title}</div>
                                    <div className="text-xs text-gray-400 font-bold flex items-center gap-1 mt-1">
                                        <Icon name="User" size={10} /> 
                                        {exp.payer} ‰ªòÊ¨æ 
                                        <Icon name="ArrowRight" size={10} className="ml-1"/> 
                                        {exp.involved && exp.involved.length < users.length ? `${exp.involved.length} ‰∫∫ÂàÜ` : 'ÂÖ®Âì°'}
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="font-mono font-bold text-lg text-[var(--accent-yellow)]">¬•{exp.amount.toLocaleString()}</div>
                                    <button onClick={() => setDeleteTarget(exp.id)} className="text-gray-200 hover:text-[var(--accent-pink)]"><Icon name="Trash2" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Modals */}
                    <ConfirmModal 
                        isOpen={!!deleteTarget} 
                        title="Âà™Èô§Ê¨æÈ†ÖÔºü" 
                        onConfirm={confirmDeleteExpense} 
                        onCancel={() => setDeleteTarget(null)} 
                        isLoading={isSaving}
                    />
                    <ConfirmModal 
                        isOpen={!!userToDelete} 
                        title={`ÁßªÈô§ ${userToDelete}Ôºü`}
                        message="Ê≥®ÊÑèÔºöÈÄô‰∏çÊúÉËá™ÂãïÊ∏ÖÈô§‰ªñÂ∑≤‰ªòÁöÑÊ¨æÈ†ÖÁ¥ÄÈåÑÔºåË´ãÁ¢∫Ë™çÂ∏≥ÂãôÂ∑≤ÁµêÊ∏Ö„ÄÇ"
                        onConfirm={confirmDeleteUser} 
                        onCancel={() => setUserToDelete(null)} 
                        isLoading={isSaving}
                    />
                </div>
            );
        };

        const GuideView = ({ guides, setGuides, showToast }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newGuide, setNewGuide] = useState({ title: '', content: '', type: 'transport' });
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            const typeMap = { 
                transport: { icon: 'TrainFront', color: 'text-blue-500', bg: 'bg-blue-100', label: '‰∫§ÈÄö' }, 
                ticket: { icon: 'Ticket', color: 'text-green-500', bg: 'bg-green-100', label: 'Á•®Âà∏' }, 
                spot: { icon: 'MapPin', color: 'text-red-500', bg: 'bg-red-100', label: 'ÊôØÈªû' }, 
                shopping: { icon: 'ShoppingBag', color: 'text-orange-500', bg: 'bg-orange-100', label: 'Ë≥ºÁâ©' } 
            };

            const handleAdd = async () => { 
                if (!newGuide.title) return; 
                setIsSaving(true);
                await setGuides([...guides, { ...newGuide, id: Date.now() }]); 
                setIsSaving(false);
                setIsAdding(false); 
                setNewGuide({ title: '', content: '', type: 'transport' }); 
                showToast("ÊîªÁï•Â∑≤Êñ∞Â¢û"); 
            };
            
            const confirmDelete = async () => {
                if (deleteTarget) {
                    setIsSaving(true);
                    await setGuides(guides.filter(g => g.id !== deleteTarget));
                    setIsSaving(false);
                    showToast("Â∑≤Âà™Èô§");
                    setDeleteTarget(null);
                }
            };

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container page-enter">
                    <BackgroundStickers />
                    <header className="mb-6 flex justify-between items-center relative z-20">
                         <h1 className="text-3xl font-black text-[var(--text-main)] flex items-center gap-2">ÊóÖË°åÊîªÁï• <span className="text-2xl">üìù</span></h1>
                         <button onClick={() => setIsAdding(true)} className="w-10 h-10 rounded-full bg-[var(--accent-blue)] text-white shadow-lg flex items-center justify-center active:scale-90 transition-transform"><Icon name="Plus" size={20} strokeWidth={3}/></button>
                    </header>
                    <div className="space-y-4 pb-20 relative z-10">
                        {guides.map((g, i) => {
                             const style = typeMap[g.type] || typeMap['transport'];
                             return (
                                <div key={g.id} className="card-cute p-5 stagger-item relative group" style={{animationDelay: `${i*0.05}s`}}>
                                    <div className="flex items-center gap-3 mb-3">
                                        <div className={`w-10 h-10 rounded-full ${style.bg} ${style.color} flex items-center justify-center shrink-0`}><Icon name={style.icon} size={20} /></div>
                                        <h3 className="text-lg font-bold text-[var(--text-main)] leading-tight">{g.title}</h3>
                                        <button onClick={() => setDeleteTarget(g.id)} className="ml-auto text-gray-200 hover:text-red-400"><Icon name="Trash2" size={16} /></button>
                                    </div>
                                    <div className="pl-[52px]">
                                        <ul className="space-y-2">
                                            {g.content.split('\n').map((line, idx) => (
                                                <li key={idx} className="text-sm text-gray-600 leading-relaxed font-medium relative pl-3 before:content-['‚Ä¢'] before:absolute before:left-0 before:text-gray-300">{line}</li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                             );
                        })}
                    </div>
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-modal" onClick={() => { if(!isSaving) setIsAdding(false); }}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative border-4 border-[#F0E6DD]" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-black mb-4 text-[var(--text-main)]">Êñ∞Â¢ûÁ≠ÜË®ò</h3>
                                <div className="space-y-4">
                                    <input type="text" placeholder="Ê®ôÈ°å" value={newGuide.title} onChange={e => setNewGuide({...newGuide, title: e.target.value})} className="input-cute" />
                                    <div className="flex gap-2 mb-2 overflow-x-auto no-scrollbar pb-1">
                                        {Object.entries(typeMap).map(([key, val]) => (<button key={key} onClick={() => setNewGuide({...newGuide, type: key})} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border-2 transition-all flex items-center gap-1 ${newGuide.type === key ? `border-${val.color.split('-')[1]}-400 bg-${val.color.split('-')[1]}-50 text-${val.color.split('-')[1]}-600` : 'border-gray-100 bg-gray-50 text-gray-400'}`}><Icon name={val.icon} size={14} /> {val.label}</button>))}
                                    </div>
                                    <textarea placeholder="ÂÖßÂÆπ" value={newGuide.content} onChange={e => setNewGuide({...newGuide, content: e.target.value})} className="input-cute h-32 resize-none"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setIsAdding(false)} disabled={isSaving} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-2xl btn-pill">ÂèñÊ∂à</button>
                                    <button onClick={handleAdd} disabled={isSaving} className="flex-1 py-3 btn-success btn-pill font-bold shadow-lg">
                                        {isSaving ? <div className="spinner"></div> : 'ÂÑ≤Â≠ò'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <ConfirmModal 
                        isOpen={!!deleteTarget} 
                        title="Âà™Èô§ÊîªÁï•Ôºü" 
                        onConfirm={confirmDelete} 
                        onCancel={() => setDeleteTarget(null)} 
                        isLoading={isSaving}
                    />
                </div>
            );
        }

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'Ë°åÁ®ã', icon: 'Calendar', color: 'text-[var(--accent-green)]' },
                { id: 'guide', label: 'ÊîªÁï•', icon: 'BookOpen', color: 'text-[var(--accent-pink)]' },
                { id: 'expenses', label: 'ÂàÜÂ∏≥', icon: 'Wallet', color: 'text-[var(--accent-yellow)]' },
            ];
            return (
                <div className="tab-bar-glass pb-safe-bottom pt-3 px-6 flex justify-around z-50">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-16 transition-all duration-300 active:scale-90 ${activeTab === tab.id ? '-translate-y-2' : 'opacity-40 hover:opacity-60'}`}>
                            <div className={`p-2.5 rounded-2xl transition-all duration-300 ${activeTab === tab.id ? 'bg-white shadow-md rotate-3' : 'bg-transparent'}`}>
                                <Icon name={tab.icon} size={24} className={activeTab === tab.id ? tab.color : "text-gray-500"} strokeWidth={activeTab === tab.id ? 3 : 2.5} />
                            </div>
                            <span className={`text-[10px] mt-1 font-bold tracking-wide ${activeTab === tab.id ? 'text-[var(--text-main)]' : 'text-gray-400'}`}>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [itineraryItems, setItineraryItems, syncingItinerary] = useFirebaseSync('trips', 'itinerary', defaultItinerary);
            const [expenses, setExpenses, syncingExpenses] = useFirebaseSync('trips', 'expenses', defaultExpenses);
            const [users, setUsers, syncingUsers] = useFirebaseSync('trips', 'users', defaultUsers);
            const [guides, setGuides, syncingGuides] = useFirebaseSync('trips', 'guides', defaultGuides);
            const [toast, setToast] = useState({ msg: '', visible: false });

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast({ msg: '', visible: false }), 2000); };

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} setItems={setItineraryItems} showToast={showToast} isSyncing={syncingItinerary} />;
                    case 'guide': return <GuideView guides={guides} setGuides={setGuides} showToast={showToast} />;
                    case 'expenses': return <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} showToast={showToast} />;
                    default: return <ItineraryView items={itineraryItems} setItems={setItineraryItems} showToast={showToast} />;
                }
            };

            return (
                <div id="app-container">
                    {(syncingItinerary || syncingExpenses) && <div className="fixed top-3 right-3 w-3 h-3 bg-[var(--accent-green)] rounded-full animate-ping z-[200]"></div>}
                    <div key={activeTab} style={{height: '100%', width: '100%', position: 'absolute', top: 0, left: 0}}>
                        {renderContent()}
                    </div>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                    <Toast message={toast.msg} visible={toast.visible} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
