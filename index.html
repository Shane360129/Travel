<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 æ±äº¬æ±åŒ—ãƒ»é›ªè¦‹æ‰‹å¸–</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --jp-bg: #F9F7F2;       /* èƒ¡ç²‰ (èƒŒæ™¯) */
            --jp-text: #333333;     /* å¢¨ (æ–‡å­—) */
            --jp-green: #6A8D73;    /* æŸ³æŸ“ (è¡Œç¨‹) */
            --jp-red: #D67D7D;      /* ç”šä¸‰ç´… (è­¦å‘Š/åˆªé™¤) */
            --jp-yellow: #E8B664;   /* å±±å¹ (é‡‘éŒ¢) */
            --jp-blue: #7CA0B8;     /* å‹¿å¿˜è‰ (åœ°åœ–) */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* å…¨å±€é‡ç½®ï¼Œå¼·åˆ¶æ·ºè‰²æ¨¡å¼ä»¥é¿å…ç™½å­—å•é¡Œ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed; /* é–å®šèƒŒæ™¯é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ */
            overflow: hidden;
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--jp-bg);
            color: var(--jp-text); /* å¼·åˆ¶æ·±è‰²æ–‡å­— */
            -webkit-tap-highlight-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }

        #root {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å…§å®¹æ²å‹•å±¤ - ä½¿ç”¨çµ•å°å®šä½ç¢ºä¿é«˜åº¦è¨ˆç®—æ­£ç¢º */
        .content-scroller {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOS åŸç”Ÿæ…£æ€§æ²å‹• */
            padding-bottom: calc(100px + var(--safe-bottom)); /* é¿é–‹åº•éƒ¨å°èˆª */
            z-index: 10;
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* åº•éƒ¨å°èˆª - ç»ç’ƒæ“¬æ…‹ */
        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .sticky-note {
            background-color: #FFFDF0;
            border-left: 3px solid var(--jp-yellow);
            padding: 10px 14px;
            margin-top: 8px;
            border-radius: 2px 8px 8px 2px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
            font-size: 0.85rem;
            color: #555555; /* ç¢ºä¿å‚™è¨»æ–‡å­—é¡è‰²å¤ æ·± */
            line-height: 1.5;
        }
        
        /* åˆ—è¡¨é€²å ´å‹•ç•« */
        .animate-enter { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ - å¼·åˆ¶æ–‡å­—é¡è‰² */
        .input-light {
            background: transparent;
            border-bottom: 1px solid #D1D5DB;
            padding: 10px 0;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: #333333 !important; /* å¼·åˆ¶æ·±è‰² */
            border-radius: 0; /* ç§»é™¤ iOS åœ“è§’ */
        }
        .input-light::placeholder { color: #9CA3AF; }
        .input-light:focus { border-bottom-color: var(--jp-green); }

        /* åŒ¯ç‡å¡ç‰‡è¼¸å…¥æ¡† */
        .input-white-underline {
            background: rgba(255,255,255,0.1);
            border: none;
            border-bottom: 1px solid rgba(255,255,255,0.4);
            color: white !important;
            padding: 8px;
            width: 100%;
            outline: none;
            text-align: center;
            font-family: monospace;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Safe Icon Component ---
        const Icon = ({ name, size = 20, className, color = "currentColor" }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- LocalStorage Hook ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                } catch (e) { return defaultValue; }
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Data ---
        const defaultItinerary = [
            { id: 101, day: 1, time: '13:05', title: 'é«˜é›„èµ·é£› (CI0126)', location: 'é«˜é›„åœ‹éš›æ©Ÿå ´', note: 'âœˆï¸ é è¨ˆ 17:30 æŠµé”æˆç”°ã€‚æ­ Skyliner é€²å¸‚å€ã€‚' },
            { id: 102, day: 1, time: '19:30', title: 'Check-in', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ¨ ç§‹è‘‰åŸæ ¸å¿ƒå€ï¼Œæ”¾è¡Œæã€‚' },
            { id: 103, day: 1, time: '20:00', title: 'ç§‹è‘‰åŸé›»å™¨è¡—', location: 'ç§‹è‘‰åŸ', note: 'ğŸ’¡ Yodobashi Camera é¤å»³é–‹å¾ˆæ™šã€‚' },
            { id: 104, day: 1, time: '21:00', title: 'æ™šé¤ï¼šé³¥è²´æ—', location: 'é³¥è²´æ— ç§‹è‘‰åŸåº—', note: 'ğŸ¢ å¹³åƒ¹ç‡’é³¥ï¼Œå¹³æ¿é»é¤ã€‚' },
            { id: 105, day: 1, time: '22:30', title: 'å¤œé–“æ•£æ­¥', location: 'æ±å¤§å’Œç”º', note: 'ğŸº æ„Ÿå—æ±äº¬å¤œç”Ÿæ´»ã€‚' },
            // Day 2
            { id: 201, day: 2, time: '08:00', title: 'å‰å¾€å·è¶Š', location: 'æ± è¢‹ç«™', note: 'ğŸš† è½‰ä¹˜æ±æ­¦æ±ä¸Šç·šã€‚' },
            { id: 202, day: 2, time: '10:00', title: 'å·è¶Š (å°æ±Ÿæˆ¶)', location: 'å·è¶Šä¸€ç•ªè¡—', note: 'â›©ï¸ å†°å·ç¥ç¤¾é‡£é­šç±¤ã€æ™‚ä¹‹é˜ã€‚' },
            { id: 203, day: 2, time: '17:30', title: 'æ–°å®¿', location: 'æ–°å®¿', note: 'ğŸ™ï¸ æ­Œèˆä¼ç”ºã€3Dè²“ã€‚' },
            { id: 204, day: 2, time: '18:00', title: 'æ™šé¤ï¼šå±…é…’å±‹', location: 'æ–°å®¿ã®ã‘ã‚€ã‚Š', note: 'ğŸ”¥ ç†±é¬§ä¸²ç‡’åº—ã€‚' },
            // Day 3
            { id: 301, day: 3, time: '09:00', title: 'ç¯‰åœ°å¸‚å ´', location: 'ç¯‰åœ°å ´å¤–', note: 'ğŸ£ ç‹ç‹¸å±‹ç‰›ä¸¼ã€ç‰å­ç‡’ã€‚' },
            { id: 302, day: 3, time: '11:30', title: 'ç§‹è‘‰åŸ', location: 'ç§‹è‘‰åŸ', note: 'ğŸ® ç™½å¤©è£œé€›æ²’å»åˆ°çš„åº—ã€‚' },
            { id: 303, day: 3, time: '14:30', title: 'æ·ºè‰å¯º', location: 'æ·ºè‰é›·é–€', note: 'ğŸ® ç‚¸è‚‰é¤…ã€è è˜¿éºµåŒ…ã€‚' },
            { id: 304, day: 3, time: '17:00', title: 'éŠ€åº§', location: 'éŠ€åº§', note: 'ğŸ›ï¸ Uniqlo æ——è‰¦åº—ã€ä¼Šæ±å±‹ã€‚' },
            // Day 4
            { id: 401, day: 4, time: '09:30', title: 'æ˜æ²»ç¥å®®', location: 'åŸå®¿ç«™', note: 'ğŸŒ² éƒ½å¸‚æ£®æ—æµ´ã€‚' },
            { id: 402, day: 4, time: '11:30', title: 'è¡¨åƒé“', location: 'è¡¨åƒé“', note: 'â˜• Ralph\'s Coffeeã€‚' },
            { id: 403, day: 4, time: '14:00', title: 'æ¾€è°·', location: 'æ¾€è°·', note: 'ğŸ• SHIBUYA SKYã€Parcoã€‚' },
            // Day 5
            { id: 501, day: 5, time: '06:50', title: 'é›†åˆå‡ºç™¼', location: 'æ±äº¬å·¨è›‹ä¸¸ä¹‹å…§ãƒ’ãƒ­', note: 'ğŸšŒ KLOOK åœ˜é«”è¡Œç¨‹ï¼Œè«‹æº–æ™‚ï¼' },
            { id: 502, day: 5, time: '14:00', title: 'éŠ€å±±æº«æ³‰', location: 'éŠ€å±±æº«æ³‰', note: 'â™¨ï¸ å¤§æ­£æµªæ¼«å»ºç¯‰ï¼Œè‡ªç”±æ´»å‹• 90 åˆ†ã€‚' },
            { id: 503, day: 5, time: '16:30', title: 'å‰å¾€é£¯åº—', location: 'å±±å½¢ç¸£', note: 'ğŸ¨ å…¥ä½æº«æ³‰é£¯åº— (è¡Œç¨‹å®‰æ’)ã€‚' },
            { id: 504, day: 5, time: '18:00', title: 'æ™šé¤', location: 'é£¯åº—', note: 'ğŸ± äº«ç”¨æ™šé¤ã€‚' },
            // Day 6
            { id: 601, day: 6, time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'é£¯åº—', note: 'ğŸ³ åƒé£½æº–å‚™å»é›ªåœ°ã€‚' },
            { id: 602, day: 6, time: '10:00', title: 'è—ç‹æ¨¹å†°', location: 'è—ç‹çºœè»Š', note: 'â„ï¸ è‡ªç”±æ´»å‹•2å°æ™‚ï¼Œå±±é ‚æ¥µå†·ï¼' },
            { id: 603, day: 6, time: '12:00', title: 'è—ç‹ç‹ç‹¸æ‘', location: 'å®®åŸè—ç‹ç‹ç‹¸æ‘', note: 'ğŸ¦Š è‡ªç”±æ´»å‹•1å°æ™‚ï¼Œé–€ç¥¨Â¥1500ã€‚' },
            { id: 604, day: 6, time: '13:00', title: 'è¿”ç¨‹æ±äº¬', location: 'å·´å£«', note: 'ğŸšŒ é è¨ˆ 21:00 æŠµé”æ±äº¬ã€‚' },
            { id: 605, day: 6, time: '21:00', title: 'æŠµé”æ±äº¬', location: 'æ±äº¬ç«™/æ–°å®¿', note: 'ğŸ—¼ å›ç§‹è‘‰åŸé£¯åº—ä¼‘æ¯ã€‚' },
            // Day 7
            { id: 701, day: 7, time: '09:00', title: 'Check-out', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ§³ æ•´ç†è¡Œæã€‚' },
            { id: 702, day: 7, time: '10:00', title: 'å‰å¾€æ©Ÿå ´', location: 'äº¬æˆä¸Šé‡ç«™', note: 'ğŸš† æ­ä¹˜ Skylinerã€‚' },
            { id: 703, day: 7, time: '13:20', title: 'æˆç”°èµ·é£› (CI0103)', location: 'æˆç”°æ©Ÿå ´ T2', note: 'âœˆï¸ å¹³å®‰å›å®¶ï¼' }
        ];

        const defaultExpenses = [
            { id: 1, title: 'Skyliner ä¾†å›', amount: 5000, payer: 'æˆ‘' },
            { id: 2, title: 'Day 1 é³¥è²´æ—', amount: 8000, payer: 'æ—…ä¼´A' },
            { id: 3, title: 'ç‹ç‹¸æ‘é–€ç¥¨', amount: 1500, payer: 'æˆ‘' }
        ];
        
        const defaultUsers = ['æˆ‘', 'æ—…ä¼´A', 'æ—…ä¼´B'];

        // --- Exchange Rate Card ---
        const ExchangeRateCard = () => {
            const [rate, setRate] = useState(null);
            const [jpyVal, setJpyVal] = useState('');
            const [twdVal, setTwdVal] = useState('');

            useEffect(() => {
                // æ¨¡æ“¬åŒ¯ç‡ï¼Œé¿å… API å¤±æ•—æ™‚ç©ºç™½
                setRate(0.22);
                fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                    .then(res => res.json())
                    .then(data => setRate(data.rates.TWD))
                    .catch(console.error);
            }, []);

            const handleJpyChange = (e) => {
                const val = e.target.value;
                setJpyVal(val);
                if (rate && !isNaN(val)) setTwdVal(val ? (parseFloat(val) * rate).toFixed(0) : '');
            };

            const handleTwdChange = (e) => {
                const val = e.target.value;
                setTwdVal(val);
                if (rate && !isNaN(val)) setJpyVal(val ? (parseFloat(val) / rate).toFixed(0) : '');
            };

            return (
                <div className="bg-gradient-to-r from-yellow-500 to-orange-400 text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                    <div className="absolute right-0 top-0 opacity-20 transform rotate-12 -mr-4 -mt-4"><Icon name="Coins" size={100} color="white" /></div>
                    <div className="relative z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-sm font-bold opacity-90">åŒ¯ç‡æ›ç®—å™¨</h2>
                            <div className="text-xs opacity-80 font-mono">1 JPY â‰ˆ {rate ? rate.toFixed(3) : '...'} TWD</div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1">
                                <label className="text-xs opacity-80 block mb-1">JPY</label>
                                <input type="number" value={jpyVal} onChange={handleJpyChange} className="input-white-underline" placeholder="0" />
                            </div>
                            <Icon name="ArrowRightLeft" size={20} className="opacity-80" />
                            <div className="flex-1">
                                <label className="text-xs opacity-80 block mb-1">TWD</label>
                                <input type="number" value={twdVal} onChange={handleTwdChange} className="input-white-underline" placeholder="0" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Views ---

        const ItineraryView = ({ items, setItems }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            
            const days = [1, 2, 3, 4, 5, 6, 7];
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSnowDay = selectedDay === 5 || selectedDay === 6;

            const handleDelete = (id) => { if (confirm("åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) setItems(items.filter(i => i.id !== id)); };
            const handleAdd = () => {
                if (!newItem.title) return;
                setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]);
                setIsAdding(false); setNewItem({ time: '', title: '', location: '', note: '' });
            };
            const handleUpdate = () => {
                if (!editingItem.title) return;
                setItems(items.map(i => i.id === editingItem.id ? editingItem : i));
                setEditingItem(null);
            };

            return (
                <div className="content-scroller p-5">
                    <header className="mb-6 mt-2 flex justify-between items-end">
                        <div>
                            <h1 className="text-3xl font-bold tracking-widest text-[#333]">{isSnowDay ? 'æ±åŒ—é›ªè¦‹ â„ï¸' : 'æ±äº¬æ•£ç­– ğŸ—¼'}</h1>
                            <p className="text-sm text-gray-500 mt-1 font-mono">Day {selectedDay}</p>
                        </div>
                        <button onClick={() => setIsAdding(true)} className="bg-[#6A8D73] text-white p-3 rounded-full shadow-lg active:scale-95 transition-transform"><Icon name="Plus" size={24}/></button>
                    </header>

                    {/* Day Selector - ä½¿ç”¨ flex-nowrap èˆ‡ overflow-x-auto ç¢ºä¿å¯æ»‘å‹• */}
                    <div className="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2" style={{scrollSnapType: 'x mandatory'}}>
                        {days.map(d => (
                            <button key={d} onClick={() => setSelectedDay(d)} 
                                className={`flex-none px-5 py-2 rounded-full text-sm font-bold transition-all shadow-sm active:scale-95 scroll-snap-align-center
                                ${selectedDay === d ? (d >= 5 ? 'bg-[#7CA0B8] text-white' : 'bg-[#6A8D73] text-white') : 'bg-white text-gray-500 border border-gray-100'}`}>
                                Day {d}
                            </button>
                        ))}
                    </div>

                    <div className="pb-12">
                        {filteredItems.map((item, idx) => (
                            <div key={item.id} className="relative pl-6 border-l-2 border-gray-200 last:border-0 mb-6 animate-enter" style={{animationDelay: `${idx * 0.05}s`}}>
                                <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 bg-white ${isSnowDay ? 'border-[#7CA0B8]' : 'border-[#6A8D73]'}`}></div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className={`font-bold font-mono text-xl ${isSnowDay ? 'text-[#7CA0B8]' : 'text-[#6A8D73]'}`}>{item.time}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setEditingItem(item)} className="text-gray-300 hover:text-green-600 p-1"><Icon name="Edit2" size={16}/></button>
                                            <button onClick={() => handleDelete(item.id)} className="text-gray-300 hover:text-red-500 p-1"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                    <h3 className="font-bold text-gray-800 text-lg mb-1">{item.title}</h3>
                                    {item.location && <div className="flex items-center text-gray-500 text-sm mb-2" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`)}><Icon name="MapPin" size={14} className="mr-1 text-[#D67D7D]"/>{item.location}</div>}
                                    {item.note && <div className="sticky-note">{item.note}</div>}
                                </div>
                            </div>
                        ))}
                        {filteredItems.length === 0 && <div className="text-center text-gray-400 py-10">å°šç„¡è¡Œç¨‹</div>}
                    </div>

                    {/* Modals */}
                    {(isAdding || editingItem) && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                            <div className="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl pb-10">
                                <h3 className="text-lg font-bold mb-4 text-[#6A8D73]">{isAdding ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹'}</h3>
                                <div className="space-y-4">
                                    <input type="time" step="600" value={isAdding ? newItem.time : editingItem.time} onChange={e => isAdding ? setNewItem({...newItem, time: e.target.value}) : setEditingItem({...editingItem, time: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="æ¨™é¡Œ" value={isAdding ? newItem.title : editingItem.title} onChange={e => isAdding ? setNewItem({...newItem, title: e.target.value}) : setEditingItem({...editingItem, title: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="åœ°é»" value={isAdding ? newItem.location : editingItem.location} onChange={e => isAdding ? setNewItem({...newItem, location: e.target.value}) : setEditingItem({...editingItem, location: e.target.value})} className="input-light" />
                                    <textarea placeholder="å‚™è¨»" value={isAdding ? newItem.note : editingItem.note} onChange={e => isAdding ? setNewItem({...newItem, note: e.target.value}) : setEditingItem({...editingItem, note: e.target.value})} className="input-light h-20 resize-none"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => { setIsAdding(false); setEditingItem(null); }} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={isAdding ? handleAdd : handleUpdate} className="flex-1 py-3 bg-[#6A8D73] text-white font-bold rounded-xl shadow-md">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ExpenseView = ({ expenses, setExpenses, users, setUsers }) => {
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');

            useEffect(() => { if (users.length > 0 && !newExp.payer) setNewExp(prev => ({ ...prev, payer: users[0] })); }, [users]);

            // Debt Logic
            const debtSummary = useMemo(() => {
                let balances = {}; users.forEach(u => balances[u] = 0);
                let totalSpent = 0;
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0];
                    const cost = parseFloat(e.amount);
                    totalSpent += cost; balances[payer] += cost;
                    const split = cost / users.length;
                    users.forEach(u => balances[u] -= split);
                });
                const debts = [];
                const debtors = users.filter(u => balances[u] < -1).sort((a,b) => balances[a] - balances[b]);
                const creditors = users.filter(u => balances[u] > 1).sort((a,b) => balances[b] - balances[a]);
                let i=0, j=0;
                while(i < debtors.length && j < creditors.length){
                    let d = debtors[i], c = creditors[j];
                    let amt = Math.min(Math.abs(balances[d]), balances[c]);
                    if(amt > 0) debts.push({from: d, to: c, amount: Math.round(amt)});
                    balances[d] += amt; balances[c] -= amt;
                    if(Math.abs(balances[d]) < 1) i++; if(balances[c] < 1) j++;
                }
                return { debts, totalSpent };
            }, [expenses, users]);

            const handleAddUser = () => { if(newUserName.trim() && !users.includes(newUserName.trim())) { setUsers([...users, newUserName.trim()]); setNewUserName(''); setIsAddingUser(false); }};
            const handleDeleteUser = (u) => { if(users.length <= 1 || !confirm(`ç§»é™¤ ${u}?`)) return; setUsers(users.filter(user => user !== u)); };
            const handleAddExpense = () => { if(newExp.title && newExp.amount) { setExpenses([...expenses, {...newExp, id: Date.now(), amount: parseFloat(newExp.amount)}]); setNewExp({title:'', amount:'', payer: users[0]||''}); }};
            const handleDeleteExpense = (id) => { if(confirm("åˆªé™¤æ­¤ç­†?")) setExpenses(expenses.filter(e => e.id !== id)); };

            return (
                <div className="content-scroller p-5">
                    <h1 className="text-2xl font-bold text-[#333] mb-6">æ—…è²»æ‰‹å¸³ ğŸ’°</h1>
                    <ExchangeRateCard />

                    <div className="mb-6">
                        <div className="flex justify-between items-center mb-2"><span className="text-xs text-gray-500 font-bold">æˆå“¡åå–®</span></div>
                        <div className="flex flex-wrap gap-2">
                            {users.map(u => (
                                <div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm text-gray-600 border border-gray-200 flex items-center">
                                    <Icon name="User" size={12} className="mr-1"/>{u}
                                    <button onClick={() => handleDeleteUser(u)} className="ml-2 text-gray-300 hover:text-red-500"><Icon name="X" size={12}/></button>
                                </div>
                            ))}
                            {isAddingUser ? (
                                <div className="flex items-center bg-white px-2 py-1 rounded-full border border-orange-300">
                                    <input type="text" value={newUserName} onChange={e => setNewUserName(e.target.value)} className="bg-transparent outline-none text-sm w-20 text-gray-700" placeholder="åå­—" autoFocus />
                                    <button onClick={handleAddUser} className="text-green-500 ml-1"><Icon name="Check" size={14}/></button>
                                    <button onClick={() => setIsAddingUser(false)} className="text-gray-400 ml-1"><Icon name="X" size={14}/></button>
                                </div>
                            ) : <button onClick={() => setIsAddingUser(true)} className="px-3 py-1 rounded-full bg-white border border-dashed border-gray-300 text-gray-500"><Icon name="Plus" size={14}/></button>}
                        </div>
                    </div>

                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                        <div className="flex justify-between items-end mb-4">
                            <span className="text-sm text-gray-500 font-bold">ç¸½æ”¯å‡º</span>
                            <span className="text-2xl font-bold text-[#E8B664] font-mono">Â¥{debtSummary.totalSpent.toLocaleString()}</span>
                        </div>
                        <div className="h-px bg-gray-100 w-full mb-3"></div>
                        <span className="text-xs text-[#E8B664] font-bold">å»ºè­°é‚„æ¬¾</span>
                        {debtSummary.debts.length === 0 ? <div className="text-center text-gray-400 text-xs py-2">å¸³ç›®å¹³è¡¡</div> : 
                            <div className="space-y-2 mt-2">
                                {debtSummary.debts.map((d, i) => (
                                    <div key={i} className="flex justify-between text-sm"><span className="text-gray-600">{d.from}</span><span className="text-gray-400">âœ</span><span className="text-gray-800 font-bold">{d.to} Â¥{d.amount.toLocaleString()}</span></div>
                                ))}
                            </div>
                        }
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                        <h3 className="text-sm font-bold text-gray-500 mb-3">è¨˜å¸³</h3>
                        <div className="space-y-3">
                            <input type="text" placeholder="é …ç›®" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-light" />
                            <div className="flex gap-2">
                                <input type="number" placeholder="é‡‘é¡" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-light flex-1" />
                                <select value={newExp.payer} onChange={e => setNewExp({...newExp, payer: e.target.value})} className="bg-transparent border-b border-gray-300 outline-none text-sm w-24 text-gray-700">
                                    {users.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <button onClick={handleAddExpense} className="w-full bg-[#E8B664] text-white py-3 rounded-xl font-bold mt-2 shadow-sm active:scale-95 transition-transform">æ–°å¢</button>
                        </div>
                    </div>

                    <div className="space-y-3 pb-12">
                        {expenses.slice().reverse().map(e => (
                            <div key={e.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between border-l-4 border-[#E8B664]">
                                <div><div className="font-bold text-gray-800">{e.title}</div><div className="text-xs text-gray-500">{e.payer} å…ˆä»˜</div></div>
                                <div className="flex items-center gap-3"><span className="font-bold text-[#E8B664] font-mono">Â¥{e.amount.toLocaleString()}</span><button onClick={() => handleDeleteExpense(e.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2" size={16}/></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MapView = ({ items }) => (
            <div className="content-scroller p-5">
                <h1 className="text-2xl font-bold text-[#333] mb-6">æ™¯é»åœ°åœ– ğŸ—ºï¸</h1>
                <div className="grid gap-3 pb-12">
                    {items.filter(i => i.location).map(item => (
                        <div key={item.id} onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`)}
                             className="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3 active:scale-95 transition-transform cursor-pointer border border-gray-100">
                            <div className="bg-blue-50 p-2 rounded-full text-[#7CA0B8]"><Icon name="MapPin" size={18}/></div>
                            <div><div className="text-sm font-bold text-gray-700">{item.location}</div><div className="text-xs text-gray-400">Day {item.day}</div></div>
                            <div className="ml-auto text-gray-300"><Icon name="ChevronRight" size={18}/></div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [ { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'Calendar', color: 'text-[#6A8D73]' }, { id: 'map', label: 'åœ°åœ–', icon: 'MapPin', color: 'text-[#7CA0B8]' }, { id: 'expenses', label: 'åˆ†å¸³', icon: 'Wallet', color: 'text-[#E8B664]' }];
            return (
                <div className="tab-bar-glass pb-safe-bottom pt-3 px-8 flex justify-between">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-16 transition-all active:scale-90 ${activeTab === tab.id ? tab.color : 'text-gray-400'}`}>
                            <Icon name={tab.icon} size={24} className={activeTab === tab.id ? "stroke-2" : "stroke-1"} />
                            <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [itineraryItems, setItineraryItems] = useStickyState(defaultItinerary, 'jp_trip_final_v5');
            const [expenses, setExpenses] = useStickyState(defaultExpenses, 'jp_trip_expenses_v5');
            const [users, setUsers] = useStickyState(defaultUsers, 'jp_trip_users_v5');

            return (
                <div className="w-full h-full flex flex-col">
                    <div className="flex-1 relative overflow-hidden">
                        {/* Key å±¬æ€§å¼·åˆ¶é‡æ–°æ¸²æŸ“ï¼Œè§£æ±º iOS åˆ‡æ› tab å¾Œæ²å‹•å¡æ­»çš„å•é¡Œ */}
                        <div key={activeTab} className="absolute inset-0">
                            {activeTab === 'itinerary' && <ItineraryView items={itineraryItems} setItems={setItineraryItems} />}
                            {activeTab === 'expenses' && <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} />}
                            {activeTab === 'map' && <MapView items={itineraryItems} />}
                        </div>
                    </div>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>