<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 æ±äº¬æ±åŒ—ãƒ»é›ªè¦‹æ‰‹å¸–</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --jp-bg: #F9F7F2;       /* èƒ¡ç²‰ */
            --jp-text: #4A4A4A;     /* å¢¨ */
            --jp-green: #6A8D73;    /* æŸ³æŸ“ */
            --jp-red: #D67D7D;      /* ç”šä¸‰ç´… */
            --jp-yellow: #E8B664;   /* å±±å¹ */
            --jp-blue: #7CA0B8;     /* å‹¿å¿˜è‰ */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* iOS Safari æ»¾å‹•ä¿®å¾©æ ¸å¿ƒ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            /* é—œéµï¼šé–å®š Bodyï¼Œé˜²æ­¢æ©¡çš®ç­‹æ•ˆæœèˆ‡æ•´é«”é é¢æ»¾å‹• */
            position: fixed; 
            overflow: hidden;
            
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--jp-bg);
            color: var(--jp-text);
            -webkit-tap-highlight-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }

        #root {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* å…§å®¹æ»¾å‹•å€åŸŸ */
        .scroll-container {
            flex: 1;
            width: 100%;
            overflow-y: scroll; /* å¿…é ˆæ˜¯ scroll æ‰èƒ½è§¸ç™¼ iOS åŸç”Ÿè¡Œç‚º */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch; /* é—œéµï¼šå•Ÿç”¨ iOS æ…£æ€§æ²å‹• */
            padding-bottom: calc(100px + var(--safe-bottom));
            position: relative;
            z-index: 10;
            touch-action: pan-y; /* å‘ŠçŸ¥ç€è¦½å™¨æ­¤å€åŸŸä¸»è¦ç‚ºå‚ç›´æ»‘å‹• */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .sticky-note {
            background-color: #FFFDF0;
            border-left: 3px solid var(--jp-yellow);
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 2px 8px 8px 2px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.03);
            position: relative;
            font-size: 0.85rem;
            color: #666;
            line-height: 1.6;
        }
        
        .particle {
            position: absolute;
            top: -10px;
            pointer-events: none;
            z-index: 0;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0; }
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        .stagger-item { opacity: 0; animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .text-gold { color: #C18A26; }
        
        @keyframes modalUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-modal { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .input-underline {
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-underline:focus { border-bottom-color: white; }
        
        .input-light {
            background: transparent;
            border-bottom: 1px solid #E5E7EB;
            padding: 12px 0;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: var(--jp-text);
            transition: border-color 0.3s;
        }
        .input-light:focus { border-bottom-color: var(--jp-green); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icon ---
        const Icon = ({ name, size = 20, className, color = "currentColor", strokeWidth = 2 }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // --- Hook ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Data ---
        const defaultItinerary = [
            // D1
            { id: 101, day: 1, time: '13:05', title: 'é«˜é›„èµ·é£› (CI0126)', location: 'é«˜é›„åœ‹éš›æ©Ÿå ´', note: 'âœˆï¸ é è¨ˆ 17:30 æŠµé”æˆç”°ã€‚å‡ºé—œå¾Œæ­ Skyliner ç›´å¥”ä¸Šé‡/ç§‹è‘‰åŸã€‚' },
            { id: 102, day: 1, time: '19:30', title: 'Check-in', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ¨ æ”¾è¡Œæã€‚ä½æ–¼ç§‹è‘‰åŸæ ¸å¿ƒå€ã€‚' },
            { id: 103, day: 1, time: '20:00', title: 'ç§‹è‘‰åŸé›»å™¨è¡—', location: 'ç§‹è‘‰åŸ', note: 'ğŸ’¡ 2025 æ¨è–¦ï¼šYodobashi Camera (é¤å»³è¡—é–‹å¾ˆæ™š)ã€Radio Kaikanã€‚' },
            { id: 104, day: 1, time: '21:00', title: 'æ™šé¤ï¼šé³¥è²´æ—', location: 'é³¥è²´æ— (ç§‹è‘‰åŸåº—)', note: 'ğŸ¢ å‡ä¸€åƒ¹ç‡’é³¥å±…é…’å±‹ã€‚' },
            { id: 105, day: 1, time: '22:30', title: 'çºŒæ”¤/æ•£æ­¥', location: 'æ±å¤§å’Œç”ºå‘¨é‚Š', note: 'ğŸº æ„Ÿå—å¤œç”Ÿæ´»ã€‚' },
            // D2
            { id: 201, day: 2, time: '08:00', title: 'å‡ºç™¼å‰å¾€å·è¶Š', location: 'æ± è¢‹ç«™', note: 'ğŸš† è½‰ä¹˜æ±æ­¦æ±ä¸Šç·š (ç´„30åˆ†)ã€‚' },
            { id: 202, day: 2, time: '10:00', title: 'å·è¶Š (å°æ±Ÿæˆ¶)', location: 'å·è¶Šä¸€ç•ªè¡—', note: 'â›©ï¸ å¿…é€›ï¼šå†°å·ç¥ç¤¾ã€æ™‚ä¹‹é˜ã€è“å­å±‹æ©«ä¸ã€‚' },
            { id: 203, day: 2, time: '17:30', title: 'ç§»å‹•è‡³æ–°å®¿', location: 'æ–°å®¿', note: 'ğŸ™ï¸ å‚æ™šçš„æ–°å®¿éœ“è™¹ç‡ˆæœ€ç¾ã€‚' },
            { id: 204, day: 2, time: '18:00', title: 'æ™šé¤ï¼šæ–°å®¿ã®ã‘ã‚€ã‚Š', location: 'æ–°å®¿ã®ã‘ã‚€ã‚Š', note: 'ğŸ”¥ äººæ°£å±…é…’å±‹ï¼Œæ°£æ°›ç†±é¬§ã€‚' },
            // D3
            { id: 301, day: 3, time: '09:00', title: 'ç¯‰åœ°å¸‚å ´', location: 'ç¯‰åœ°å ´å¤–', note: 'ğŸ£ æ¨è–¦ï¼šç‹ç‹¸å±‹ç‰›ä¸¼ã€ç‰å­ç‡’ã€‚' },
            { id: 302, day: 3, time: '11:30', title: 'ç§‹è‘‰åŸ', location: 'ç§‹è‘‰åŸ', note: 'ğŸ® ç™½å¤©çš„ç§‹è‘‰åŸï¼ŒMandarake å°‹å¯¶ã€‚' },
            { id: 303, day: 3, time: '14:30', title: 'æ·ºè‰å¯º', location: 'æ·ºè‰é›·é–€', note: 'ğŸ® ä»²è¦‹ä¸–é€šåƒã€Œæ·ºè‰ç‚¸è‚‰é¤…ã€ã€‚' },
            { id: 304, day: 3, time: '17:00', title: 'éŠ€åº§é€›è¡—', location: 'éŠ€åº§', note: 'ğŸ›ï¸ Uniqlo æ——è‰¦åº—ã€Itoya ä¼Šæ±å±‹ã€‚' },
            // D4
            { id: 401, day: 4, time: '09:30', title: 'æ˜æ²»ç¥å®®', location: 'åŸå®¿ç«™', note: 'ğŸŒ² äº«å—éƒ½å¸‚èŠ¬å¤šç²¾ã€‚' },
            { id: 402, day: 4, time: '11:30', title: 'è¡¨åƒé“', location: 'è¡¨åƒé“ Hills', note: 'â˜• æ™‚å°šè¡—æ‹ã€‚' },
            { id: 403, day: 4, time: '14:00', title: 'æ¾€è°·', location: 'æ¾€è°· Scramble', note: 'ğŸ• å¿ çŠ¬å…«å…¬ã€SHIBUYA SKYã€Parcoã€‚' },
            // D5
            { id: 501, day: 5, time: '06:50', title: 'é›†åˆå‡ºç™¼', location: 'æ±äº¬å·¨è›‹ä¸¸ä¹‹å…§ãƒ’ãƒ­', note: 'ğŸšŒ KLOOK åœ˜é«”è¡Œç¨‹ï¼Œè«‹æº–æ™‚ï¼' },
            { id: 502, day: 5, time: '14:00', title: 'éŠ€å±±æº«æ³‰', location: 'éŠ€å±±æº«æ³‰', note: 'â™¨ï¸ å¤§æ­£æµªæ¼«çµ•æ™¯ï¼è‡ªç”±æ´»å‹• 90 åˆ†é˜ã€‚' },
            { id: 503, day: 5, time: '16:30', title: 'å‰å¾€é£¯åº—', location: 'å±±å½¢ç¸£/å®®åŸç¸£', note: 'ğŸ¨ æ ¹æ“šè¡Œç¨‹èªªæ˜å…¥ä½ã€‚' },
            { id: 504, day: 5, time: '18:00', title: 'æ™šé¤', location: 'é£¯åº—å…§', note: 'ğŸ± äº«ç”¨ç•¶åœ°æ–™ç†ã€‚' },
            // D6
            { id: 601, day: 6, time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'é£¯åº—', note: 'ğŸ³ åƒé£½é£½ï¼Œæº–å‚™å»é›ªå±±ã€‚' },
            { id: 602, day: 6, time: '10:00', title: 'è—ç‹æ¨¹å†°', location: 'è—ç‹çºœè»Š', note: 'â„ï¸ è‡ªç”±æ´»å‹• 2 å°æ™‚ã€‚å±±é ‚æ¥µå†·(-10åº¦)ï¼' },
            { id: 603, day: 6, time: '12:00', title: 'è—ç‹ç‹ç‹¸æ‘', location: 'å®®åŸè—ç‹ç‹ç‹¸æ‘', note: 'ğŸ¦Š è‡ªç”±æ´»å‹• 1 å°æ™‚ã€‚é–€ç¥¨Â¥1500ã€‚' },
            { id: 604, day: 6, time: '13:00', title: 'è¿”ç¨‹æ±äº¬', location: 'å·´å£«è»Šä¸Š', note: 'ğŸšŒ è¿”å›æ±äº¬ï¼Œé è¨ˆ21:00æŠµé”ã€‚' },
            { id: 605, day: 6, time: '21:00', title: 'æŠµé”æ±äº¬', location: 'æ–°å®¿/æ±äº¬ç«™', note: 'ğŸ—¼ è‡ªè¡Œå›ç§‹è‘‰åŸé£¯åº—ä¼‘æ¯ã€‚' },
            // D7
            { id: 701, day: 7, time: '09:00', title: 'æœ€å¾Œæ•´ç†', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ§³ Check-outã€‚' },
            { id: 702, day: 7, time: '10:00', title: 'å‰å¾€æ©Ÿå ´', location: 'äº¬æˆä¸Šé‡ç«™', note: 'ğŸš† æ­ä¹˜ Skylinerã€‚' },
            { id: 703, day: 7, time: '13:20', title: 'æˆç”°èµ·é£› (CI0103)', location: 'æˆç”°æ©Ÿå ´ T2', note: 'âœˆï¸ å›é«˜é›„ã€‚å¹³å®‰é †åˆ©ï¼' }
        ];

        const defaultExpenses = [
            { id: 1, title: 'Skyliner ä¾†å›', amount: 5000, payer: 'æˆ‘' },
            { id: 2, title: 'Day 1 é³¥è²´æ—', amount: 8000, payer: 'æ—…ä¼´A' },
            { id: 3, title: 'ç‹ç‹¸æ‘é–€ç¥¨', amount: 1500, payer: 'æˆ‘' }
        ];
        
        const defaultUsers = ['æˆ‘', 'æ—…ä¼´A', 'æ—…ä¼´B'];

        // --- Components ---

        const ParticleBackground = ({ type }) => {
            const count = type === 'snow' ? 30 : 15;
            const color = type === 'snow' ? '#FFF' : '#FFD7E0';
            const particles = useMemo(() => Array.from({ length: count }).map((_, i) => ({
                id: i, left: Math.random() * 100, delay: Math.random() * 5, duration: Math.random() * 5 + 5, size: Math.random() * 8 + 5,
            })), [type]);

            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-0" style={{ background: type === 'snow' ? 'linear-gradient(to bottom, #8BA3C7, #EBF4FA)' : 'transparent' }}>
                    {particles.map(p => (
                        <div key={p.id} className="particle" style={{ left: `${p.left}%`, fontSize: `${p.size}px`, color: color, animationDuration: `${p.duration}s`, animationDelay: `${p.delay}s`, opacity: type === 'snow' ? 0.7 : 0.4 }}>
                            {type === 'snow' ? 'â„' : 'ğŸŒ¸'}
                        </div>
                    ))}
                </div>
            );
        };

        const ItineraryCard = ({ item, isSnowDay, index, onEdit, onDelete }) => (
            <div className={`relative pl-6 border-l-2 border-gray-200 last:border-0 mb-6 stagger-item`} style={{ animationDelay: `${index * 0.05}s` }}>
                <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 bg-white ${isSnowDay ? 'border-jp-blue' : 'border-jp-green'}`}></div>
                <div className="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm active:scale-[0.99] transition-transform duration-200 border border-white/60">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <span className={`font-bold font-mono text-xl ${isSnowDay ? 'text-jp-blue' : 'text-jp-green'}`}>{item.time}</span>
                            <div className="text-xs text-gray-400">Day {item.day}</div>
                        </div>
                        <div className="flex gap-1">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(item); }} className="p-2 text-gray-300 hover:text-jp-green transition-colors active:scale-90"><Icon name="Edit2" size={16} /></button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="p-2 text-gray-300 hover:text-jp-red transition-colors active:scale-90"><Icon name="Trash2" size={16} /></button>
                        </div>
                    </div>
                    <h3 className="font-bold text-gray-700 text-lg mb-1">{item.title}</h3>
                    {item.location && <div className="flex items-center text-gray-500 text-sm mb-2" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}><Icon name="MapPin" size={14} className="mr-1 text-jp-red" />{item.location}</div>}
                    {item.note && <div className="sticky-note">{item.note.split('\n').map((line, i) => <div key={i}>{line}</div>)}</div>}
                </div>
            </div>
        );

        // --- æ¢å¾©éºæ¼çš„ ExchangeRateCard å…ƒä»¶ ---
        const ExchangeRateCard = () => {
            const [rate, setRate] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [jpyVal, setJpyVal] = useState('');
            const [twdVal, setTwdVal] = useState('');

            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                    .then(res => res.json())
                    .then(data => {
                        const r = data.rates.TWD;
                        setRate(r);
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, []);

            const handleJpyChange = (e) => {
                const val = e.target.value;
                setJpyVal(val);
                if (rate && !isNaN(val)) setTwdVal(val ? (parseFloat(val) * rate).toFixed(0) : '');
            };

            const handleTwdChange = (e) => {
                const val = e.target.value;
                setTwdVal(val);
                if (rate && !isNaN(val)) setJpyVal(val ? (parseFloat(val) / rate).toFixed(0) : '');
            };

            return (
                <div className="bg-gradient-to-br from-jp-yellow to-yellow-600 text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden transition-all active:scale-[0.99]">
                    <div className="absolute right-0 top-0 opacity-10 transform rotate-12 -mr-4 -mt-4"><Icon name="TrendingUp" size={100} color="white" /></div>
                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-sm font-bold opacity-90 flex items-center gap-1">åŒ¯ç‡æ›ç®—å™¨</h2>
                                <div className="text-[10px] mt-0.5 opacity-80 font-mono">{loading ? 'æ›´æ–°ä¸­...' : `1 TWD â‰ˆ ${(1/(rate||1)).toFixed(2)} JPY`}</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">JPY</label>
                                <input type="number" value={jpyVal} onChange={handleJpyChange} className="input-underline font-mono text-lg font-bold" placeholder="0" />
                            </div>
                            <div className="pt-6"><Icon name="ArrowRightLeft" size={20} className="opacity-80" /></div>
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">TWD</label>
                                <input type="number" value={twdVal} onChange={handleTwdChange} className="input-underline font-mono text-lg font-bold" placeholder="0" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ItineraryView = ({ items, setItems }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            
            const days = [1, 2, 3, 4, 5, 6, 7];
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSnowDay = selectedDay === 5 || selectedDay === 6;

            const handleDelete = (id) => {
                if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) setItems(items.filter(i => i.id !== id));
            };

            const handleAdd = () => {
                if (!newItem.title || !newItem.time) return;
                setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]);
                setIsAdding(false);
                setNewItem({ time: '', title: '', location: '', note: '' });
            };

            const handleUpdate = () => {
                if (!editingItem.title || !editingItem.time) return;
                setItems(items.map(i => i.id === editingItem.id ? editingItem : i));
                setEditingItem(null);
            };

            return (
                <div className="flex flex-col h-full w-full">
                    <ParticleBackground type={isSnowDay ? 'snow' : 'sakura'} />
                    
                    <div className="scroll-container p-5">
                        <header className="mb-6 mt-2 flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl font-bold text-jp-ink tracking-widest drop-shadow-sm">{isSnowDay ? 'æ±åŒ—é›ªè¦‹ â„ï¸' : 'æ±äº¬æ•£ç­– ğŸ—¼'}</h1>
                                <p className="text-sm text-gray-500 mt-1 font-mono tracking-wide">Day {selectedDay} | 2025.01.{17 + selectedDay}</p>
                            </div>
                            <button onClick={() => setIsAdding(true)} className="bg-jp-green text-white p-3 rounded-full shadow-lg active:scale-90 transition-transform"><Icon name="Plus" size={24}/></button>
                        </header>

                        <div className="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2 snap-x snap-mandatory">
                            {days.map(d => (
                                <button key={d} onClick={() => setSelectedDay(d)} className={`snap-center px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all transform shadow-sm active:scale-95 ${selectedDay === d ? (d >= 5 && d <= 6 ? 'bg-jp-blue text-white' : 'bg-jp-green text-white') : 'bg-white/70 text-gray-500 hover:bg-white'}`}>Day {d}</button>
                            ))}
                        </div>

                        <div>
                            {filteredItems.map((item, idx) => (
                                <ItineraryCard key={item.id} item={item} isSnowDay={isSnowDay} index={idx} onEdit={setEditingItem} onDelete={handleDelete} />
                            ))}
                            {filteredItems.length === 0 && <div className="text-center text-gray-400 py-10">å°šç„¡è¡Œç¨‹</div>}
                        </div>
                    </div>

                    {/* Add Modal */}
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-modal" style={{zIndex: 100}}>
                            <div className="bg-white w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl pb-safe-bottom">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">æ–°å¢è¡Œç¨‹</h3>
                                <div className="space-y-4">
                                    {/* step="600" for 10 minutes interval */}
                                    <input type="time" step="600" value={newItem.time} onChange={e => setNewItem({...newItem, time: e.target.value})} className="input-light" required />
                                    <input type="text" placeholder="æ¨™é¡Œ" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="åœ°é»" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} className="input-light" />
                                    <textarea placeholder="å‚™è¨»" value={newItem.note} onChange={e => setNewItem({...newItem, note: e.target.value})} className="input-light resize-none h-20"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={handleAdd} className="flex-1 py-3 bg-jp-green text-white font-bold rounded-xl shadow-md">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-modal" style={{zIndex: 100}}>
                            <div className="bg-white w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl pb-safe-bottom">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">ç·¨è¼¯è¡Œç¨‹</h3>
                                <div className="space-y-4">
                                    {/* step="600" for 10 minutes interval */}
                                    <input type="time" step="600" value={editingItem.time} onChange={e => setEditingItem({...editingItem, time: e.target.value})} className="input-light" required />
                                    <input type="text" placeholder="æ¨™é¡Œ" value={editingItem.title} onChange={e => setEditingItem({...editingItem, title: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="åœ°é»" value={editingItem.location} onChange={e => setEditingItem({...editingItem, location: e.target.value})} className="input-light" />
                                    <textarea placeholder="å‚™è¨»" value={editingItem.note} onChange={e => setEditingItem({...editingItem, note: e.target.value})} className="input-light resize-none h-20"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setEditingItem(null)} className="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={handleUpdate} className="flex-1 py-3 bg-jp-green text-white font-bold rounded-xl shadow-md">æ›´æ–°</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ExpenseView = ({ expenses, setExpenses, users, setUsers }) => {
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');

            useEffect(() => {
                if (users.length > 0 && !newExp.payer) {
                    setNewExp(prev => ({ ...prev, payer: users[0] }));
                }
            }, [users]);

            // --- é‡æ–°å¯¦ä½œåˆ†å¸³æ ¸å¿ƒæ¼”ç®—æ³• ---
            const debtSummary = useMemo(() => {
                let balances = {};
                users.forEach(u => balances[u] = 0);
                let totalSpent = 0;
                
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0];
                    if (!payer) return;
                    const cost = parseFloat(e.amount);
                    totalSpent += cost;
                    balances[payer] += cost;
                    const splitAmount = cost / users.length;
                    users.forEach(u => balances[u] -= splitAmount);
                });

                const debts = [];
                const debtors = users.filter(u => balances[u] < -1);
                const creditors = users.filter(u => balances[u] > 1);

                debtors.sort((a, b) => balances[a] - balances[b]);
                creditors.sort((a, b) => balances[b] - balances[a]);

                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                    if (amount > 0) {
                        debts.push({ from: debtor, to: creditor, amount: Math.round(amount) });
                    }
                    balances[debtor] += amount;
                    balances[creditor] -= amount;
                    if (Math.abs(balances[debtor]) < 1) i++;
                    if (balances[creditor] < 1) j++;
                }
                return { debts, totalSpent };
            }, [expenses, users]);

            const handleAddUser = () => {
                if (newUserName.trim() && !users.includes(newUserName.trim())) {
                    setUsers([...users, newUserName.trim()]);
                    setNewUserName('');
                    setIsAddingUser(false);
                }
            };

            const handleDeleteUser = (u) => {
                if (users.length <= 1) { alert("è‡³å°‘ä¿ç•™ä¸€ä½æˆå“¡"); return; }
                if (confirm(`ç¢ºå®šç§»é™¤ ${u}ï¼Ÿ`)) setUsers(users.filter(user => user !== u));
            };

            const handleAddExpense = () => {
                if (!newExp.title || !newExp.amount) return;
                setExpenses([...expenses, { ...newExp, id: Date.now(), amount: parseFloat(newExp.amount) }]);
                setNewExp({ title: '', amount: '', payer: users[0] || '' });
            };

            const handleDeleteExpense = (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ")) setExpenses(expenses.filter(e => e.id !== id));
            };

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container">
                    <h1 className="text-2xl font-bold text-jp-ink mb-6">æ—…è²»æ‰‹å¸³ ğŸ’°</h1>
                    
                    <ExchangeRateCard />

                    {/* æˆå“¡ç®¡ç† */}
                    <div className="mb-6">
                        <div className="flex justify-between items-center mb-2"><span className="text-xs text-gray-400 font-bold uppercase tracking-wider">æˆå“¡åå–®</span></div>
                        <div className="flex flex-wrap gap-2 items-center">
                            {users.map(u => (
                                <div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm text-gray-600 border border-gray-200 shadow-sm flex items-center group">
                                    <Icon name="User" size={12} className="mr-1.5 opacity-50"/>{u}
                                    <button onClick={() => handleDeleteUser(u)} className="ml-1 text-gray-300 hover:text-jp-red"><Icon name="X" size={12}/></button>
                                </div>
                            ))}
                            {isAddingUser ? (
                                <div className="flex items-center bg-white px-2 py-1 rounded-full border border-jp-yellow shadow-sm">
                                    <input type="text" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="bg-transparent outline-none text-sm w-20 text-gray-700" placeholder="åå­—" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddUser()} />
                                    <button onClick={handleAddUser} className="text-jp-yellow ml-1"><Icon name="Check" size={14}/></button>
                                    <button onClick={() => setIsAddingUser(false)} className="text-gray-400 ml-1"><Icon name="X" size={14}/></button>
                                </div>
                            ) : (
                                <button onClick={() => setIsAddingUser(true)} className="px-3 py-1.5 rounded-full text-sm bg-white border border-dashed border-gray-300 text-gray-500 hover:border-jp-yellow hover:text-jp-yellow transition-all flex items-center"><Icon name="Plus" size={14} className="mr-1"/></button>
                            )}
                        </div>
                    </div>

                    {/* çµç®—å¡ç‰‡ */}
                    <div className="bg-white p-5 rounded-2xl shadow-lg mb-8 relative overflow-hidden border border-gray-100">
                        <div className="flex justify-between items-end mb-4 relative z-10">
                            <h2 className="text-sm text-gray-400 uppercase tracking-wider font-bold">ç¸½æ”¯å‡º</h2>
                             <span className="text-2xl font-bold font-mono text-gold">Â¥{debtSummary.totalSpent.toLocaleString()}</span>
                        </div>
                        
                        <div className="h-px bg-gray-100 w-full mb-4"></div>

                        <h2 className="text-xs text-jp-yellow mb-3 uppercase tracking-wider font-bold">å»ºè­°é‚„æ¬¾</h2>
                        {debtSummary.debts.length === 0 ? (
                            <div className="text-center py-2 text-gray-400 text-sm">ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œå‹èª¼é•·å­˜ âœ¨</div>
                        ) : (
                            <div className="space-y-3 relative z-10">
                                {debtSummary.debts.map((d, idx) => (
                                    <div key={idx} className="flex justify-between items-center border-b border-gray-50 pb-2 last:border-0">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">{d.from}</span>
                                            <span className="text-[10px] text-gray-400">âœ</span>
                                            <span className="bg-jp-yellow text-white px-2 py-1 rounded text-xs font-bold">{d.to}</span>
                                        </div>
                                        <span className="font-mono text-lg font-bold text-gray-700">Â¥{d.amount.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* æ–°å¢æ”¯å‡ºå€å¡Š */}
                    <div className="bg-white/90 p-4 rounded-xl shadow-sm mb-6 border border-gray-100">
                        <h3 className="text-sm font-bold text-gray-500 mb-3">è¨˜ä¸Šä¸€ç­†</h3>
                        <div className="space-y-3">
                            <input type="text" placeholder="é …ç›® (ä¾‹: æ‹‰éºµ)" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-light" />
                            <div className="flex gap-2">
                                <input type="number" placeholder="é‡‘é¡ (JPY)" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-light flex-1" />
                                <select value={newExp.payer} onChange={e => setNewExp({...newExp, payer: e.target.value})} className="bg-transparent border-b border-gray-300 outline-none text-sm w-24 text-gray-600">
                                    {users.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <button onClick={handleAddExpense} className="w-full bg-jp-yellow text-white py-3 rounded-xl shadow-md active:scale-95 transition-transform mt-2 font-bold">æ–°å¢ç´€éŒ„</button>
                        </div>
                    </div>

                    {/* æ”¯å‡ºåˆ—è¡¨ */}
                    <div className="space-y-4 pb-10">
                        {expenses.slice().reverse().map((exp, idx) => (
                            <div key={exp.id} className="bg-white/90 p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-jp-yellow stagger-item" style={{ animationDelay: `${idx * 0.05}s` }}>
                                <div>
                                    <div className="font-bold text-gray-800">{exp.title}</div>
                                    <div className="text-xs text-gray-500 flex items-center mt-1"><Icon name="User" size={12} className="mr-1" /> {exp.payer} å…ˆä»˜</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="font-mono font-bold text-lg text-gold">Â¥{exp.amount.toLocaleString()}</div>
                                    <button onClick={() => handleDeleteExpense(exp.id)} className="text-gray-300 hover:text-jp-red"><Icon name="Trash2" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MapView = ({ items }) => (
            <div className="p-5 h-full relative z-10 animate-fade-in scroll-container">
                <h1 className="text-2xl font-bold text-jp-ink mb-6">æ™¯é»åœ°åœ– ğŸ—ºï¸</h1>
                <div className="grid gap-3">
                    {items.filter(i => i.location).map((item, idx) => (
                        <div key={item.id} className="bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-sm flex items-center gap-3 stagger-item active:scale-98 transition-transform"
                             style={{ animationDelay: `${idx * 0.05}s` }}
                             onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}>
                            <div className="bg-blue-100 p-2 rounded-full text-jp-blue"><Icon name="MapPin" size={18} /></div>
                            <div>
                                <div className="text-sm font-bold text-gray-700">{item.location}</div>
                                <div className="text-xs text-gray-400">Day {item.day}</div>
                            </div>
                            <div className="ml-auto text-gray-300"><Icon name="ChevronRight" size={18} /></div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'Calendar', color: 'text-jp-green' },
                { id: 'map', label: 'åœ°åœ–', icon: 'MapPin', color: 'text-jp-blue' },
                { id: 'expenses', label: 'åˆ†å¸³', icon: 'Wallet', color: 'text-jp-yellow' },
            ];
            return (
                <div className="tab-bar-glass fixed bottom-0 left-0 right-0 pb-safe-bottom pt-3 px-8 flex justify-between z-50 rounded-t-2xl">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-16 transition-all duration-300 active:scale-90 ${activeTab === tab.id ? `${tab.color} -translate-y-1` : 'text-gray-400'}`}>
                            <Icon name={tab.icon} size={24} className={activeTab === tab.id ? "stroke-2" : "stroke-1"} />
                            <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [itineraryItems, setItineraryItems] = useStickyState(defaultItinerary, 'jp_trip_2025_final');
            const [expenses, setExpenses] = useStickyState(defaultExpenses, 'jp_trip_2025_expenses_final');
            const [users, setUsers] = useStickyState(defaultUsers, 'jp_trip_2025_users_final');

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                    case 'expenses': return <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} />;
                    case 'map': return <MapView items={itineraryItems} />;
                    default: return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                }
            };

            return (
                <div id="app-container">
                    {renderContent()}
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>