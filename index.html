<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 Êù±‰∫¨Êù±Âåó„ÉªÈõ™Ë¶ãÊâãÂ∏ñ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --jp-bg: #F9F7F2;       /* ËÉ°Á≤â */
            --jp-text: #4A4A4A;     /* Â¢® */
            --jp-green: #6A8D73;    /* Êü≥Êüì */
            --jp-red: #D67D7D;      /* Áîö‰∏âÁ¥Ö */
            --jp-yellow: #E8B664;   /* Â±±Âêπ */
            --jp-blue: #7CA0B8;     /* ÂãøÂøòËçâ */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--jp-bg);
            color: var(--jp-text);
            -webkit-tap-highlight-color: transparent;
            /* ÈùíÊµ∑Ê≥¢ (Seigaiha) Êó•Á≥ªÁ¥ãÊ®£ËÉåÊôØ */
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='12' viewBox='0 0 20 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 12c0-.622-.095-1.221-.27-1.785A5.982 5.982 0 0 0 10 12c1.654 0 3.153-.67 4.27-1.785A5.998 5.998 0 0 0 20 12h-2a3.997 3.997 0 0 1-4-4 3.997 3.997 0 0 1-4 4h-2a3.997 3.997 0 0 1-4-4 3.997 3.997 0 0 1-4 4H0zm6-12c0 .622.095 1.221.27 1.785A5.982 5.982 0 0 0 10 0C8.346 0 6.847.67 5.73 1.785A5.998 5.998 0 0 0 0 0h2a3.997 3.997 0 0 1 4 4 3.997 3.997 0 0 1 4-4h2a3.997 3.997 0 0 1 4 4 3.997 3.997 0 0 1 4-4h2z' fill='%236A8D73' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        #root {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(100px + var(--safe-bottom));
            position: relative;
            z-index: 10;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }

        .sticky-note {
            background-color: #FFFDF0;
            border-left: 3px solid var(--jp-yellow);
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 2px 8px 8px 2px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.03);
            position: relative;
            font-size: 0.85rem;
            color: #666;
            line-height: 1.6;
        }
        
        .particle {
            position: absolute;
            top: -10px;
            pointer-events: none;
            z-index: 0;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0; }
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        .stagger-item { opacity: 0; animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .text-gold { color: #C18A26; }
        
        @keyframes modalUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-modal { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Floating Action Button Pulse */
        @keyframes fab-pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 141, 115, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(106, 141, 115, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 141, 115, 0); }
        }
        .fab-btn {
            animation: fab-pulse 2s infinite;
        }

        .input-underline {
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-underline:focus { border-bottom-color: white; }
        
        .input-light {
            background: transparent;
            border-bottom: 1px solid #E5E7EB;
            padding: 12px 0;
            width: 100%;
            outline: none;
            font-size: 1rem;
            color: var(--jp-text);
            transition: border-color 0.3s;
        }
        .input-light:focus { border-bottom-color: var(--jp-green); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icon ---
        const Icon = ({ name, size = 20, className, color = "currentColor", strokeWidth = 2 }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // --- Hook ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                try {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                } catch (e) { return defaultValue; }
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Data ---
        const defaultItinerary = [
            { id: 101, day: 1, time: '13:05', title: 'È´òÈõÑËµ∑È£õ (CI0126)', location: 'È´òÈõÑÂúãÈöõÊ©üÂ†¥', note: '‚úàÔ∏è È†êË®à 17:30 ÊäµÈÅîÊàêÁî∞„ÄÇÂá∫ÈóúÂæåÊê≠ Skyliner Áõ¥Â•î‰∏äÈáé/ÁßãËëâÂéü„ÄÇ' },
            { id: 102, day: 1, time: '19:30', title: 'Check-in', location: 'Êù±‰∫¨ÁßãÂè∂ÂéüÂòâÈôΩ„Éì„É´', note: 'üè® ÊîæË°åÊùé„ÄÇ‰ΩçÊñºÁßãËëâÂéüÊ†∏ÂøÉÂçÄ„ÄÇ' },
            { id: 103, day: 1, time: '20:00', title: 'ÁßãËëâÂéüÈõªÂô®Ë°ó', location: 'ÁßãËëâÂéü', note: 'üí° 2025 Êé®Ëñ¶ÔºöYodobashi Camera (È§êÂª≥Ë°óÈñãÂæàÊôö)„ÄÅRadio Kaikan„ÄÇ' },
            { id: 104, day: 1, time: '21:00', title: 'ÊôöÈ§êÔºöÈ≥•Ë≤¥Êóè', location: 'È≥•Ë≤¥Êóè (ÁßãËëâÂéüÂ∫ó)', note: 'üç¢ Âùá‰∏ÄÂÉπÁáíÈ≥•Â±ÖÈÖíÂ±ã„ÄÇ' },
            { id: 105, day: 1, time: '22:30', title: 'Á∫åÊî§/Êï£Ê≠•', location: 'Êù±Â§ßÂíåÁî∫Âë®ÈÇä', note: 'üç∫ ÊÑüÂèóÂ§úÁîüÊ¥ª„ÄÇ' },
            { id: 201, day: 2, time: '08:00', title: 'Âá∫ÁôºÂâçÂæÄÂ∑ùË∂ä', location: 'Ê±†Ë¢ãÁ´ô', note: 'üöÜ ËΩâ‰πòÊù±Ê≠¶Êù±‰∏äÁ∑ö (Á¥Ñ30ÂàÜ)„ÄÇ' },
            { id: 202, day: 2, time: '10:00', title: 'Â∑ùË∂ä (Â∞èÊ±üÊà∂)', location: 'Â∑ùË∂ä‰∏ÄÁï™Ë°ó', note: '‚õ©Ô∏è ÂøÖÈÄõÔºöÂÜ∞Â∑ùÁ•ûÁ§æ„ÄÅÊôÇ‰πãÈêò„ÄÅËèìÂ≠êÂ±ãÊ©´‰∏Å„ÄÇ' },
            { id: 203, day: 2, time: '17:30', title: 'ÁßªÂãïËá≥Êñ∞ÂÆø', location: 'Êñ∞ÂÆø', note: 'üèôÔ∏è ÂÇçÊôöÁöÑÊñ∞ÂÆøÈúìËôπÁáàÊúÄÁæé„ÄÇ' },
            { id: 204, day: 2, time: '18:00', title: 'ÊôöÈ§êÔºöÊñ∞ÂÆø„ÅÆ„Åë„ÇÄ„Çä', location: 'Êñ∞ÂÆø„ÅÆ„Åë„ÇÄ„Çä', note: 'üî• ‰∫∫Ê∞£Â±ÖÈÖíÂ±ãÔºåÊ∞£Ê∞õÁÜ±È¨ß„ÄÇ' },
            { id: 301, day: 3, time: '09:00', title: 'ÁØâÂú∞Â∏ÇÂ†¥', location: 'ÁØâÂú∞Â†¥Â§ñ', note: 'üç£ Êé®Ëñ¶ÔºöÁãêÁã∏Â±ãÁâõ‰∏º„ÄÅÁéâÂ≠êÁáí„ÄÇ' },
            { id: 302, day: 3, time: '11:30', title: 'ÁßãËëâÂéü', location: 'ÁßãËëâÂéü', note: 'üéÆ ÁôΩÂ§©ÁöÑÁßãËëâÂéüÔºåMandarake Â∞ãÂØ∂„ÄÇ' },
            { id: 303, day: 3, time: '14:30', title: 'Ê∑∫ËçâÂØ∫', location: 'Ê∑∫ËçâÈõ∑ÈñÄ', note: 'üèÆ ‰ª≤Ë¶ã‰∏ñÈÄöÂêÉ„ÄåÊ∑∫ËçâÁÇ∏ËÇâÈ§Ö„Äç„ÄÇ' },
            { id: 304, day: 3, time: '17:00', title: 'ÈäÄÂ∫ßÈÄõË°ó', location: 'ÈäÄÂ∫ß', note: 'üõçÔ∏è Uniqlo ÊóóËâ¶Â∫ó„ÄÅItoya ‰ºäÊù±Â±ã„ÄÇ' },
            { id: 401, day: 4, time: '09:30', title: 'ÊòéÊ≤ªÁ•ûÂÆÆ', location: 'ÂéüÂÆøÁ´ô', note: 'üå≤ ‰∫´ÂèóÈÉΩÂ∏ÇËä¨Â§öÁ≤æ„ÄÇ' },
            { id: 402, day: 4, time: '11:30', title: 'Ë°®ÂèÉÈÅì', location: 'Ë°®ÂèÉÈÅì Hills', note: '‚òï ÊôÇÂ∞öË°óÊãç„ÄÇ' },
            { id: 403, day: 4, time: '14:00', title: 'ÊæÄË∞∑', location: 'ÊæÄË∞∑ Scramble', note: 'üêï Âø†Áä¨ÂÖ´ÂÖ¨„ÄÅSHIBUYA SKY„ÄÅParco„ÄÇ' },
            { id: 501, day: 5, time: '06:50', title: 'ÈõÜÂêàÂá∫Áôº', location: 'Êù±‰∫¨Â∑®Ëõã‰∏∏‰πãÂÖß„Éí„É≠', note: 'üöå KLOOK ÂúòÈ´îË°åÁ®ãÔºåË´ãÊ∫ñÊôÇÔºÅ' },
            { id: 502, day: 5, time: '14:00', title: 'ÈäÄÂ±±Ê∫´Ê≥â', location: 'ÈäÄÂ±±Ê∫´Ê≥â', note: '‚ô®Ô∏è Â§ßÊ≠£Êµ™Êº´ÁµïÊôØÔºÅËá™Áî±Ê¥ªÂãï 90 ÂàÜÈêò„ÄÇ' },
            { id: 503, day: 5, time: '16:30', title: 'ÂâçÂæÄÈ£ØÂ∫ó', location: 'Â±±ÂΩ¢Á∏£/ÂÆÆÂüéÁ∏£', note: 'üè® Ê†πÊìöË°åÁ®ãË™™ÊòéÂÖ•‰Ωè„ÄÇ' },
            { id: 504, day: 5, time: '18:00', title: 'ÊôöÈ§ê', location: 'È£ØÂ∫óÂÖß', note: 'üç± ‰∫´Áî®Áï∂Âú∞ÊñôÁêÜ„ÄÇ' },
            { id: 601, day: 6, time: '07:00', title: 'È£ØÂ∫óÊó©È§ê', location: 'È£ØÂ∫ó', note: 'üç≥ ÂêÉÈ£ΩÈ£ΩÔºåÊ∫ñÂÇôÂéªÈõ™Â±±„ÄÇ' },
            { id: 602, day: 6, time: '10:00', title: 'ËóèÁéãÊ®πÂÜ∞', location: 'ËóèÁéãÁ∫úËªä', note: '‚ùÑÔ∏è Ëá™Áî±Ê¥ªÂãï 2 Â∞èÊôÇ„ÄÇÂ±±È†ÇÊ•µÂÜ∑(-10Â∫¶)ÔºÅ' },
            { id: 603, day: 6, time: '12:00', title: 'ËóèÁéãÁãêÁã∏Êùë', location: 'ÂÆÆÂüéËóèÁéãÁãêÁã∏Êùë', note: 'ü¶ä Ëá™Áî±Ê¥ªÂãï 1 Â∞èÊôÇ„ÄÇÈñÄÁ•®¬•1500„ÄÇ' },
            { id: 604, day: 6, time: '13:00', title: 'ËøîÁ®ãÊù±‰∫¨', location: 'Â∑¥Â£´Ëªä‰∏ä', note: 'üöå ËøîÂõûÊù±‰∫¨ÔºåÈ†êË®à21:00ÊäµÈÅî„ÄÇ' },
            { id: 605, day: 6, time: '21:00', title: 'ÊäµÈÅîÊù±‰∫¨', location: 'Êñ∞ÂÆø/Êù±‰∫¨Á´ô', note: 'üóº Ëá™Ë°åÂõûÁßãËëâÂéüÈ£ØÂ∫ó‰ºëÊÅØ„ÄÇ' },
            { id: 701, day: 7, time: '09:00', title: 'Check-out', location: 'Êù±‰∫¨ÁßãÂè∂ÂéüÂòâÈôΩ„Éì„É´', note: 'üß≥ Êï¥ÁêÜË°åÊùé„ÄÇ' },
            { id: 702, day: 7, time: '10:00', title: 'ÂâçÂæÄÊ©üÂ†¥', location: '‰∫¨Êàê‰∏äÈáéÁ´ô', note: 'üöÜ Êê≠‰πò Skyliner„ÄÇ' },
            { id: 703, day: 7, time: '13:20', title: 'ÊàêÁî∞Ëµ∑È£õ (CI0103)', location: 'ÊàêÁî∞Ê©üÂ†¥ T2', note: '‚úàÔ∏è Âπ≥ÂÆâÂõûÂÆ∂ÔºÅ' }
        ];

        const defaultExpenses = [
            { id: 1, title: 'Skyliner ‰æÜÂõû', amount: 5000, payer: 'Êàë' },
            { id: 2, title: 'Day 1 È≥•Ë≤¥Êóè', amount: 8000, payer: 'ÊóÖ‰º¥A' },
            { id: 3, title: 'ÁãêÁã∏ÊùëÈñÄÁ•®', amount: 1500, payer: 'Êàë' }
        ];
        
        const defaultUsers = ['Êàë', 'ÊóÖ‰º¥A', 'ÊóÖ‰º¥B'];

        // --- Components ---

        const JapaneseScenery = () => (
            <div className="fixed bottom-0 left-0 w-full h-48 pointer-events-none z-0 opacity-40 select-none overflow-hidden" style={{paddingBottom: 'env(safe-area-inset-bottom)'}}>
                <svg viewBox="0 0 1440 320" className="w-full h-full object-cover">
                    <circle cx="200" cy="100" r="40" fill="#D67D7D" opacity="0.6" />
                    <path fill="#7CA0B8" fillOpacity="0.8" d="M720 160L960 320H480L720 160Z" />
                    <path fill="#FFFFFF" d="M720 160L800 213L760 220L720 200L680 220L640 213L720 160Z" />
                    <path fill="#6A8D73" fillOpacity="0.6" d="M0 256L200 160L400 320H0V256Z" />
                    <path fill="#6A8D73" fillOpacity="0.6" d="M1440 224L1100 320H1440V224Z" />
                    <path fill="#D67D7D" d="M1100 280 H1200 V320 H1180 V290 H1120 V320 H1100 V280 Z" />
                    <path fill="#D67D7D" d="M1090 270 H1210 V280 H1090 Z" />
                    <path fill="#D67D7D" d="M1080 250 H1220 V260 H1080 Z" />
                </svg>
            </div>
        );

        const ParticleBackground = ({ type }) => {
            const count = type === 'snow' ? 30 : 15;
            const color = type === 'snow' ? '#FFF' : '#FFD7E0';
            const particles = useMemo(() => Array.from({ length: count }).map((_, i) => ({
                id: i, left: Math.random() * 100, delay: Math.random() * 5, duration: Math.random() * 5 + 5, size: Math.random() * 8 + 5,
            })), [type]);

            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-0" style={{ background: type === 'snow' ? 'linear-gradient(to bottom, #8BA3C7, #EBF4FA)' : 'transparent' }}>
                    {particles.map(p => (
                        <div key={p.id} className="particle" style={{ left: `${p.left}%`, fontSize: `${p.size}px`, color: color, animationDuration: `${p.duration}s`, animationDelay: `${p.delay}s`, opacity: type === 'snow' ? 0.7 : 0.4 }}>
                            {type === 'snow' ? '‚ùÑ' : 'üå∏'}
                        </div>
                    ))}
                </div>
            );
        };

        const ItineraryCard = ({ item, isSnowDay, index, onEdit, onDelete }) => (
            <div className={`relative pl-6 border-l-2 border-gray-200 last:border-0 mb-6 stagger-item`} style={{ animationDelay: `${index * 0.05}s` }}>
                <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 bg-white ${isSnowDay ? 'border-jp-blue' : 'border-jp-green'}`}></div>
                <div className="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm active:scale-[0.99] transition-transform duration-200 border border-white/60">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <span className={`font-bold font-mono text-xl ${isSnowDay ? 'text-jp-blue' : 'text-jp-green'}`}>{item.time}</span>
                            <div className="text-xs text-gray-400">Day {item.day}</div>
                        </div>
                        <div className="flex gap-1">
                            <button onClick={(e) => { e.stopPropagation(); onEdit(item); }} className="p-2 text-gray-300 hover:text-jp-green transition-colors active:scale-90"><Icon name="Edit2" size={16} /></button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="p-2 text-gray-300 hover:text-jp-red transition-colors active:scale-90"><Icon name="Trash2" size={16} /></button>
                        </div>
                    </div>
                    <h3 className="font-bold text-gray-700 text-lg mb-1">{item.title}</h3>
                    {item.location && <div className="flex items-center text-gray-500 text-sm mb-2" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}><Icon name="MapPin" size={14} className="mr-1 text-jp-red" />{item.location}</div>}
                    {item.note && <div className="sticky-note">{item.note.split('\n').map((line, i) => <div key={i}>{line}</div>)}</div>}
                </div>
            </div>
        );

        const ExchangeRateCard = () => {
            const [rate, setRate] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [jpyVal, setJpyVal] = useState('');
            const [twdVal, setTwdVal] = useState('');

            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                    .then(res => res.json())
                    .then(data => {
                        const r = data.rates.TWD;
                        setRate(r);
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, []);

            const handleJpyChange = (e) => {
                const val = e.target.value;
                setJpyVal(val);
                if (rate && !isNaN(val)) setTwdVal(val ? (parseFloat(val) * rate).toFixed(0) : '');
            };

            const handleTwdChange = (e) => {
                const val = e.target.value;
                setTwdVal(val);
                if (rate && !isNaN(val)) setJpyVal(val ? (parseFloat(val) / rate).toFixed(0) : '');
            };

            return (
                <div className="bg-gradient-to-br from-jp-yellow to-yellow-600 text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden transition-all active:scale-[0.99]">
                    <div className="absolute right-0 top-0 opacity-10 transform rotate-12 -mr-4 -mt-4"><Icon name="TrendingUp" size={100} color="white" /></div>
                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-sm font-bold opacity-90 flex items-center gap-1">ÂåØÁéáÊèõÁÆóÂô®</h2>
                                <div className="text-[10px] mt-0.5 opacity-80 font-mono">{loading ? 'Êõ¥Êñ∞‰∏≠...' : `1 TWD ‚âà ${(1/(rate||1)).toFixed(2)} JPY`}</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">JPY</label>
                                <input type="number" value={jpyVal} onChange={handleJpyChange} className="input-underline font-mono text-lg font-bold" placeholder="0" />
                            </div>
                            <div className="pt-6"><Icon name="ArrowRightLeft" size={20} className="opacity-80" /></div>
                            <div className="flex-1">
                                <label className="text-[10px] uppercase opacity-80 block mb-1 font-bold">TWD</label>
                                <input type="number" value={twdVal} onChange={handleTwdChange} className="input-underline font-mono text-lg font-bold" placeholder="0" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ItineraryView = ({ items, setItems }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const [isAdding, setIsAdding] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [newItem, setNewItem] = useState({ time: '', title: '', location: '', note: '' });
            
            const days = [1, 2, 3, 4, 5, 6, 7];
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSnowDay = selectedDay === 5 || selectedDay === 6;

            const handleDelete = (id) => {
                if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü")) setItems(items.filter(i => i.id !== id));
            };

            const handleAdd = () => {
                if (!newItem.title || !newItem.time) return;
                setItems([...items, { ...newItem, id: Date.now(), day: selectedDay }]);
                setIsAdding(false);
                setNewItem({ time: '', title: '', location: '', note: '' });
            };

            const handleUpdate = () => {
                if (!editingItem.title || !editingItem.time) return;
                setItems(items.map(i => i.id === editingItem.id ? editingItem : i));
                setEditingItem(null);
            };

            return (
                <div className="flex flex-col h-full w-full">
                    <ParticleBackground type={isSnowDay ? 'snow' : 'sakura'} />
                    
                    <div className="scroll-container p-5">
                        <header className="mb-6 mt-2 flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl font-bold text-jp-ink tracking-widest drop-shadow-sm">{isSnowDay ? 'Êù±ÂåóÈõ™Ë¶ã ‚ùÑÔ∏è' : 'Êù±‰∫¨Êï£Á≠ñ üóº'}</h1>
                                <p className="text-sm text-gray-500 mt-1 font-mono tracking-wide">Day {selectedDay} | 2025.01.{17 + selectedDay}</p>
                            </div>
                        </header>

                        <div className="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2 snap-x snap-mandatory">
                            {days.map(d => (
                                <button key={d} onClick={() => setSelectedDay(d)} className={`snap-center px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all transform shadow-sm active:scale-95 ${selectedDay === d ? (d >= 5 && d <= 6 ? 'bg-jp-blue text-white' : 'bg-jp-green text-white') : 'bg-white/70 text-gray-500 hover:bg-white'}`}>Day {d}</button>
                            ))}
                        </div>

                        <div>
                            {filteredItems.map((item, idx) => (
                                <ItineraryCard key={item.id} item={item} isSnowDay={isSnowDay} index={idx} onEdit={setEditingItem} onDelete={handleDelete} />
                            ))}
                            {filteredItems.length === 0 && <div className="text-center text-gray-400 py-10">Â∞öÁÑ°Ë°åÁ®ã</div>}
                        </div>
                    </div>

                    {/* Centered Floating Action Button */}
                    <div className="fixed bottom-[100px] left-1/2 transform -translate-x-1/2 z-40">
                        <button 
                            onClick={() => setIsAdding(true)} 
                            className="fab-btn bg-jp-green text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-transform border-4 border-white"
                        >
                            <Icon name="Plus" size={32} strokeWidth={3}/>
                        </button>
                    </div>

                    {/* Add Modal */}
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-modal" style={{zIndex: 100}}>
                            <div className="bg-white w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl pb-safe-bottom">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">Êñ∞Â¢ûË°åÁ®ã</h3>
                                <div className="space-y-4">
                                    <input type="time" step="600" value={newItem.time} onChange={e => setNewItem({...newItem, time: e.target.value})} className="input-light" required />
                                    <input type="text" placeholder="Ê®ôÈ°å" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="Âú∞Èªû" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} className="input-light" />
                                    <textarea placeholder="ÂÇôË®ª" value={newItem.note} onChange={e => setNewItem({...newItem, note: e.target.value})} className="input-light resize-none h-20"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">ÂèñÊ∂à</button>
                                    <button onClick={handleAdd} className="flex-1 py-3 bg-jp-green text-white font-bold rounded-xl shadow-md">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-modal" style={{zIndex: 100}}>
                            <div className="bg-white w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl pb-safe-bottom">
                                <h3 className="text-lg font-bold mb-4 text-jp-green">Á∑®ËºØË°åÁ®ã</h3>
                                <div className="space-y-4">
                                    <input type="time" step="600" value={editingItem.time} onChange={e => setEditingItem({...editingItem, time: e.target.value})} className="input-light" required />
                                    <input type="text" placeholder="Ê®ôÈ°å" value={editingItem.title} onChange={e => setEditingItem({...editingItem, title: e.target.value})} className="input-light" />
                                    <input type="text" placeholder="Âú∞Èªû" value={editingItem.location} onChange={e => setEditingItem({...editingItem, location: e.target.value})} className="input-light" />
                                    <textarea placeholder="ÂÇôË®ª" value={editingItem.note} onChange={e => setEditingItem({...editingItem, note: e.target.value})} className="input-light resize-none h-20"></textarea>
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setEditingItem(null)} className="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">ÂèñÊ∂à</button>
                                    <button onClick={handleUpdate} className="flex-1 py-3 bg-jp-green text-white font-bold rounded-xl shadow-md">Êõ¥Êñ∞</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ExpenseView = ({ expenses, setExpenses, users, setUsers }) => {
            const [newExp, setNewExp] = useState({ title: '', amount: '', payer: '' });
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');

            useEffect(() => {
                if (users.length > 0 && !newExp.payer) {
                    setNewExp(prev => ({ ...prev, payer: users[0] }));
                }
            }, [users]);

            const debtSummary = useMemo(() => {
                let balances = {};
                users.forEach(u => balances[u] = 0);
                let totalSpent = 0;
                
                expenses.forEach(e => {
                    const payer = users.includes(e.payer) ? e.payer : users[0];
                    if (!payer) return;
                    const cost = parseFloat(e.amount);
                    totalSpent += cost;
                    balances[payer] += cost;
                    const splitAmount = cost / users.length;
                    users.forEach(u => balances[u] -= splitAmount);
                });

                const debts = [];
                const debtors = users.filter(u => balances[u] < -1);
                const creditors = users.filter(u => balances[u] > 1);

                debtors.sort((a, b) => balances[a] - balances[b]);
                creditors.sort((a, b) => balances[b] - balances[a]);

                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(balances[debtor]), balances[creditor]);
                    if (amount > 0) {
                        debts.push({ from: debtor, to: creditor, amount: Math.round(amount) });
                    }
                    balances[debtor] += amount;
                    balances[creditor] -= amount;
                    if (Math.abs(balances[debtor]) < 1) i++;
                    if (balances[creditor] < 1) j++;
                }
                return { debts, totalSpent };
            }, [expenses, users]);

            const handleAddUser = () => {
                if (newUserName.trim() && !users.includes(newUserName.trim())) {
                    setUsers([...users, newUserName.trim()]);
                    setNewUserName('');
                    setIsAddingUser(false);
                }
            };

            const handleDeleteUser = (u) => {
                if (users.length <= 1) { alert("Ëá≥Â∞ë‰øùÁïô‰∏Ä‰ΩçÊàêÂì°"); return; }
                if (confirm(`Á¢∫ÂÆöÁßªÈô§ ${u}Ôºü`)) setUsers(users.filter(user => user !== u));
            };

            const handleAddExpense = () => {
                if (!newExp.title || !newExp.amount) return;
                setExpenses([...expenses, { ...newExp, id: Date.now(), amount: parseFloat(newExp.amount) }]);
                setNewExp({ title: '', amount: '', payer: users[0] || '' });
            };

            const handleDeleteExpense = (id) => {
                if (confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜÊîØÂá∫Ôºü")) setExpenses(expenses.filter(e => e.id !== id));
            };

            return (
                <div className="p-5 h-full relative z-10 animate-fade-in scroll-container">
                    <h1 className="text-2xl font-bold text-jp-ink mb-6">ÊóÖË≤ªÊâãÂ∏≥ üí∞</h1>
                    <ExchangeRateCard />

                    <div className="mb-6">
                        <div className="flex justify-between items-center mb-2"><span className="text-xs text-gray-500 font-bold">ÊàêÂì°ÂêçÂñÆ</span></div>
                        <div className="flex flex-wrap gap-2 items-center">
                            {users.map(u => (
                                <div key={u} className="bg-white px-3 py-1.5 rounded-full text-sm text-gray-600 border border-gray-200 shadow-sm flex items-center group">
                                    <Icon name="User" size={12} className="mr-1.5 opacity-50"/>{u}
                                    <button onClick={() => handleDeleteUser(u)} className="ml-2 text-gray-300 hover:text-jp-red"><Icon name="X" size={12}/></button>
                                </div>
                            ))}
                            {isAddingUser ? (
                                <div className="flex items-center bg-white px-2 py-1 rounded-full border border-jp-yellow shadow-sm">
                                    <input type="text" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="bg-transparent outline-none text-sm w-20 text-gray-700" placeholder="ÂêçÂ≠ó" autoFocus onKeyDown={(e) => e.key === 'Enter' && handleAddUser()} />
                                    <button onClick={handleAddUser} className="text-jp-yellow ml-1"><Icon name="Check" size={14}/></button>
                                    <button onClick={() => setIsAddingUser(false)} className="text-gray-400 ml-1"><Icon name="X" size={14}/></button>
                                </div>
                            ) : (
                                <button onClick={() => setIsAddingUser(true)} className="px-3 py-1.5 rounded-full text-sm bg-white border border-dashed border-gray-300 text-gray-500 hover:border-jp-yellow hover:text-jp-yellow transition-all flex items-center"><Icon name="Plus" size={14} className="mr-1"/></button>
                            )}
                        </div>
                    </div>

                    <div className="bg-white p-5 rounded-2xl shadow-lg mb-8 relative overflow-hidden border border-gray-100">
                        <div className="flex justify-between items-end mb-4 relative z-10">
                            <h2 className="text-sm text-gray-400 uppercase tracking-wider font-bold">Á∏ΩÊîØÂá∫</h2>
                             <span className="text-2xl font-bold font-mono text-gold">¬•{debtSummary.totalSpent.toLocaleString()}</span>
                        </div>
                        
                        <div className="h-px bg-gray-100 w-full mb-4"></div>

                        <h2 className="text-xs text-jp-yellow mb-3 uppercase tracking-wider font-bold">Âª∫Ë≠∞ÈÇÑÊ¨æ</h2>
                        {debtSummary.debts.length === 0 ? (
                            <div className="text-center py-2 text-gray-400 text-sm">ÁõÆÂâçÂ∏≥ÁõÆÂπ≥Ë°°ÔºåÂèãË™ºÈï∑Â≠ò ‚ú®</div>
                        ) : (
                            <div className="space-y-3 relative z-10">
                                {debtSummary.debts.map((d, idx) => (
                                    <div key={idx} className="flex justify-between items-center border-b border-gray-50 pb-2 last:border-0">
                                        <div className="flex items-center gap-2">
                                            <span className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-600">{d.from}</span>
                                            <span className="text-[10px] text-gray-400">‚ûú</span>
                                            <span className="bg-jp-yellow text-white px-2 py-1 rounded text-xs font-bold">{d.to}</span>
                                        </div>
                                        <span className="font-mono text-lg font-bold text-gray-700">¬•{d.amount.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div className="bg-white/90 p-4 rounded-xl shadow-sm mb-6 border border-gray-100">
                        <h3 className="text-sm font-bold text-gray-500 mb-3">Ë®ò‰∏ä‰∏ÄÁ≠Ü</h3>
                        <div className="space-y-3">
                            <input type="text" placeholder="È†ÖÁõÆ (‰æã: ÊãâÈ∫µ)" value={newExp.title} onChange={e => setNewExp({...newExp, title: e.target.value})} className="input-light" />
                            <div className="flex gap-2">
                                <input type="number" placeholder="ÈáëÈ°ç (JPY)" value={newExp.amount} onChange={e => setNewExp({...newExp, amount: e.target.value})} className="input-light flex-1" />
                                <select value={newExp.payer} onChange={e => setNewExp({...newExp, payer: e.target.value})} className="bg-transparent border-b border-gray-300 outline-none text-sm w-24 text-gray-600">
                                    {users.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <button onClick={handleAddExpense} className="w-full bg-jp-yellow text-white py-3 rounded-xl shadow-md active:scale-95 transition-transform mt-2 font-bold">Êñ∞Â¢ûÁ¥ÄÈåÑ</button>
                        </div>
                    </div>

                    <div className="space-y-4 pb-10">
                        {expenses.slice().reverse().map((exp, idx) => (
                            <div key={exp.id} className="bg-white/90 p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-jp-yellow stagger-item" style={{ animationDelay: `${idx * 0.05}s` }}>
                                <div>
                                    <div className="font-bold text-gray-800">{exp.title}</div>
                                    <div className="text-xs text-gray-500 flex items-center mt-1"><Icon name="User" size={12} className="mr-1" /> {exp.payer} ÂÖà‰ªò</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="font-mono font-bold text-lg text-gold">¬•{exp.amount.toLocaleString()}</div>
                                    <button onClick={() => handleDeleteExpense(exp.id)} className="text-gray-300 hover:text-jp-red"><Icon name="Trash2" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const MapView = ({ items }) => (
            <div className="p-5 h-full relative z-10 animate-fade-in scroll-container">
                <h1 className="text-2xl font-bold text-jp-ink mb-6">ÊôØÈªûÂú∞Âúñ üó∫Ô∏è</h1>
                <div className="grid gap-3">
                    {items.filter(i => i.location).map((item, idx) => (
                        <div key={item.id} className="bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-sm flex items-center gap-3 stagger-item active:scale-98 transition-transform"
                             style={{ animationDelay: `${idx * 0.05}s` }}
                             onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}>
                            <div className="bg-blue-100 p-2 rounded-full text-jp-blue"><Icon name="MapPin" size={18} /></div>
                            <div>
                                <div className="text-sm font-bold text-gray-700">{item.location}</div>
                                <div className="text-xs text-gray-400">Day {item.day}</div>
                            </div>
                            <div className="ml-auto text-gray-300"><Icon name="ChevronRight" size={18} /></div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'Ë°åÁ®ã', icon: 'Calendar', color: 'text-jp-green' },
                { id: 'map', label: 'Âú∞Âúñ', icon: 'MapPin', color: 'text-jp-blue' },
                { id: 'expenses', label: 'ÂàÜÂ∏≥', icon: 'Wallet', color: 'text-jp-yellow' },
            ];
            return (
                <div className="tab-bar-glass fixed bottom-0 left-0 right-0 pb-safe-bottom pt-3 px-8 flex justify-between z-50 rounded-t-2xl">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-16 transition-all duration-300 active:scale-90 ${activeTab === tab.id ? `${tab.color} -translate-y-1` : 'text-gray-400'}`}>
                            <Icon name={tab.icon} size={24} className={activeTab === tab.id ? "stroke-2" : "stroke-1"} />
                            <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [itineraryItems, setItineraryItems] = useStickyState(defaultItinerary, 'jp_trip_2025_final');
            const [expenses, setExpenses] = useStickyState(defaultExpenses, 'jp_trip_2025_expenses_final');
            const [users, setUsers] = useStickyState(defaultUsers, 'jp_trip_2025_users_final');

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                    case 'expenses': return <ExpenseView expenses={expenses} setExpenses={setExpenses} users={users} setUsers={setUsers} />;
                    case 'map': return <MapView items={itineraryItems} />;
                    default: return <ItineraryView items={itineraryItems} setItems={setItineraryItems} />;
                }
            };

            return (
                <div id="app-container">
                    <JapaneseScenery />
                    {/* Key Â±¨ÊÄßÂº∑Âà∂ÈáçÊñ∞Ê∏≤ÊüìÔºåËß£Ê±∫ iOS ÂàáÊèõ tab ÂæåÊç≤ÂãïÂç°Ê≠ªÁöÑÂïèÈ°å */}
                    <div key={activeTab} style={{height: '100%', width: '100%', position: 'absolute', top: 0, left: 0}}>
                        {renderContent()}
                    </div>
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
