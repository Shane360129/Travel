<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 æ±äº¬æ±åŒ—ãƒ»é›ªè¦‹æ‰‹å¸–</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (åœ–æ¨™åº«) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Zen Maru Gothic (åœ“é«”) & Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --jp-bg: #F9F7F2;       /* èƒ¡ç²‰ */
            --jp-text: #4A4A4A;     /* å¢¨ */
            --jp-green: #6A8D73;    /* æŸ³æŸ“ */
            --jp-red: #D67D7D;      /* ç”šä¸‰ç´… */
            --jp-yellow: #E8B664;   /* å±±å¹ */
            --jp-blue: #7CA0B8;     /* å‹¿å¿˜è‰ */
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: var(--jp-bg);
            color: var(--jp-text);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            overflow: hidden;
            /* å’Œç´™è³ªæ„Ÿå™ªé» */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
        }

        #root {
            height: 100vh;
            height: 100dvh;
            width: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* åº•éƒ¨å°èˆªæ¬„ç»ç’ƒæ“¬æ…‹ */
        .tab-bar-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }

        /* ä¾¿æ¢ç´™é¢¨æ ¼å‚™è¨» */
        .sticky-note {
            background-color: #FFFDF0;
            border-left: 3px solid var(--jp-yellow);
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: 2px 8px 8px 2px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.03);
            position: relative;
            font-size: 0.85rem;
            color: #666;
            line-height: 1.6;
        }
        
        /* é£„é›ª/æ«»èŠ±å‹•ç•« */
        .particle {
            position: absolute;
            top: -10px;
            pointer-events: none;
            z-index: 0;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0; }
        }

        /* é é¢é€²å ´å‹•ç•« */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.99); }
            to { opacity: 1; transform: scale(1); }
        }

        /* åˆ—è¡¨ä¾åºæ»‘å…¥ */
        .stagger-item {
            opacity: 0;
            animation: slideUp 0.5s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ—¥ç³»æ¼¸å±¤æ–‡å­— */
        .text-gold {
            color: #C18A26;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-ink': '#4A4A4A',
                        'jp-green': '#6A8D73',
                        'jp-red': '#D67D7D',
                        'jp-yellow': '#E8B664',
                        'jp-blue': '#7CA0B8',
                        'jp-gray': '#9CA3AF',
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ä¿®å¾©ç‰ˆ Icon å…ƒä»¶ ---
        const Icon = ({ name, size = 20, className, color = "currentColor" }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke={color}
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // --- Custom Hook: LocalStorage ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- è¡Œç¨‹è³‡æ–™ ---
        const defaultItinerary = [
            // D1: 1/18 ç§‹è‘‰åŸ
            { id: 101, day: 1, time: '13:05', title: 'æŠµé”æ±äº¬', location: 'æˆç”°æ©Ÿå ´', note: 'âœˆï¸ CI0126ã€‚å‡ºé—œå¾Œæ­ Skyliner ç›´å¥”ä¸Šé‡/ç§‹è‘‰åŸã€‚' },
            { id: 102, day: 1, time: '16:00', title: 'Check-in', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ¨ æ”¾è¡Œæã€‚ä½æ–¼ç§‹è‘‰åŸæ ¸å¿ƒå€ï¼Œé€›è¡—è¶…æ–¹ä¾¿ã€‚' },
            { id: 103, day: 1, time: '17:00', title: 'ç§‹è‘‰åŸé›»å™¨è¡—', location: 'ç§‹è‘‰åŸ', note: 'ğŸ’¡ 2025 æ¨è–¦ï¼š\n1. TAMASHII NATIONS STORE (æ–°å…¬ä»”)\n2. Yodobashi Camera (8F é¤å»³è¡—é–‹å¾ˆæ™š)\n3. GiGO å¤¾å¨ƒå¨ƒæ©Ÿ' },
            { id: 104, day: 1, time: '19:30', title: 'æ™šé¤ï¼šé³¥è²´æ—', location: 'é³¥è²´æ— (ç§‹è‘‰åŸåº—)', note: 'ğŸ¢ å‡ä¸€åƒ¹ç‡’é³¥å±…é…’å±‹ï¼Œå¹³æ¿é»é¤(æœ‰ä¸­æ–‡)ã€‚å¿…é»ï¼šè²´æ—ç‡’ã€é‡œé£¯ã€‚' },
            { id: 105, day: 1, time: '21:00', title: 'çºŒæ”¤/æ•£æ­¥', location: 'æ±å¤§å’Œç”ºå‘¨é‚Š', note: 'ğŸº æ„Ÿå—æ±äº¬å¤œç”Ÿæ´»ï¼Œæˆ–é€›é€›é‚„é–‹è‘—çš„å”å‰è¨¶å¾·ã€‚' },

            // D2: 1/19 å·è¶Š+æ–°å®¿
            { id: 201, day: 2, time: '08:00', title: 'å‡ºç™¼å‰å¾€å·è¶Š', location: 'æ± è¢‹ç«™', note: 'ğŸš† è½‰ä¹˜æ±æ­¦æ±ä¸Šç·š (ç´„30åˆ†)ã€‚å»ºè­°è²·ã€Œå·è¶Šç‰¹æ€¥åˆ¸ã€ã€‚' },
            { id: 202, day: 2, time: '10:00', title: 'å·è¶Š (å°æ±Ÿæˆ¶)', location: 'å·è¶Šä¸€ç•ªè¡—', note: 'â›©ï¸ å¿…é€›ï¼š\n1. å†°å·ç¥ç¤¾ (é‡£é¯›é­šç±¤)\n2. æ™‚ä¹‹é˜ (æ˜Ÿå·´å…‹)\n3. è“å­å±‹æ©«ä¸ (æ‡·èˆŠé›¶é£Ÿ)' },
            { id: 203, day: 2, time: '17:30', title: 'ç§»å‹•è‡³æ–°å®¿', location: 'æ–°å®¿', note: 'ğŸ™ï¸ å‚æ™šçš„æ–°å®¿éœ“è™¹ç‡ˆæœ€ç¾ã€‚å¯å»æ­Œèˆä¼ç”º Tower æ‹ç…§ã€‚' },
            { id: 204, day: 2, time: '18:00', title: 'æ™šé¤ï¼šæ–°å®¿ã®ã‘ã‚€ã‚Š', location: 'æ–°å®¿ã®ã‘ã‚€ã‚Š', note: 'ğŸ”¥ äººæ°£å±…é…’å±‹ï¼Œæ°£æ°›ç†±é¬§ï¼Œé©åˆå°é…Œã€‚' },

            // D3: 1/20 ç¯‰åœ°/ç§‹/æ·º/éŠ€
            { id: 301, day: 3, time: '08:00', title: 'ç¯‰åœ°å¸‚å ´', location: 'ç¯‰åœ°å ´å¤–', note: 'ğŸ£ æ—©é¤ï¼æ¨è–¦ï¼šç‹ç‹¸å±‹ç‰›ä¸¼(æ’éšŠååº—)ã€ä¸¸æ­¦ç‰å­ç‡’ã€ç”Ÿé®®æµ·è†½ã€‚' },
            { id: 302, day: 3, time: '11:00', title: 'ç§‹è‘‰åŸ', location: 'ç§‹è‘‰åŸ', note: 'ğŸ® ç™½å¤©çš„ç§‹è‘‰åŸï¼Œè£œé½Šæ˜¨å¤©æ²’é€›åˆ°çš„åº—ã€‚Mandarake å°‹å¯¶ã€‚' },
            { id: 303, day: 3, time: '14:00', title: 'æ·ºè‰å¯º', location: 'æ·ºè‰é›·é–€', note: 'ğŸ® åƒæ‹œè§€éŸ³ã€‚ä»²è¦‹ä¸–é€šåƒã€Œæ·ºè‰ç‚¸è‚‰é¤…ã€ã€ã€ŒèŠ±æœˆå ‚è è˜¿éºµåŒ…ã€ã€‚' },
            { id: 304, day: 3, time: '17:00', title: 'éŠ€åº§é€›è¡—', location: 'éŠ€åº§', note: 'ğŸ›ï¸ æ¨è–¦ï¼š\n1. Uniqlo éŠ€åº§æ——è‰¦åº— (12å±¤æ¨“)\n2. Itoya ä¼Šæ±å±‹ (æ–‡å…·æ§å¤©å ‚)\n3. éŠ€åº§ Six (è”¦å±‹æ›¸åº—)' },

            // D4: 1/21 æ˜æ²»/è¡¨åƒ/æ¾€è°·
            { id: 401, day: 4, time: '09:30', title: 'æ˜æ²»ç¥å®®', location: 'åŸå®¿ç«™', note: 'ğŸŒ² å·¨å¤§çš„é³¥å±…èˆ‡æ£®æ—ï¼Œäº«å—éƒ½å¸‚èŠ¬å¤šç²¾ã€‚' },
            { id: 402, day: 4, time: '11:30', title: 'è¡¨åƒé“', location: 'è¡¨åƒé“ Hills', note: 'â˜• æ™‚å°šè¡—æ‹ã€‚æ¨è–¦ï¼šRalph\'s Coffee æˆ– Apple Store æœè–ã€‚' },
            { id: 403, day: 4, time: '14:00', title: 'æ¾€è°·', location: 'æ¾€è°· Scramble', note: 'ğŸ• å¿ çŠ¬å…«å…¬ã€SHIBUYA SKY (éœ€é ç´„)ã€Parco (ä»»å¤©å ‚/å¯¶å¯å¤¢ä¸­å¿ƒ)ã€‚' },

            // D5: 1/22 KLOOK æ±åŒ—2æ—¥éŠ Day 1
            { id: 501, day: 5, time: '06:50', title: 'é›†åˆå‡ºç™¼', location: 'æ±äº¬å·¨è›‹ä¸¸ä¹‹å…§ãƒ’ãƒ­', note: 'ğŸšŒ KLOOK åœ˜é«”è¡Œç¨‹ï¼Œè«‹å‹™å¿…æº–æ™‚ï¼æº–å‚™é•·é€”è»Šç¨‹ã€‚' },
            { id: 502, day: 5, time: '14:00', title: 'éŠ€å±±æº«æ³‰', location: 'éŠ€å±±æº«æ³‰', note: 'â™¨ï¸ å¤§æ­£æµªæ¼«çµ•æ™¯ï¼è‡ªç”±æ´»å‹• 90 åˆ†é˜ã€‚\nğŸ“¸ å¿…æ‹ï¼šèƒ½ç™»å±‹æ—…é¤¨ã€ç´…æ©‹ã€‚\nâš ï¸ æé†’ï¼šä¸‹åˆ4é»å¤šä¸å¯èƒ½å›åˆ°éŠ€åº§ï¼Œé€™è£¡æ‡‰æŒ‡æŠµé”æ±åŒ—çš„ä½å®¿é»ã€‚' },
            { id: 503, day: 5, time: '16:30', title: 'å‰å¾€é£¯åº—', location: 'å±±å½¢ç¸£/å®®åŸç¸£', note: 'ğŸ¨ æ ¹æ“šè¡Œç¨‹èªªæ˜å…¥ä½æº«æ³‰é£¯åº—æˆ–å¸‚å€é£¯åº—ã€‚' },
            { id: 504, day: 5, time: '18:00', title: 'æ™šé¤', location: 'é£¯åº—å…§/å‘¨é‚Š', note: 'ğŸ± äº«ç”¨ç•¶åœ°æœƒå¸­æ–™ç†æˆ–è‡ªåŠ©é¤ã€‚' },

            // D6: 1/23 KLOOK æ±åŒ—2æ—¥éŠ Day 2
            { id: 601, day: 6, time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'é£¯åº—', note: 'ğŸ³ åƒé£½é£½ï¼Œä»Šå¤©è¦å»é›ªå±±ï¼Œéœ€è¦ç†±é‡ï¼' },
            { id: 602, day: 6, time: '10:00', title: 'è—ç‹æ¨¹å†°', location: 'è—ç‹çºœè»Š', note: 'â„ï¸ è‡ªç”±æ´»å‹• 2 å°æ™‚ã€‚æ­çºœè»Šçœ‹ã€Œé›ªæ€ªã€ã€‚å±±é ‚éå¸¸å†·(-10åº¦)ï¼Œè«‹å…¨å‰¯æ­¦è£ï¼' },
            { id: 603, day: 6, time: '12:00', title: 'è—ç‹ç‹ç‹¸æ‘', location: 'å®®åŸè—ç‹ç‹ç‹¸æ‘', note: 'ğŸ¦Š è‡ªç”±æ´»å‹• 1 å°æ™‚ã€‚é–€ç¥¨Â¥1500 (é€šå¸¸åœ˜è²»ä¸å«)ã€‚\nâš ï¸ å°å¿ƒéš¨èº«æ›é£¾è¢«ç‹ç‹¸å’¬èµ°ã€‚' },
            { id: 604, day: 6, time: '13:00', title: 'è¿”ç¨‹æ±äº¬', location: 'å·´å£«è»Šä¸Š', note: 'ğŸšŒ æ¼«é•·çš„è¿”ç¨‹ï¼Œä¸­é–“æœƒåœé ä¼‘æ¯ç«™ï¼Œå¯è²·æ±åŒ—é™å®šä¼´æ‰‹ç¦® (æ¯›è±†å¥¶æ˜”ã€ç‰›èˆŒé¤…ä¹¾)ã€‚' },
            { id: 605, day: 6, time: '21:00', title: 'æŠµé”æ±äº¬', location: 'æ–°å®¿/æ±äº¬ç«™', note: 'ğŸ—¼ çµæŸè¡Œç¨‹ï¼Œè‡ªè¡Œå›ç§‹è‘‰åŸé£¯åº—ä¼‘æ¯ã€‚' },

            // D7: 1/24 è¿”ç¨‹
            { id: 701, day: 7, time: '09:00', title: 'æœ€å¾Œæ•´ç†', location: 'æ±äº¬ç§‹å¶åŸå˜‰é™½ãƒ“ãƒ«', note: 'ğŸ§³ Check-outã€‚æª¢æŸ¥è­·ç…§ã€éŒ¢åŒ…ã€‚' },
            { id: 702, day: 7, time: '10:00', title: 'å‰å¾€æ©Ÿå ´', location: 'äº¬æˆä¸Šé‡ç«™', note: 'ğŸš† æ­ä¹˜ Skyliner (ç´„45åˆ†)ã€‚å»ºè­° 11:20 å‰æŠµé”æ©Ÿå ´ã€‚' },
            { id: 703, day: 7, time: '13:20', title: 'é£›æ©Ÿèµ·é£›', location: 'æˆç”°æ©Ÿå ´ T2', note: 'âœˆï¸ CI0103 å›é«˜é›„ã€‚å¹³å®‰é †åˆ©ï¼' }
        ];

        const defaultExpenses = [
            { id: 1, title: 'Skyliner ä¾†å›', amount: 5000, payer: 'æˆ‘' },
            { id: 2, title: 'Day 1 é³¥è²´æ—', amount: 8000, payer: 'æ—…ä¼´A' },
            { id: 3, title: 'ç‹ç‹¸æ‘é–€ç¥¨', amount: 1500, payer: 'æˆ‘' }
        ];
        
        const defaultUsers = ['æˆ‘', 'æ—…ä¼´A', 'æ—…ä¼´B'];

        // --- å…ƒä»¶ï¼šç²’å­èƒŒæ™¯ (é›ª/èŠ±) ---
        const ParticleBackground = ({ type }) => {
            const count = type === 'snow' ? 30 : 15;
            const color = type === 'snow' ? '#FFF' : '#FFD7E0';
            
            const particles = useMemo(() => Array.from({ length: count }).map((_, i) => ({
                id: i,
                left: Math.random() * 100,
                delay: Math.random() * 5,
                duration: Math.random() * 5 + 5,
                size: Math.random() * 8 + 5,
            })), [type]);

            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden z-0" 
                     style={{ background: type === 'snow' ? 'linear-gradient(to bottom, #8BA3C7, #EBF4FA)' : 'transparent' }}>
                    {particles.map(p => (
                        <div key={p.id} className="particle"
                            style={{
                                left: `${p.left}%`,
                                fontSize: `${p.size}px`,
                                color: color,
                                animationDuration: `${p.duration}s`,
                                animationDelay: `${p.delay}s`,
                                opacity: type === 'snow' ? 0.7 : 0.4
                            }}>
                            {type === 'snow' ? 'â„' : 'ğŸŒ¸'}
                        </div>
                    ))}
                </div>
            );
        };

        // --- å…ƒä»¶ï¼šè¡Œç¨‹å¡ç‰‡ ---
        const ItineraryCard = ({ item, isSnowDay, index }) => (
            <div className={`relative pl-6 border-l-2 border-gray-200 last:border-0 mb-6 stagger-item`} style={{ animationDelay: `${index * 0.05}s` }}>
                <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 bg-white ${isSnowDay ? 'border-jp-blue' : 'border-jp-green'}`}></div>
                
                <div className="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm active:scale-[0.98] transition-transform duration-200 border border-white/60">
                    <div className="flex justify-between items-baseline mb-2">
                        <span className={`font-bold font-mono text-xl ${isSnowDay ? 'text-jp-blue' : 'text-jp-green'}`}>{item.time}</span>
                        <div className="text-xs text-gray-400">Day {item.day}</div>
                    </div>
                    
                    <h3 className="font-bold text-gray-700 text-lg mb-1">{item.title}</h3>
                    
                    {item.location && (
                        <div className="flex items-center text-gray-500 text-sm mb-2" onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}>
                            <Icon name="MapPin" size={14} className="mr-1 text-jp-red" />
                            {item.location}
                        </div>
                    )}

                    {item.note && (
                        <div className="sticky-note">
                            {item.note.split('\n').map((line, i) => <div key={i}>{line}</div>)}
                        </div>
                    )}
                </div>
            </div>
        );

        // --- è¦–åœ–ï¼šè¡Œç¨‹è¡¨ ---
        const ItineraryView = ({ items }) => {
            const [selectedDay, setSelectedDay] = useState(1);
            const days = [1, 2, 3, 4, 5, 6, 7];
            const filteredItems = items.filter(i => i.day === selectedDay).sort((a, b) => a.time.localeCompare(b.time));
            const isSnowDay = selectedDay === 5 || selectedDay === 6;

            return (
                <div className="flex flex-col h-full relative animate-fade-in">
                    <ParticleBackground type={isSnowDay ? 'snow' : 'sakura'} />
                    
                    <div className="flex-1 overflow-y-auto no-scrollbar relative z-10 p-5 pb-24">
                        <header className="mb-6 mt-2">
                            <h1 className="text-3xl font-bold text-jp-ink tracking-widest drop-shadow-sm">
                                {isSnowDay ? 'æ±åŒ—é›ªè¦‹ â„ï¸' : 'æ±äº¬æ•£ç­– ğŸ—¼'}
                            </h1>
                            <p className="text-sm text-gray-500 mt-1 font-mono tracking-wide">
                                2025.01.{17 + selectedDay} (Day {selectedDay})
                            </p>
                        </header>

                        {/* å¤©æ•¸é¸æ“‡å™¨ (Native Scroll Snap) */}
                        <div className="flex gap-3 mb-6 overflow-x-auto no-scrollbar pb-2 snap-x snap-mandatory">
                            {days.map(d => (
                                <button
                                    key={d}
                                    onClick={() => setSelectedDay(d)}
                                    className={`snap-center px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all transform shadow-sm active:scale-95
                                        ${selectedDay === d 
                                            ? (d >= 5 && d <= 6 ? 'bg-jp-blue text-white' : 'bg-jp-green text-white') 
                                            : 'bg-white/70 text-gray-500 hover:bg-white'}
                                    `}
                                >
                                    Day {d}
                                </button>
                            ))}
                        </div>

                        {/* è¡Œç¨‹åˆ—è¡¨ */}
                        <div>
                            {filteredItems.map((item, idx) => (
                                <ItineraryCard key={item.id} item={item} isSnowDay={isSnowDay} index={idx} />
                            ))}
                            {filteredItems.length === 0 && <div className="text-center text-gray-400 py-10">å°šç„¡è¡Œç¨‹</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- è¦–åœ–ï¼šåˆ†å¸³ (ç°¡åŒ–) ---
        const ExpenseView = ({ expenses, users }) => (
            <div className="p-5 h-full relative z-10 animate-fade-in overflow-y-auto pb-24">
                <h1 className="text-2xl font-bold text-jp-ink mb-6">æ—…è²»æ‰‹å¸³ ğŸ’°</h1>
                
                <div className="bg-gradient-to-r from-jp-yellow to-yellow-600 text-white p-5 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                    <div className="absolute right-0 top-0 opacity-10 transform rotate-12 -mr-4 -mt-4">
                        <Icon name="TrendingUp" size={100} color="white" />
                    </div>
                    <div className="text-sm opacity-90">é ä¼°åŒ¯ç‡</div>
                    <div className="text-3xl font-bold font-mono mt-1">0.223</div>
                    <div className="mt-2 text-xs opacity-80">1000 å†† â‰ˆ 223 å°å¹£</div>
                </div>

                <div className="space-y-4">
                    {expenses.map((exp, idx) => (
                        <div key={exp.id} className="bg-white/90 p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-jp-yellow stagger-item" style={{ animationDelay: `${idx * 0.05}s` }}>
                            <div>
                                <div className="font-bold text-gray-800">{exp.title}</div>
                                <div className="text-xs text-gray-500 flex items-center mt-1">
                                    <Icon name="User" size={12} className="mr-1" /> {exp.payer} å…ˆä»˜
                                </div>
                            </div>
                            <div className="font-mono font-bold text-lg text-gold">Â¥{exp.amount.toLocaleString()}</div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- è¦–åœ–ï¼šåœ°åœ– (ç°¡åŒ–) ---
        const MapView = ({ items }) => (
            <div className="p-5 h-full relative z-10 animate-fade-in overflow-y-auto pb-24">
                <h1 className="text-2xl font-bold text-jp-ink mb-6">æ™¯é»åœ°åœ– ğŸ—ºï¸</h1>
                <div className="grid gap-3">
                    {items.filter(i => i.location).map((item, idx) => (
                        <div key={item.id} className="bg-white/80 backdrop-blur-md p-4 rounded-xl shadow-sm flex items-center gap-3 stagger-item active:scale-98 transition-transform"
                             style={{ animationDelay: `${idx * 0.05}s` }}
                             onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')}>
                            <div className="bg-blue-100 p-2 rounded-full text-jp-blue">
                                <Icon name="MapPin" size={18} />
                            </div>
                            <div>
                                <div className="text-sm font-bold text-gray-700">{item.location}</div>
                                <div className="text-xs text-gray-400">Day {item.day}</div>
                            </div>
                            <div className="ml-auto text-gray-300">
                                <Icon name="ChevronRight" size={18} />
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- åº•éƒ¨å°èˆª ---
        const TabBar = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'itinerary', label: 'è¡Œç¨‹', icon: 'Calendar', color: 'text-jp-green' },
                { id: 'map', label: 'åœ°åœ–', icon: 'MapPin', color: 'text-jp-blue' },
                { id: 'expenses', label: 'åˆ†å¸³', icon: 'Wallet', color: 'text-jp-yellow' },
            ];

            return (
                <div className="tab-bar-glass fixed bottom-0 left-0 right-0 pb-safe-bottom pt-3 px-8 flex justify-between z-50 rounded-t-2xl">
                    {tabs.map(tab => (
                        <button 
                            key={tab.id} 
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex flex-col items-center w-16 transition-all duration-300 active:scale-90 ${activeTab === tab.id ? `${tab.color} -translate-y-1` : 'text-gray-400'}`}
                        >
                            <Icon name={tab.icon} size={24} className={activeTab === tab.id ? "stroke-2" : "stroke-1"} />
                            <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        // --- App Entry ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [itineraryItems] = useStickyState(defaultItinerary, 'jp_trip_2025_v3');
            const [expenses] = useStickyState(defaultExpenses, 'jp_trip_2025_expenses');
            const [users] = useStickyState(defaultUsers, 'jp_trip_2025_users');

            const renderContent = () => {
                switch(activeTab) {
                    case 'itinerary': return <ItineraryView items={itineraryItems} />;
                    case 'expenses': return <ExpenseView expenses={expenses} users={users} />;
                    case 'map': return <MapView items={itineraryItems} />;
                    default: return <ItineraryView items={itineraryItems} />;
                }
            };

            return (
                <div id="app-container">
                    {renderContent()}
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>